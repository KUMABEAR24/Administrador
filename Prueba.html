<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador DNGET - Coomeva (Versión Debug)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* ESTILOS DE ALTO CONTRASTE */
        body { background-color: #0b1120; color: #e2e8f0; font-family: sans-serif; }
        
        .card { background-color: #1e293b; border: 1px solid #475569; margin-bottom: 20px; }
        .card-header { background-color: #004481; color: white; font-weight: bold; }
        
        /* INPUTS BLANCOS (Corrección solicitada) */
        .form-control, .form-select { 
            background-color: #334155 !important; 
            border: 1px solid #64748b !important; 
            color: #ffffff !important; 
            font-weight: 500;
        }
        .form-control::placeholder { color: #cbd5e1 !important; opacity: 0.7; }
        .form-control:focus { border-color: #38bdf8 !important; box-shadow: 0 0 0 0.2rem rgba(56, 189, 248, 0.25); }

        /* Botones */
        .btn-primary { background-color: #0ea5e9; border: none; color: white; font-weight: bold; }
        .btn-primary:hover { background-color: #0284c7; }

        /* Vista Previa */
        #previewContainer {
            background-color: white; color: black; padding: 20mm; min-height: 297mm;
            font-family: Arial, sans-serif; font-size: 11pt; border-radius: 4px;
        }
        
        /* Tabla Carta */
        .carta-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 10pt; }
        .carta-table th, .carta-table td { border: 1px solid black; padding: 5px; text-align: left; vertical-align: top; }
        .carta-table th { background-color: #f0f0f0; text-align: center; }

        /* CONSOLA DE DEBUG (Para ver errores) */
        #debugConsole {
            background-color: #000; color: #00ff00; font-family: 'Courier New', monospace;
            padding: 15px; border-radius: 5px; height: 150px; overflow-y: scroll;
            font-size: 0.8rem; border: 1px solid #00ff00; display: none; margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row">
        <div class="col-lg-4">
            <h4 class="text-white mb-3">Auditoría IA <span class="badge bg-warning text-dark">Debug Mode</span></h4>

            <div class="card">
                <div class="card-header p-2">1. Configuración</div>
                <div class="card-body p-3">
                    <label class="text-white small">API Key:</label>
                    <input type="password" id="apiKey" class="form-control mb-2" placeholder="Pega la Key aquí">
                    
                    <label class="text-white small">Modelo:</label>
                    <select id="modelSelector" class="form-select">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Recomendado)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Experimental</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-header p-2">2. Archivos (Orden/HC)</div>
                <div class="card-body p-3 text-center">
                    <input type="file" id="fileInput" class="form-control mb-2" multiple accept="application/pdf, image/png, image/jpeg, image/webp">
                    <small class="text-info" id="fileStatus">Ningun archivo seleccionado</small>
                </div>
            </div>

            <div class="card">
                <div class="card-header p-2">3. Datos Manuales</div>
                <div class="card-body p-3">
                    <select id="intencion" class="form-select mb-2">
                        <option value="cotizar">Cotizar</option>
                        <option value="modificar">Modificar Tarifa</option>
                        <option value="cobertura">Validar Cobertura</option>
                    </select>

                    <input type="text" id="documento" class="form-control mb-2" placeholder="CC Documento">
                    <input type="text" id="nombre" class="form-control mb-2" placeholder="Nombre Paciente">
                    <input type="text" id="prestador" class="form-control mb-2" placeholder="Prestador (IPS)">
                    
                    <div class="row g-1">
                        <div class="col-6"><input type="text" id="valorPresmed" class="form-control" placeholder="$ Presmed"></div>
                        <div class="col-6"><input type="text" id="valorOferta" class="form-control" placeholder="$ Oferta"></div>
                    </div>

                    <button onclick="ejecutarIA()" class="btn btn-primary w-100 mt-3 py-2">
                        <i class="fas fa-play"></i> GENERAR CARTA
                    </button>
                </div>
            </div>
            
            <div id="debugConsole">Esperando acciones...</div>
        </div>

        <div class="col-lg-8">
            <div class="d-flex justify-content-between mb-2">
                <h5 class="text-white">Vista Previa</h5>
                <button onclick="descargarPDF()" class="btn btn-success btn-sm">Descargar PDF</button>
            </div>
            <div id="previewContainer">
                <div style="text-align: center; padding-top: 100px; color: #999;">
                    La carta aparecerá aquí.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SISTEMA DE LOGS ---
    const consoleBox = document.getElementById('debugConsole');
    function log(msg, type="info") {
        consoleBox.style.display = 'block';
        const color = type === 'error' ? 'red' : '#00ff00';
        const time = new Date().toLocaleTimeString();
        consoleBox.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
        consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    // --- CONVERSOR DE ARCHIVOS ---
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                // Quitamos la cabecera "data:image/png;base64," para enviar solo los datos
                const base64String = reader.result.split(',')[1];
                resolve({
                    mime_type: file.type,
                    data: base64String
                });
            };
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // --- PROCESO PRINCIPAL ---
    async function ejecutarIA() {
        // Limpiar consola
        consoleBox.innerHTML = '<div style="color:yellow">--- NUEVA SOLICITUD ---</div>';
        
        // 1. Validar Datos
        const apiKey = document.getElementById('apiKey').value.trim();
        const modelId = document.getElementById('modelSelector').value;
        const files = document.getElementById('fileInput').files;

        if (!apiKey) { log("ERROR: Falta la API Key", "error"); alert("Pon la API Key"); return; }
        if (files.length === 0) { log("ERROR: No hay archivos", "error"); alert("Sube un PDF o Imagen"); return; }

        log(`Iniciando proceso con modelo: ${modelId}`);
        log(`Procesando ${files.length} archivo(s)...`);

        try {
            // 2. Convertir Archivos
            const mediaParts = [];
            for (const file of files) {
                log(`Leyendo: ${file.name} (${file.type})`);
                const fileData = await fileToBase64(file);
                mediaParts.push({
                    inline_data: {
                        mime_type: fileData.mime_type,
                        data: fileData.data
                    }
                });
            }
            log("Archivos convertidos a Base64 correctamente.");

            // 3. Preparar Prompt
            const datos = {
                intencion: document.getElementById('intencion').value,
                doc: document.getElementById('documento').value,
                nombre: document.getElementById('nombre').value.toUpperCase(),
                prestador: document.getElementById('prestador').value.toUpperCase(),
                presmed: document.getElementById('valorPresmed').value,
                oferta: document.getElementById('valorOferta').value
            };

            log("Construyendo instrucciones para la IA...");
            
            let instruccionIntencion = "";
            let tarifaColumna = "COTIZAR";
            
            if (datos.intencion === 'modificar') {
                instruccionIntencion = `<li>Solicito Visto Bueno para solicitar cambio de valor en presmed (${datos.presmed}) según oferta mercantil (${datos.oferta}).</li>`;
                tarifaColumna = `SEGUN OFERTA: ${datos.oferta}`;
            } else if (datos.intencion === 'cotizar') {
                instruccionIntencion = `<li>Agradezco cotizar el procedimiento e insumos relacionados.</li>`;
            } else {
                instruccionIntencion = `<li>Agradezco validar si el procedimiento es cobertura del programa.</li>`;
            }

            const prompt = `
                Actúa como auditor médico de Coomeva. 
                DATOS MANUALES: Paciente ${datos.nombre} - ${datos.doc}, Prestador: ${datos.prestador}.
                
                TAREA:
                1. Mira los archivos adjuntos (Historia clínica/Orden).
                2. Encuentra el PROCEDIMIENTO y DIAGNÓSTICO.
                3. BUSCA INSUMOS: Busca referencias como "b10p002", stents, catéteres.
                
                SALIDA HTML (Solo body):
                <div style="font-family: Arial, sans-serif;">
                    <p>Buenos días Dres.,<br>Agradezco validar caso de: <strong>${datos.nombre} - ${datos.doc}</strong>.</p>
                    <p>Especialista solicita: [Resumen de lo encontrado en el archivo]</p>
                    <ul>${instruccionIntencion}</ul>
                    <table class="carta-table">
                        <thead><tr><th>SERVICIO/ITEMS</th><th>CUPS</th><th>TARIFA</th><th>PRESTADOR</th></tr></thead>
                        <tbody>
                            <tr>
                                <td>[Procedimiento encontrado + Insumos (b10p002, etc)]</td>
                                <td>[Código CUPS]</td>
                                <td>${tarifaColumna}</td>
                                <td>${datos.prestador}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p><strong>DX:</strong> [Diagnóstico encontrado]</p>
                    <p>Cordialmente,<br><strong>Auditoría Médica</strong><br>Coomeva MP</p>
                </div>
            `;

            // 4. Enviar a Gemini (Fetch Manual para control total)
            log("Conectando con Google Cloud...");
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        ...mediaParts
                    ]
                }]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            log(`Respuesta del servidor: ${response.status}`);

            if (!response.ok) {
                const errData = await response.json();
                const errMsg = errData.error?.message || "Error desconocido";
                log(`FALLO API: ${errMsg}`, "error");
                alert(`Error de Gemini:\n${errMsg}`);
                return;
            }

            const result = await response.json();
            log("Datos recibidos. Renderizando...");
            
            let htmlFinal = result.candidates[0].content.parts[0].text;
            htmlFinal = htmlFinal.replace(/```html/g, '').replace(/```/g, ''); // Limpiar formato

            document.getElementById('previewContainer').innerHTML = htmlFinal;
            log("¡EXITO! Carta generada.", "success");

        } catch (e) {
            log(`ERROR CRÍTICO: ${e.message}`, "error");
            console.error(e);
            alert("Ocurrió un error técnico. Revisa la consola negra abajo.");
        }
    }

    function descargarPDF() {
        const elemento = document.getElementById('previewContainer');
        const docName = document.getElementById('documento').value || "archivo";
        const opt = {
            margin: 10,
            filename: `DNGET-${docName}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(elemento).save();
    }
    
    // Feedback visual al subir archivo
    document.getElementById('fileInput').addEventListener('change', function() {
        document.getElementById('fileStatus').innerText = this.files.length + " archivo(s) listo(s) para análisis";
        document.getElementById('fileStatus').className = "text-success fw-bold";
    });
</script>

</body>
</html>
