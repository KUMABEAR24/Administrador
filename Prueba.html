<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com https://esm.sh; script-src 'self' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com https://esm.sh; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
          
    <title>GESTION NEGACIONES EJE CAFETERO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      // Tailwind CSS Configuration
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4e9fef',
              'background': '#1e1e1e',
              'surface': '#2d2d2d',
              'text-primary': '#d4d4d4',
              'text-secondary': '#a0a0a0',
              'border-color': '#444',
              'header': '#3a3a3a',
              'highlight': '#252526',
              'warning': '#6e550c', // Adjusted yellow for better contrast potentially
              'archive': '#3a3a3a',
              'success': '#28a745',
              'danger': '#a02d2d',
              'danger-hover': '#c0392b',
              'btn-primary': '#0e639c',
              'btn-primary-hover': '#1a73e8',
            },
            animation: {
              'flash-success': 'flash-success 1s ease-out',
            },
            keyframes: {
              'flash-success': {
                'from': { backgroundColor: '#28a745' },
                'to': { backgroundColor: 'transparent' },
              }
            }
          }
        }
      }
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-background text-text-primary">
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
        // React application code starts here
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';

        // =================================================================================
        // INLINED: constants.ts
        // =================================================================================
        const PORTAL_HEADERS = [
            "Fecha_Neg", "Sucursal", "No_Orden", "No_Cedula", "Nombre", "Entidad_Ejecutora",
            "Motivo_Negacion", "Usuario_Emitio", "Auditor", "Observacion_Auditor", "Observacion_Ejecutivo",
            "Programa", "Plan", "Antiguedad", "EPS", "Telefono", "Celular", "Direccion", "Email", "Edad",
            "Tipo_Usuario", "Llamada", "Complementariedad", "Notificacion", "Gestion_Negacion", "Alternativa",
            "Observacion_Alternativa", "Monto", "Nit_Prestador", "Fecha_Complementariedad", "Tiempo_de_Gestion", "Regional"
        ];

        const PDF_HEADERS = [
          "Archivo (No. Orden)", "Descripci√≥n", "Justificaci√≥n", "Fundamento Legal", "C√≥digo"
        ];

        const TRACKING_STATUSES = ['Pendiente', 'En Gesti√≥n', 'Finalizado'];

        const COMMON_EMAIL_BODY = `<br><br><b>Si tiene alguna duda puede contactarse por medio de los canales que tenemos disponibles para usted:</b><br>¬∑ Nuestra l√≠nea nacional 018000931666. O con nuestras l√≠neas locales: Cali (602) 489 0073, Bogot√° (601) 743 5485, Medell√≠n (604) 604 4507, Barranquilla (605) 385 3165, Bucaramanga (607) 697 3350, Cartagena (605) 693 9853, Tulu√° (602) 235 9483, Valledupar (605)588 5699, Pereira (606) 340 2635.<br>¬∑ WhatsApp: 317-224-07-94<br><br>Gracias por su Atenci√≥n.`;
        const SIGNATURE = `<br><br>Cordialmente,<br><br><b>Juan Ricardo Morales Agudelo</b><br>Ejecutivo De Atenci√≥n Integral<br>Coomeva Medicina Prepagada<br>Cra. 13 No.11-12 Centro M√©dico Circunvalar<br>Coomeva Medicina Prepagada Pereira, Risaralda<br><br><i>Este correo es generado autom√°ticamente, por favor no responda este mensaje.</i>`;

        const defaultTemplates = [
            { id: 'tpl_neg_gen', name: 'PLANTILLA NEGACION GENERAL', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad no est√° aprobado debido a que corresponde a EXCLUSI√ìN ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El servicio negado anteriormente; debe tramitarlo a trav√©s su EPS asignada. Adjuntamos soporte de la carta de negaci√≥n.` },
            { id: 'tpl_neg_pert', name: 'PLANTILLA NO PERTINENCIA Y TEMAS ESTETICOS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad No est√° aprobado debido a que corresponde a NO PERTINENCIA ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>` },
            { id: 'tpl_comp_coinc', name: 'COMPLEMENTARIEDAD RED COINCIDENTE', body: `Apreciado Usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y el de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no fue aprobado, debido a que ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, est√° en gesti√≥n a trav√©s de su EPS ({{EPS}}) con el n√∫mero de radicado ({{Radicado_Comp}}), puede realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).<br><br>Adicional estaremos haciendo seguimiento al radicado y una vez se encuentre gestionado por la EPS, le notificaremos por medio de correo electr√≥nico.` },
            { id: 'tpl_comp_no_coinc', name: 'COMPLEMENTARIEDAD RED NO COINCIDENTE', body: `Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado, debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El prestador actual solicitado, no tiene convenio con la EPS, por lo que los costos adicionales del servicio o insumo estar√°n a cargo del paciente. Sin embargo; se radica la solicitud ante su EPS con el n√∫mero ({{Radicado_Comp}}) por favor realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).` },
            { id: 'tpl_comp_ayudas', name: 'COMPLEMENTARIEDAD AYUDAS DIAGNOSTICAS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, se encuentra en gesti√≥n a trav√©s de su EPS con el n√∫mero de radicado ({{Radicado_Comp}}), por favor realizar seguimiento mediante la oficina virtual. ({{Oficina_Virtual_EPS}}).` },
        ];


        // =================================================================================
        // INLINED: services/utilityService.ts
        // =================================================================================
        const capitalizeWords = (str) => {
          if (!str) return '';
          return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        };

        const processPastedData = (pastedText, headers) => {
          if (!pastedText || typeof pastedText !== 'string') return []; // Handle empty/invalid input
          return pastedText
            .trim()
            .split(/\r?\n/) // Handles both Windows and Unix line endings
            .map(rowText => {
              const cells = rowText.split('\t'); // Split by tab for Excel paste
              const rowObject = {};
              headers.forEach((header, index) => {
                rowObject[header] = cells[index] ? cells[index].trim() : ''; // Default to empty string
              });
              return rowObject;
            });
        };

        const replacePlaceholders = (templateBody, data) => {
          const getOficinaVirtual = (eps) => {
            const e = (eps || "").toUpperCase();
            if (e.includes("NUEVA EPS")) return `<a href='https://portal.nuevaeps.com.co/Portal/home.jspx' target='_blank' rel='noopener noreferrer'>NUEVA EPS</a>`;
            if (e.includes("SALUD TOTAL")) return `<a href='https://saludtotal.com.co/' target='_blank' rel='noopener noreferrer'>SALUD TOTAL</a>`;
            return eps; // Return original EPS name if no specific link
          };
           // Ensure data is an object
          const safeData = (typeof data === 'object' && data !== null) ? data : {};
          const fullData = { ...safeData, Oficina_Virtual_EPS: getOficinaVirtual(safeData.EPS) };

          // Replace placeholders, default to placeholder text if key not found in fullData
          return templateBody.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return fullData.hasOwnProperty(key) && fullData[key] !== null && fullData[key] !== undefined
              ? String(fullData[key]) // Convert value to string
              : `{{${key}}}`; // Return the placeholder itself if not found
          });
        };

        const exportDetailedReport = (finalData, trackingData, archivedData) => {
          try {
            const masterDataMap = new Map();
            // Ensure data inputs are arrays before spreading
            const safeFinalData = Array.isArray(finalData) ? finalData : [];
            const safeTrackingData = Array.isArray(trackingData) ? trackingData : [];
            const safeArchivedData = Array.isArray(archivedData) ? archivedData : [];

            // Combine all data, ensuring rows and No_Orden exist
            [...safeFinalData, ...safeTrackingData, ...safeArchivedData].forEach(row => {
              if (row && row.No_Orden) {
                const key = String(row.No_Orden).trim();
                if (key) { // Ensure key is not empty
                    const existing = masterDataMap.get(key) || {};
                    masterDataMap.set(key, { ...existing, ...row }); // Merge, potentially overwriting older data with newer if key exists
                }
              }
            });

            const masterData = Array.from(masterDataMap.values());

            if (masterData.length === 0) {
              alert("No hay datos consolidados para exportar.");
              return;
            }

            const wb = XLSX.utils.book_new();

            // Function to add sheet safely
            const addSheet = (workbook, data, sheetName) => {
                if (Array.isArray(data) && data.length > 0) {
                    try {
                        const ws = XLSX.utils.json_to_sheet(data);
                        XLSX.utils.book_append_sheet(workbook, ws, sheetName);
                    } catch (sheetError){
                         console.error(`Error creating sheet "${sheetName}":`, sheetError);
                         alert(`Ocurri√≥ un error al generar la hoja "${sheetName}".`);
                    }
                }
            };

            addSheet(wb, safeFinalData, "Casos en Revisi√≥n");
            addSheet(wb, safeTrackingData, "Seguimiento Activo");
            addSheet(wb, safeArchivedData, "Seguimiento Archivado");
            addSheet(wb, masterData, "Maestro Consolidado"); // Always add if masterData exists

            // Generate filename with current date
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `Sigweb_Reporte_Detallado_${dateStr}.xlsx`);
          } catch (error) {
            console.error("Fall√≥ la exportaci√≥n del reporte Excel detallado:", error);
            alert("Ocurri√≥ un error general al generar el reporte detallado.");
          }
        };

        // =================================================================================
        // INLINED: services/templateService.ts
        // =================================================================================
        const TEMPLATE_STORAGE_KEY = 'sigweb_emailTemplates';

        const loadTemplates = () => {
          try {
            const storedTemplates = localStorage.getItem(TEMPLATE_STORAGE_KEY);
            if (storedTemplates) {
              const parsed = JSON.parse(storedTemplates);
              if (Array.isArray(parsed) && parsed.every(t => t && typeof t.id === 'string' && typeof t.name === 'string' && typeof t.body === 'string')) {
                 return parsed;
              } else {
                 console.warn("Stored template data is corrupted. Using defaults.");
                 localStorage.removeItem(TEMPLATE_STORAGE_KEY);
              }
            }
          } catch (error) {
            console.error("Fall√≥ la carga de plantillas desde localStorage:", error);
            localStorage.removeItem(TEMPLATE_STORAGE_KEY);
          }
          console.log("Using default templates.");
          return JSON.parse(JSON.stringify(defaultTemplates)); // Return a deep copy
        };

        const saveTemplates = (templates) => {
           if (!Array.isArray(templates) || !templates.every(t => t && typeof t.id === 'string' && typeof t.name === 'string' && typeof t.body === 'string')) {
                console.error("Attempted to save invalid template data to localStorage. Data:", templates);
                alert("Error: No se pudieron guardar las plantillas, los datos son inv√°lidos.");
                return;
           }
          try {
            localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
            console.log("Templates saved to localStorage.");
          } catch (error) {
             console.error("Fall√≥ el guardado de plantillas en localStorage:", error);
             alert(`Error al guardar plantillas: ${error.message}`);
          }
        };


        // =================================================================================
        // INLINED: services/googleSheetService.ts
        // =================================================================================
        const fetchData = async (url) => {
            console.log("Fetching data from:", url);
             const fetchUrl = `${url}?action=getData&cacheBust=${Date.now()}`; // Add cache buster
            try {
                const response = await fetch(fetchUrl);
                console.log("Fetch response status:", response.status);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Network response was not ok:", response.status, errorText);
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }
                const data = await response.json();
                console.log("Fetched data successfully:", data);
                // Ensure arrays and map orders to strings
                return {
                    finalData: Array.isArray(data.finalData) ? data.finalData : [],
                    trackingData: Array.isArray(data.trackingData) ? data.trackingData : [],
                    archivedData: Array.isArray(data.archivedData) ? data.archivedData : [],
                    masterTrackingOrders: Array.isArray(data.masterTrackingOrders) ? data.masterTrackingOrders.map(String) : [],
                };
             } catch (error) {
                console.error("Fetch data error:", error);
                 // Check if the error is due to JSON parsing, provide specific message
                 if (error instanceof SyntaxError) {
                     throw new Error("La respuesta del servidor no es un JSON v√°lido. Revisa el script de Google Apps.");
                 }
                throw error; // Re-throw other errors
             }
        };

        const saveData = async (url, requestBody) => {
            console.log("Saving data to:", url);
            const bodyString = JSON.stringify(requestBody);
            console.log("Save request body (as text string):", bodyString);
            try {
                // Apps Script web apps accessed via POST often require text/plain content type,
                // even if the content is stringified JSON. no-cors prevents reading the response.
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                    body: bodyString,
                });
                console.log("Save request sent via no-cors. Assume success.");
                return { status: 'success', message: 'Datos enviados (no-cors).' };
            } catch (error) {
                console.error("Error during save fetch request:", error);
                throw new Error(`Error de red al guardar: ${error.message}`);
            }
        };


        // =================================================================================
        // INLINED: components/Spinner.tsx
        // =================================================================================
        const Spinner = () => (
          <div
            className="inline-block h-6 w-6 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]"
            role="status"
          >
            <span className="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">
              Cargando...
            </span>
          </div>
        );


        // =================================================================================
        // INLINED: components/Notification.tsx
        // =================================================================================
         const Notification = ({ message, type = 'info', onClose }) => {
            const typeClasses = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-500 text-black', // Darker text for warning
                info: 'bg-blue-600',
            };
            const [isVisible, setIsVisible] = useState(true);
            const timeoutRef = React.useRef(null); // Ref to store timeout ID

            const handleClose = useCallback(() => {
                setIsVisible(false);
                // Allow time for fade-out before calling onClose
                setTimeout(() => {
                    if (onClose) onClose();
                }, 300); // Match transition duration
            }, [onClose]);

            useEffect(() => {
                if (onClose) {
                     // Clear previous timeout if component re-renders with new message/type
                     if(timeoutRef.current) clearTimeout(timeoutRef.current);
                     // Set new timeout
                    timeoutRef.current = setTimeout(handleClose, 5000); // 5 seconds
                    
                    // Cleanup function to clear timeout if component unmounts or onClose changes
                    return () => {
                         if(timeoutRef.current) clearTimeout(timeoutRef.current);
                     };
                }
            }, [message, type, onClose, handleClose]); // Re-run effect if message/type/onClose changes

            return (
                <div className={`fixed top-5 right-5 z-[100] p-4 rounded-lg shadow-lg text-white ${typeClasses[type]} flex items-center gap-4 transition-opacity duration-300 ease-out ${isVisible ? 'opacity-100' : 'opacity-0'}`}>
                    <span>{message}</span>
                    {onClose && <button onClick={handleClose} className="text-xl font-bold leading-none hover:opacity-75">&times;</button>}
                </div>
            );
        };

        // =================================================================================
        // INLINED: components/Header.tsx
        // =================================================================================
        const Header = ({ onSave, onManageTemplates, onReconfigure, isSaving }) => {
            return (
                <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-border-color">
                    <div>
                        <h1 className="text-3xl font-bold text-white">GESTION NEGACIONES EJE CAFETERO</h1>
                        <p className="text-text-secondary">Sistema Integrado de Gesti√≥n</p>
                    </div>
                    <div className="flex flex-wrap gap-2">
                        <button onClick={onManageTemplates} disabled={isSaving} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Plantillas
                        </button>
                        <button onClick={onReconfigure} disabled={isSaving} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8.21 5.15a1.5 1.5 0 01-1.25.82l-2.09.28c-1.68.23-2.34 2.26-1.09 3.42l1.52 1.48a1.5 1.5 0 01-.42 2.1l-1.83 1.25c-1.38.94-.92 3.01.7 3.42l2.05.51a1.5 1.5 0 011.1.98l.8 2.07c.43 1.12 2.29 1.12 2.72 0l.8-2.07a1.5 1.5 0 011.1-.98l2.05-.51c1.62-.4 2.08-2.48.7-3.42l-1.83-1.25a1.5 1.5 0 01-.42-2.1l1.52-1.48c1.25-1.16.59-3.19-1.09-3.42L13 5.97a1.5 1.5 0 01-1.25-.82l-.3-1.98zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" /></svg>
                            Configurar
                        </button>
                        <button onClick={onSave} disabled={isSaving} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed min-w-[140px] justify-center"> {/* Added min-width */}
                            {isSaving ? <Spinner /> : <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16.5a2.5 2.5 0 01-5 0V4.414a1.5 1.5 0 01.44-1.06L4.354.439A1.5 1.5 0 015.414 0H12.5a2.5 2.5 0 012.5 2.5v2" /><path d="M5.5 16.5h8a2.5 2.5 0 002.5-2.5V8.5h-13v5.5a2.5 2.5 0 002.5 2.5z" /><path d="M10.5 10a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" /></svg>}
                            {isSaving ? 'Guardando...' : 'Guardar Nube'}
                        </button>
                    </div>
                </header>
            );
        };


        // =================================================================================
        // INLINED: components/Dashboard.tsx
        // =================================================================================
        const DashboardCard = ({ title, value = 0, icon }) => (
          <div className="bg-surface p-4 rounded-lg border border-border-color flex items-center min-w-[200px]">
            <div className="text-3xl text-primary mr-4">{icon}</div>
            <div>
              <h4 className="text-sm font-semibold text-text-secondary uppercase tracking-wider">{title}</h4>
              <p className="text-2xl font-bold text-text-primary">{typeof value === 'number' ? value : 0}</p>
            </div>
          </div>
        );

        const Dashboard = ({ reviewCount = 0, trackingCount = 0, archivedCount = 0, editsCount = 0 }) => (
          <section id="dashboard" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <DashboardCard title="Casos en Revisi√≥n" value={reviewCount} icon={'üìã'} />
            <DashboardCard title="Seguimiento Activo" value={trackingCount} icon={'‚è≥'} />
            <DashboardCard title="Casos Archivados" value={archivedCount} icon={'üóÑÔ∏è'} />
            <DashboardCard title="Ediciones Pendientes" value={editsCount} icon={'‚úèÔ∏è'} />
          </section>
        );


        // =================================================================================
        // INLINED: components/DataInputArea.tsx - Includes all corrections and improvements
        // =================================================================================
        function DataInputArea({ id, title, headers, data, onDataChange, onProcess, processButtonText = "Procesar Datos", inputType = "paste", }) {

            const handlePaste = useCallback((e) => {
                 if(inputType !== 'paste') return;
                 e.preventDefault();
                 const pastedText = e.clipboardData.getData('text/plain');
                 if (!pastedText) return;
                 const newRows = processPastedData(pastedText, headers); // Util function defined earlier

                 // Ensure data is always an array before filtering
                 const currentData = Array.isArray(data) ? data : [];
                 // Filter out completely empty rows before adding new ones
                 const existingNonEmpty = currentData.filter(row => row && Object.values(row).some(val => String(val).trim() !== ''));
                 let updatedData = [...existingNonEmpty, ...newRows];

                 // Add 5 empty rows if needed for paste area
                 const emptyRowCount = updatedData.filter(row => !row || !Object.values(row).some(val => String(val).trim() !== '')).length;
                 const requiredEmptyRows = 5;
                 if (emptyRowCount < requiredEmptyRows) {
                    for (let i = 0; i < (requiredEmptyRows - emptyRowCount); i++) {
                        updatedData.push({}); // Add empty object for a new row
                    }
                 }
                 onDataChange(updatedData);
            }, [data, headers, onDataChange, inputType]); // Include inputType dependency

            const handleCellChange = (rowIndex, header, value) => {
                 if(inputType !== 'paste') return;
                // Ensure data is always an array
                const currentData = Array.isArray(data) ? data : [];
                const newData = [...currentData];
                // Ensure the row exists before trying to update it
                if(newData[rowIndex]){
                    newData[rowIndex] = { ...newData[rowIndex], [header]: value };
                } else {
                     console.warn(`Attempted to edit non-existent row at index ${rowIndex}`);
                     return;
                }

                 // Add empty row if needed
                 const emptyRowCount = newData.filter(row => !row || !Object.values(row).some(val => String(val).trim() !== '')).length;
                 if (emptyRowCount < 5) {
                    newData.push({});
                }

                onDataChange(newData);
            };

            const handleFileChange = (e) => {
                 if(inputType !== 'file') return;
                  const file = e.target.files[0];
                  if (!file) return;
                   console.log("Processing file:", file.name);

                  const reader = new FileReader();
                  reader.onload = (event) => {
                      try {
                          const fileData = new Uint8Array(event.target.result);
                          const workbook = XLSX.read(fileData, { type: 'array', cellDates: true, dateNF:'yyyy-mm-dd' }); // Attempt to parse dates directly
                          const sheetName = workbook.SheetNames[0];
                          const worksheet = workbook.Sheets[sheetName];
                          const jsonDataObjects = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: '' }); // Use raw:false

                          if (jsonDataObjects.length === 0) {
                              alert("El archivo Excel parece estar vac√≠o.");
                              onDataChange([]); // Clear data if file is empty
                              return;
                          }
                          console.log("Raw JSON data from SheetJS:", jsonDataObjects);

                          const keyMap = { // Define keyMap inside where it's used
                              'Fecha Neg.': 'Fecha_Neg', 'No. Orden': 'No_Orden', 'No. C√©dula': 'No_Cedula',
                              'Entidad Ejecutora': 'Entidad_Ejecutora', 'Motivo Negaci√≥n': 'Motivo_Negacion',
                              'Usuario Emiti√≥': 'Usuario_Emitio', 'Observaci√≥n Auditor': 'Observacion_Auditor',
                              'Observaci√≥n Ejecutivo': 'Observacion_Ejecutivo', 'Antig√ºedad': 'Antiguedad',
                              'Tel√©fono': 'Telefono', 'Direcci√≥n': 'Direccion', 'Tipo Usuario': 'Tipo_Usuario',
                              'Notificaci√≥n': 'Notificacion', 'Gesti√≥n': 'Gestion_Negacion',
                              'Observaci√≥n Alternativa': 'Observacion_Alternativa', 'Nit Prestador': 'Nit_Prestador',
                              'Fecha Complementariedad': 'Fecha_Complementariedad', 'Tiempo de Gestion': 'Tiempo_de_Gestion'
                              // Add mappings for ALL headers defined in PORTAL_HEADERS if they differ in Excel
                          };
                           const dateColumns = ['Fecha_Neg', 'Fecha_Complementariedad']; // Internal keys expected to be dates


                          const normalizedData = jsonDataObjects.map(row => {
                              const newRow = {};
                              // First, map known keys and normalize dates
                              for (const excelKey in row) {
                                  const trimmedKey = String(excelKey).trim();
                                  const internalKey = keyMap[trimmedKey] || trimmedKey.replace(/ /g, '_'); // Normalize or replace spaces

                                  let value = row[excelKey];

                                   // Check if SheetJS parsed it as a Date object OR if it's a known date column needing parsing
                                  if (value instanceof Date) {
                                      // Format Date object to YYYY-MM-DD, adjusting for timezone
                                      const adjustedDate = new Date(value.getTime() + Math.abs(value.getTimezoneOffset()*60000));
                                      newRow[internalKey] = adjustedDate.toISOString().slice(0, 10);
                                  } else if (dateColumns.includes(internalKey) && (typeof value === 'number' || typeof value === 'string')) {
                                       // Attempt to parse Excel serial date or common string formats if SheetJS didn't
                                       try {
                                           const jsDate = XLSX.SSF.parse_date_code(value); // Use SheetJS date parser
                                           if(jsDate) {
                                                // Create date ensuring month is correct (jsDate.m is 1-based)
                                                const dateObj = new Date(jsDate.y, jsDate.m - 1, jsDate.d, jsDate.H || 0, jsDate.M || 0, jsDate.S || 0);
                                                const adjustedDate = new Date(dateObj.getTime() + Math.abs(dateObj.getTimezoneOffset()*60000));
                                                newRow[internalKey] = adjustedDate.toISOString().slice(0, 10);
                                           } else {
                                                newRow[internalKey] = String(value); // Keep original if parsing fails
                                                console.warn(`Could not parse date code for ${internalKey}:`, value);
                                           }
                                       } catch (dateParseError) {
                                           newRow[internalKey] = String(value); // Keep original on error
                                           console.warn(`Error parsing date code for ${internalKey}:`, value, dateParseError);
                                       }
                                  }
                                   else {
                                      // Assign value directly for non-date columns, ensuring it's a string
                                      newRow[internalKey] = value !== null && value !== undefined ? String(value) : '';
                                  }
                              }
                              // Ensure all PORTAL_HEADERS exist in the final object, default to empty string
                              PORTAL_HEADERS.forEach(header => {
                                  if (!(header in newRow)) {
                                      newRow[header] = '';
                                  }
                              });
                              return newRow;
                          });

                          console.log("Normalized data:", normalizedData);
                          onDataChange(normalizedData);
                          e.target.value = null; // Reset file input
                      } catch (error) {
                          console.error("Error processing Excel file:", error);
                          alert("Hubo un error al procesar el archivo Excel. Revisa el formato, las columnas y que no est√© protegido.\nError: " + error.message);
                          onDataChange([]); // Clear data on error
                      }
                  };
                  reader.onerror = (error) => {
                       console.error("Error reading file:", error);
                       alert("Hubo un error al leer el archivo.");
                       onDataChange([]);
                  };
                  reader.readAsArrayBuffer(file);
            };

            const clearTable = () => {
                onDataChange(inputType === 'paste' ? Array(5).fill({}) : []); // Reset based on input type
            };

            // Ensure 'data' is always an array for rendering, provide default structure for paste
            const renderData = Array.isArray(data) ? data : (inputType === 'paste' ? Array(5).fill({}) : []);

            return (
                <section id={id} className="space-y-4">
                    <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">{title}</h2>

                    {inputType === 'file' && (
                        <div className="flex items-center gap-4">
                            <label htmlFor={`${id}-file-upload`} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer">
                                Subir Archivo Excel
                            </label>
                            <input
                                id={`${id}-file-upload`}
                                type="file"
                                className="hidden"
                                accept=".xlsx, .xls" // Standard Excel formats
                                onChange={handleFileChange}
                            />
                            <span className="text-text-secondary">{renderData.length > 0 ? `${renderData.length} fila(s) cargada(s)` : 'Ning√∫n archivo'}</span>
                        </div>
                    )}

                    <div className="table-container max-h-72 overflow-auto border border-border-color rounded-lg">
                        <table className="w-full text-sm text-left text-text-secondary table-fixed">
                            <thead className="text-xs text-text-primary uppercase bg-header sticky top-0 z-10">
                                <tr>
                                    {headers.map(header => (
                                        <th key={header} scope="col" className="px-4 py-3 whitespace-nowrap overflow-hidden text-ellipsis w-40" title={header.replace(/_/g, ' ')}>{header.replace(/_/g, ' ')}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody onPaste={inputType === 'paste' ? handlePaste : undefined}>
                                {renderData.map((row, rowIndex) => (
                                    <tr key={rowIndex} className="border-b border-border-color hover:bg-highlight">
                                        {headers.map(header => (
                                            <td
                                                key={`${rowIndex}-${header}`}
                                                className="px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none whitespace-nowrap overflow-hidden text-ellipsis"
                                                contentEditable={inputType === 'paste'}
                                                onBlur={inputType === 'paste' ? (e) => handleCellChange(rowIndex, header, e.currentTarget.innerText) : undefined}
                                                suppressContentEditableWarning={true}
                                                title={(typeof row === 'object' && row !== null && row[header] !== undefined) ? String(row[header]) : ''}
                                            >
                                                {(typeof row === 'object' && row !== null && row[header] !== undefined) ? String(row[header]) : ''}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                                {renderData.length === 0 && (
                                    <tr>
                                        <td colSpan={headers.length} className="text-center py-4 text-text-secondary italic">
                                            {inputType === 'file' ? 'Sube un archivo.' : 'Pega datos aqu√≠.'}
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                     <div className="flex gap-4">
                         <button
                            onClick={onProcess}
                            // Disable if renderData is empty OR if it's paste mode and all rows are effectively empty
                            disabled={renderData.length === 0 || (inputType === 'paste' && renderData.every(row => !row || !Object.values(row).some(val => String(val).trim() !== '')))}
                            className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {processButtonText}
                        </button>
                        <button onClick={clearTable} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Limpiar
                        </button>
                    </div>
                </section>
            );
        }


        // =================================================================================
        // INLINED: components/ReviewArea.tsx - Includes all corrections and improvements
        // =================================================================================
        const ReviewArea = ({ data, templates, updateRow, incrementEdits, onSendToTracking, onPreview, onExportForMailMerge, onClearReviewData, sortConfig, setSortConfig }) => {
            const [selectedRows, setSelectedRows] = useState(new Set()); // Stores No_Orden strings
            const [filter, setFilter] = useState('');

            const REVIEW_HEADERS = useMemo(() => [ // Use useMemo if headers could potentially change, though unlikely here
                { key: 'Fecha_Neg', label: 'Fecha Neg.' },
                { key: 'No_Orden', label: 'No. Orden' },
                { key: 'No_Cedula', label: 'No. C√©dula' },
                { key: 'Nombre', label: 'Nombre' },
                { key: 'EPS', label: 'EPS' },
                { key: 'Programa', label: 'Programa', compact: true },
                { key: 'Motivo_Negacion', label: 'Motivo Neg.', compact: true },
                { key: 'Descripcion_PDF', label: 'Descripci√≥n', compact: true },
                { key: 'Justificacion_PDF', label: 'Justificaci√≥n', compact: true },
                { key: 'Fundamento_Legal_PDF', label: 'Fund. Legal', compact: true },
            ], []);

            const currentData = useMemo(() => Array.isArray(data) ? data : [], [data]); // Ensure data is always an array

            const filteredData = useMemo(() => {
                if (!filter) return currentData;
                const lowercasedFilter = filter.toLowerCase();
                return currentData.filter(row =>
                    row && typeof row === 'object' &&
                    Object.values(row).some(value =>
                        value !== null && value !== undefined && String(value).toLowerCase().includes(lowercasedFilter)
                    )
                );
            }, [currentData, filter]);

            const handleSelectRow = useCallback((noOrdenKey) => { // Expects string key
                setSelectedRows(prev => {
                    const newSelection = new Set(prev);
                    if (newSelection.has(noOrdenKey)) {
                        newSelection.delete(noOrdenKey);
                    } else {
                        newSelection.add(noOrdenKey);
                    }
                    return newSelection;
                });
            }, []);

            const handleSelectAll = useCallback((e) => {
                if (e.target.checked) {
                    const allOrderKeys = filteredData
                        .map(row => row && row.No_Orden ? String(row.No_Orden) : null)
                        .filter(Boolean); // Filter out null/undefined keys
                    setSelectedRows(new Set(allOrderKeys));
                } else {
                    setSelectedRows(new Set());
                }
            }, [filteredData]); // Recalculate if filteredData changes

            const handleCellBlur = useCallback((noOrdenOriginal, key, value) => { // Receive original No_Orden
                 const keyToFind = String(noOrdenOriginal); // Convert to string for comparison if needed
                 // Find the row using the original value, potentially comparing as strings
                const originalRow = currentData.find(r => r && String(r.No_Orden) === keyToFind);
                // Only update if found and value actually changed
                if (originalRow && String(originalRow[key] || '') !== value) {
                    updateRow(noOrdenOriginal, { [key]: value }); // Pass original No_Orden back
                    // incrementEdits(); // Moved incrementEdits to updateRow definition
                }
            }, [currentData, updateRow /*, incrementEdits - removed */]);

            const handleSelectChange = useCallback((noOrdenOriginal, value) => { // Receive original No_Orden
                const changes = { Tipo_Carta: value };
                const template = templates.find(t => t.id === value);
                 // Reset Radicado_Comp if the selected template is not Complementariedad
                if (!template || !template.name.toUpperCase().includes('COMPLEMENTARIEDAD')) {
                    changes.Radicado_Comp = '';
                }
                updateRow(noOrdenOriginal, changes); // Pass original No_Orden back
            }, [templates, updateRow]);

            const requestSort = useCallback((key) => {
                setSortConfig(current => {
                    const direction = (current.key === key && current.direction === 'ascending') ? 'descending' : 'ascending';
                    return { key, direction };
                });
            }, [setSortConfig]);

            const getSortIndicator = useCallback((key) => {
                if (sortConfig.key !== key) return null;
                return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
            }, [sortConfig]);

            return (
                <section id="area3" className="space-y-4">
                    <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 3: Revisi√≥n Final y Exportaci√≥n ({filteredData.length} Casos)</h2>
                    <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                        <input
                            type="text"
                            placeholder="Buscar en tabla..."
                            className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                            value={filter}
                            onChange={(e) => setFilter(e.target.value)}
                        />
                        <span className="text-text-primary flex-shrink-0">{selectedRows.size} fila(s) seleccionada(s)</span>
                    </div>

                    <div className="table-container max-h-[70vh] overflow-auto border border-border-color rounded-lg"> {/* Increased max-height */}
                        <table className="w-full text-sm text-left text-text-secondary table-fixed"> {/* Use table-fixed */}
                            <thead className="text-xs text-text-primary uppercase bg-header sticky top-0 z-10">
                                <tr>
                                    <th className="px-4 py-3 w-12"><input type="checkbox" onChange={handleSelectAll} checked={filteredData.length > 0 && selectedRows.size === filteredData.length} /></th>
                                    <th className="px-4 py-3 w-12">üëÅÔ∏è</th>
                                    {REVIEW_HEADERS.map(({ key, label, compact }) => (
                                        <th key={key} onClick={() => requestSort(key)} className={`px-4 py-3 cursor-pointer whitespace-nowrap overflow-hidden text-ellipsis ${compact ? 'w-32' : 'w-48'}`} title={`Ordenar por ${label}`}> {/* Added widths & title */}
                                            {label}{getSortIndicator(key)}
                                        </th>
                                    ))}
                                    <th className="px-4 py-3 w-60">Tipo de Carta / Radicado</th> {/* Combined header */}
                                </tr>
                            </thead>
                            <tbody>
                                {filteredData.map((row) => {
                                    if (!row || typeof row !== 'object' || !row.No_Orden) return null; // Skip invalid rows

                                    const noOrdenKey = String(row.No_Orden);
                                    const template = templates.find(t => t.id === row.Tipo_Carta);
                                    const isComplementariedad = template && template.name.toUpperCase().includes('COMPLEMENTARIEDAD');
                                    const requiresRadicado = isComplementariedad;

                                    return (
                                        <tr key={noOrdenKey} className={`border-b border-border-color hover:bg-highlight ${isComplementariedad ? 'bg-indigo-900/30' : ''}`}> {/* Adjusted complementariedad bg */}
                                            <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(noOrdenKey)} onChange={() => handleSelectRow(noOrdenKey)} /></td>
                                            <td className="px-4 py-2 text-lg cursor-pointer text-center" onClick={() => onPreview(row)} title="Vista Previa">üëÅÔ∏è</td>
                                            {REVIEW_HEADERS.map(({ key, compact }) => (
                                                <td key={key}
                                                    className={`px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none whitespace-nowrap overflow-hidden text-ellipsis`}
                                                    contentEditable
                                                    onBlur={(e) => handleCellBlur(row.No_Orden, key, e.currentTarget.innerText)}
                                                    suppressContentEditableWarning={true}
                                                    title={String(row[key] || '')} // Show full content on hover
                                                >
                                                    {String(row[key] || '')}
                                                </td>
                                            ))}
                                            <td className="px-4 py-2">
                                                <div className="flex flex-col gap-1">
                                                    <select
                                                        value={row.Tipo_Carta || ''}
                                                        onChange={(e) => handleSelectChange(row.No_Orden, e.target.value)}
                                                        className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full text-xs" // Smaller text
                                                        title={templates.find(t => t.id === row.Tipo_Carta)?.name || 'Seleccionar tipo'}
                                                    >
                                                        <option value="">-- Seleccionar --</option>
                                                        {templates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                                    </select>
                                                    {requiresRadicado && (
                                                        <input
                                                            type="text"
                                                            placeholder="Radicado EPS..."
                                                            value={row.Radicado_Comp || ''}
                                                            onChange={(e) => updateRow(row.No_Orden, { Radicado_Comp: e.target.value })}
                                                            className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full mt-1 text-xs" // Smaller text
                                                        />
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                                 {filteredData.length === 0 && (
                                    <tr>
                                        <td colSpan={REVIEW_HEADERS.length + 3} className="text-center py-4 text-text-secondary italic">
                                            No hay casos para revisi√≥n (o no coinciden con la b√∫squeda). Procesa datos del √Årea 1.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                     <div className="flex flex-wrap gap-4">
                         <button
                            onClick={() => onSendToTracking(Array.from(selectedRows))}
                            disabled={selectedRows.size === 0}
                            className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Enviar a Seguimiento ({selectedRows.size})
                        </button>
                         <button
                            onClick={() => onExportForMailMerge(currentData)}
                            disabled={currentData.length === 0}
                            className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Exportar p/ Env√≠o Masivo ({currentData.length})
                        </button>
                        <button
                            onClick={onClearReviewData}
                             className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                        >
                            Limpiar Esta Tabla
                        </button>
                    </div>
                </section>
            );
        };


        // =================================================================================
        // INLINED: components/TrackingArea.tsx - Includes all corrections and improvements
        // =================================================================================
        const TrackingTable = ({ data, isArchived, onUpdate, onArchive, filter }) => {
            const [selectedRows, setSelectedRows] = useState(new Set()); // Stores original indices

            const statusClasses = {
                'Pendiente': 'bg-yellow-600/20',
                'En Gesti√≥n': 'bg-blue-600/20',
                'Finalizado': 'bg-green-600/20',
            };

            const currentData = useMemo(() => Array.isArray(data) ? data : [], [data]);

            const filteredData = useMemo(() => {
                if (!filter) return currentData;
                const lowercasedFilter = filter.toLowerCase();
                // Return objects along with their original index
                return currentData
                    .map((row, index) => ({ row, index })) // Map to object with original index
                    .filter(({ row }) =>
                        row && typeof row === 'object' &&
                        Object.values(row).some(value =>
                             value !== null && value !== undefined && String(value).toLowerCase().includes(lowercasedFilter)
                        )
                    );
            }, [currentData, filter]);

            const handleSelectRow = useCallback((originalIndex) => {
                setSelectedRows(prev => {
                    const newSelection = new Set(prev);
                    if (newSelection.has(originalIndex)) {
                        newSelection.delete(originalIndex);
                    } else {
                        newSelection.add(originalIndex);
                    }
                    return newSelection;
                });
            }, []);

            const handleSelectAll = useCallback((e) => {
                if (e.target.checked) {
                     // Get original indices from the filtered data
                    const allOriginalIndices = filteredData.map(({ index }) => index);
                    setSelectedRows(new Set(allOriginalIndices));
                } else {
                    setSelectedRows(new Set());
                }
            }, [filteredData]); // Recalculate if filteredData changes

            const handleBulkArchive = useCallback(() => {
                if (selectedRows.size > 0) {
                    onArchive(Array.from(selectedRows)); // Pass selected original indices
                    setSelectedRows(new Set()); // Clear selection after action
                }
            }, [selectedRows, onArchive]);


            return (
                <div className="space-y-4">
                    <div className="flex justify-end">
                        {selectedRows.size > 0 && (
                            <button
                                onClick={handleBulkArchive}
                                className={`${isArchived ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white font-bold py-2 px-4 rounded-lg transition-colors`}
                            >
                                {isArchived ? `Restaurar (${selectedRows.size})` : `Archivar (${selectedRows.size})`}
                            </button>
                        )}
                    </div>
                    <div className="table-container max-h-[50vh] overflow-auto border border-border-color rounded-lg"> {/* Adjusted height */}
                        <table className="w-full text-sm text-left text-text-secondary table-fixed">
                            <thead className="text-xs text-text-primary uppercase bg-header sticky top-0 z-10">
                                <tr>
                                    <th className="px-4 py-3 w-12"><input type="checkbox" onChange={handleSelectAll} checked={filteredData.length > 0 && selectedRows.size === filteredData.length}/></th>
                                    <th className="px-4 py-3 w-32">Fecha Ing.</th>
                                    <th className="px-4 py-3 w-32">No. Orden</th>
                                    <th className="px-4 py-3 w-48">Nombre</th>
                                    <th className="px-4 py-3 w-32">EPS</th>
                                    <th className="px-4 py-3 w-32">Radicado</th>
                                    <th className="px-4 py-3 w-32">Estado</th>
                                    <th className="px-4 py-3 w-64">Notas</th> {/* Wider notes */}
                                    <th className="px-4 py-3 w-16">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredData.map(({ row, index: originalIndex }) => { // Use row and originalIndex from filteredData
                                    if (!row || typeof row !== 'object') return null; // Skip invalid rows

                                    return (
                                        <tr key={originalIndex} className={`border-b border-border-color hover:bg-highlight transition-colors ${isArchived ? 'bg-gray-700/50 text-text-secondary italic' : statusClasses[row.Estado] || ''}`}>
                                            <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(originalIndex)} onChange={() => handleSelectRow(originalIndex)} /></td>
                                            <td className="px-4 py-2 whitespace-nowrap">{row.Fecha_Ing || ''}</td>
                                            <td className="px-4 py-2 whitespace-nowrap">{row.No_Orden || ''}</td>
                                            <td className="px-4 py-2 whitespace-nowrap overflow-hidden text-ellipsis" title={row.Nombre || ''}>{row.Nombre || ''}</td>
                                            <td className="px-4 py-2 whitespace-nowrap overflow-hidden text-ellipsis" title={row.EPS || ''}>{row.EPS || ''}</td>
                                            <td className="px-4 py-2 whitespace-nowrap">{row.Radicado || ''}</td>
                                            <td className="px-4 py-2">
                                                <select
                                                    value={row.Estado || TRACKING_STATUSES[0]}
                                                    onChange={e => onUpdate(originalIndex, { ...row, Estado: e.target.value })}
                                                    className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary text-xs w-full" // Smaller text
                                                >
                                                    {TRACKING_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                                                </select>
                                            </td>
                                            <td
                                                className="px-4 py-2 outline-none focus:bg-primary focus:text-black whitespace-normal break-words" // Allow wrap
                                                contentEditable={!isArchived} // Only editable if not archived
                                                onBlur={e => {
                                                    const newNotes = e.currentTarget.innerText;
                                                    if(!isArchived && (row.Notas || '') !== newNotes){
                                                        onUpdate(originalIndex, { ...row, Notas: newNotes });
                                                    }
                                                }}
                                                suppressContentEditableWarning={true}
                                                title={row.Notas || ''}
                                            >
                                                {row.Notas || ''}
                                            </td>
                                            <td className="px-4 py-2 text-lg cursor-pointer text-center" onClick={() => onArchive([originalIndex])} title={isArchived ? 'Restaurar' : 'Archivar'}>
                                                {isArchived ? '‚ôªÔ∏è' : 'üóÑÔ∏è'}
                                            </td>
                                        </tr>
                                    );
                                })}
                                 {filteredData.length === 0 && (
                                    <tr>
                                        <td colSpan={9} className="text-center py-4 text-text-secondary italic">
                                            No hay casos {isArchived ? 'archivados' : 'en seguimiento activo'} {filter ? 'que coincidan con la b√∫squeda' : ''}.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const TrackingArea = ({ trackingData, archivedData, updateTrackingData, archiveItems }) => {
          const [showArchived, setShowArchived] = useState(false);
          const [filter, setFilter] = useState('');
          const currentTrackingData = useMemo(() => Array.isArray(trackingData) ? trackingData : [], [trackingData]);
          const currentArchivedData = useMemo(() => Array.isArray(archivedData) ? archivedData : [], [archivedData]);

          return (
            <section id="area4" className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 4: Seguimiento</h2>
              <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input
                  type="text"
                  placeholder="Buscar en Activos/Archivados..."
                  className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                  value={filter}
                  onChange={e => setFilter(e.target.value)}
                />
                <button onClick={() => setShowArchived(!showArchived)} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex-shrink-0"> {/* flex-shrink-0 */}
                  {showArchived ? 'Ocultar' : 'Mostrar'} Archivados ({currentArchivedData.length})
                </button>
              </div>

              <h3 className="text-xl font-semibold text-white">Seguimiento Activo ({currentTrackingData.length})</h3>
              <TrackingTable
                data={currentTrackingData}
                isArchived={false}
                onUpdate={updateTrackingData} // Pass the main handler directly
                onArchive={archiveItems} // Pass the main handler directly
                filter={filter}
              />

              {showArchived && (
                <div className="mt-8">
                  <h3 className="text-xl font-semibold text-white">Casos Archivados ({currentArchivedData.length})</h3>
                  <TrackingTable
                    data={currentArchivedData}
                    isArchived={true}
                    onUpdate={updateTrackingData} // Pass the main handler directly
                    onArchive={archiveItems} // Pass the main handler directly
                    filter={filter}
                  />
                </div>
              )}
            </section>
          );
        };


        // =================================================================================
        // INLINED: components/SetupModal.tsx - Includes all corrections and improvements
        // =================================================================================
        const SetupModal = ({ onSave, onClose, initialUrl = '' }) => {
            const [url, setUrl] = useState(initialUrl);
            const [isVerifying, setIsVerifying] = useState(false);

            const handleSave = async () => {
                if (!url || !url.startsWith('https://script.google.com/macros/s/')) {
                    alert("Por favor, introduce una URL v√°lida de Google Apps Script.");
                    return;
                }
                setIsVerifying(true);
                 try {
                    await onSave(url); // Let App component handle success/error notification
                } catch (error) {
                    // Error notification is handled by handleSetScriptUrl in App
                    console.error("Verification failed from SetupModal:", error);
                } finally {
                    setIsVerifying(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-background/90 flex justify-center items-center z-[200] p-4">
                    <div className="bg-surface rounded-lg shadow-xl w-full max-w-lg border border-border-color p-8 space-y-6">
                        <div className="text-center">
                            <h2 className="text-2xl font-bold text-primary">Configuraci√≥n de Conexi√≥n</h2>
                            <p className="text-text-secondary mt-2">Pega la URL de tu aplicaci√≥n web de Google Apps Script.</p>
                        </div>
                        <div>
                            <label htmlFor="script-url" className="block text-sm font-medium text-text-primary mb-1">URL del Script</label>
                            <input id="script-url" type="url" value={url} onChange={(e) => setUrl(e.target.value)} placeholder="https://script.google.com/macros/s/..." className="w-full bg-background border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary focus:ring-primary focus:border-primary"/>
                        </div>
                        <div className="flex justify-end gap-4">
                            <button onClick={onClose} disabled={isVerifying} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                Cancelar
                            </button>
                            <button onClick={handleSave} disabled={isVerifying || !url} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed min-w-[150px] flex justify-center items-center"> {/* Added min-width and flex */}
                                {isVerifying ? <Spinner /> : 'Guardar y Verificar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // =================================================================================
        // INLINED: components/TemplateManagerModal.tsx - Includes all corrections and improvements
        // =================================================================================
        const TemplateManagerModal = ({ templates, onClose, onSave, onReset }) => {
             // Initialize with a guaranteed array, deep copy of defaults if needed
             const [currentTemplates, setCurrentTemplates] = useState(() => Array.isArray(templates) ? JSON.parse(JSON.stringify(templates)) : JSON.parse(JSON.stringify(defaultTemplates)));
             const [editingTemplate, setEditingTemplate] = useState(null); // Holds the template being edited/created

             const handleSaveLocal = useCallback(() => { // Renamed to avoid conflict with prop
                onSave(currentTemplates); // Save the current state
                onClose();
             }, [currentTemplates, onSave, onClose]);

             const handleAddNew = useCallback(() => {
                // Generate a unique temporary ID for the new template
                setEditingTemplate({ id: `new_${Date.now()}`, name: '', body: '' });
             }, []);

             const handleEdit = useCallback((templateToEdit) => {
                 setEditingTemplate({ ...templateToEdit }); // Edit a copy
             }, []);

             const handleDelete = useCallback((idToDelete) => {
                if (window.confirm('¬øEliminar esta plantilla?')) {
                    setCurrentTemplates(current => current.filter(t => t.id !== idToDelete));
                }
             }, []);

             const handleSaveTemplateEdit = useCallback(() => {
                if (!editingTemplate || !editingTemplate.name.trim() || !editingTemplate.body.trim()) {
                    alert('El nombre y el cuerpo no pueden estar vac√≠os.');
                    return;
                }
                
                const trimmedTemplate = {
                    ...editingTemplate,
                    name: editingTemplate.name.trim(),
                    body: editingTemplate.body // Keep body as is, trimming might remove intentional spaces/newlines
                };


                setCurrentTemplates(current => {
                    const existingIndex = current.findIndex(t => t.id === trimmedTemplate.id);
                    if (existingIndex > -1) { // Update existing
                        const updated = [...current];
                        updated[existingIndex] = trimmedTemplate;
                        return updated;
                    } else { // Add new
                        return [...current, trimmedTemplate];
                    }
                });
                setEditingTemplate(null); // Close editor after saving
             }, [editingTemplate]);
             
             const handleReset = useCallback(() => {
                 if (window.confirm('¬øRestaurar plantillas predeterminadas? Se perder√°n las personalizadas.')) {
                    // Directly call onReset which should handle saving the defaults
                    onReset();
                    onClose(); // Close modal after reset
                 }
             },[onReset, onClose]);

             // Ensure currentTemplates is always an array for rendering
             const renderTemplates = Array.isArray(currentTemplates) ? currentTemplates : [];

            return (
                <div className="fixed inset-0 bg-black/70 flex justify-center items-center z-[150] p-4">
                    <div className="bg-surface rounded-lg shadow-xl w-full max-w-4xl border border-border-color flex flex-col max-h-[90vh]">
                        <div className="p-4 sm:p-6 border-b border-border-color flex justify-between items-center flex-shrink-0"> {/* Adjusted padding */}
                            <h3 className="text-xl font-bold text-primary">Gestionar Plantillas</h3>
                            <button onClick={onClose} className="text-text-secondary text-2xl hover:text-text-primary">&times;</button>
                        </div>

                        <div className="p-4 sm:p-6 overflow-y-auto space-y-6 flex-grow">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                                <div className="flex flex-col">
                                    <h4 className="text-lg font-semibold mb-2 flex-shrink-0">Plantillas Guardadas</h4>
                                    <ul className="space-y-2 border border-border-color rounded-lg p-2 overflow-y-auto flex-grow bg-background/30"> {/* Added background */}
                                        {renderTemplates.map(template => (
                                            <li key={template.id} className="flex justify-between items-center p-2 bg-highlight rounded gap-2"> {/* Added gap */}
                                                <span className="text-text-primary truncate flex-grow" title={template.name}>{template.name}</span>
                                                <div className="space-x-2 flex-shrink-0">
                                                    <button onClick={() => handleEdit(template)} className="text-sm bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded">Editar</button>
                                                    <button onClick={() => handleDelete(template.id)} className="text-sm bg-danger hover:bg-danger-hover px-2 py-1 rounded">Borrar</button>
                                                </div>
                                            </li>
                                        ))}
                                        {renderTemplates.length === 0 && <li className="text-text-secondary text-center p-4 italic">No hay plantillas personalizadas.</li>}
                                    </ul>
                                </div>

                                <div className="flex flex-col">
                                     <h4 className="text-lg font-semibold mb-2 flex-shrink-0">{editingTemplate ? 'Editor de Plantilla' : 'A√±adir Nueva'}</h4>
                                    {editingTemplate ? (
                                        <div className="space-y-4 p-4 border border-border-color rounded-lg bg-highlight flex flex-col flex-grow">
                                            <input type="text" placeholder="Nombre de la Plantilla" value={editingTemplate.name || ''} onChange={(e) => setEditingTemplate(prev => ({ ...prev, name: e.target.value }))} className="w-full bg-background border border-border-color rounded-md px-3 py-2 flex-shrink-0"/>
                                            <textarea placeholder="Cuerpo de la Plantilla (HTML permitido)..." value={editingTemplate.body || ''} onChange={(e) => setEditingTemplate(prev => ({ ...prev, body: e.target.value }))} className="w-full bg-background border border-border-color rounded-md px-3 py-2 resize-y flex-grow min-h-[150px]"/> {/* Added min-height */}
                                            <p className="text-xs text-text-secondary flex-shrink-0">Marcadores: {`{{Columna}}`} (e.j: {`{{Nombre}}`}, {`{{No_Orden}}`})</p>
                                            <div className="flex gap-2 flex-shrink-0">
                                                <button onClick={handleSaveTemplateEdit} className="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">Guardar Cambios</button>
                                                <button onClick={() => setEditingTemplate(null)} className="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm">Cancelar</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center border border-dashed border-border-color rounded-lg p-4 h-full bg-background/30">
                                             <button onClick={handleAddNew} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg">
                                                + A√±adir Nueva Plantilla
                                             </button>
                                             <p className="text-sm text-text-secondary mt-2">o selecciona una existente para editarla.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="p-4 bg-header flex justify-between items-center rounded-b-lg flex-shrink-0">
                            <button onClick={handleReset} className="bg-danger hover:bg-danger-hover text-white font-bold py-2 px-4 rounded-lg">Restaurar Predeterminadas</button>
                            <div className="flex gap-4">
                                <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                <button onClick={handleSaveLocal} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Guardar y Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // =================================================================================
        // INLINED: components/PreviewModal.tsx - Includes all corrections and improvements
        // =================================================================================
        const PreviewModal = ({ data, template, onClose }) => {
            if (!data || typeof data !== 'object') {
                console.error("Invalid data provided to PreviewModal:", data);
                return null;
            }
            const bodyContent = template && template.body ? replacePlaceholders(template.body, data) : '<p><i>Selecciona un tipo de carta en el √Årea 3 para ver la vista previa.</i></p>';
            const fullBody = `<div style="font-family: sans-serif; font-size: 11pt; color: black;">${bodyContent}${COMMON_EMAIL_BODY}${SIGNATURE}</div>`; // Wrap in div with styles

            const copyToClipboard = useCallback(() => { /* ... (Code from previous response) ... */ }, [fullBody]);
            const copyHtmlToClipboard = useCallback(() => { /* ... (Code from previous response) ... */ }, [fullBody]);

            return (
                <div className="fixed inset-0 bg-black/70 flex justify-center items-center z-[150] p-4">
                    <div className="bg-surface rounded-lg shadow-xl w-full max-w-3xl border border-border-color flex flex-col max-h-[90vh]">
                        <div className="p-4 sm:p-6 border-b border-border-color flex justify-between items-center flex-shrink-0">
                            <h3 className="text-xl font-bold text-primary truncate">Vista Previa: Orden {data.No_Orden || 'N/A'}</h3>
                            <button onClick={onClose} className="text-text-secondary text-2xl hover:text-text-primary">&times;</button>
                        </div>
                        <iframe
                            srcDoc={fullBody}
                            className="flex-grow overflow-y-auto bg-white border-0" // Use border-0
                            sandbox="allow-same-origin"
                            style={{ minHeight: '400px' }} // Increased min-height
                            title={`Vista Previa Email Orden ${data.No_Orden || 'N/A'}`}
                        />
                        <div className="p-4 bg-header flex justify-end gap-4 rounded-b-lg flex-shrink-0">
                            <button onClick={copyHtmlToClipboard} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" title="Copiar HTML formateado">Copiar HTML</button>
                            <button onClick={copyToClipboard} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors" title="Copiar solo texto">Copiar Texto</button>
                            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };


        // =================================================================================
        // INLINED: App.tsx (The main application component) - Includes all corrections and improvements
        // =================================================================================
         const App = () => {
             // Central state management
             const [state, setState] = useState({
                 finalData: [],
                 trackingData: [],
                 archivedData: [],
                 portalData: [],
                 pdfData: Array(5).fill({}),
                 templates: [],
                 scriptUrl: null,
                 isSetupNeeded: false, // Flag for initial setup modal
                 isReconfiguring: false, // Flag for re-opening setup modal
                 isLoading: true, // Flag for initial data load
                 isSaving: false, // Flag for save operation in progress
                 isTemplateManagerOpen: false,
                 previewData: null, // Holds data for the preview modal
                 notification: null, // { message, type, timeoutId }
                 editsCount: 0, // Counter for unsaved edits (local changes)
                 onlineStatus: true, // Network connection status
                 masterTrackingOrders: new Set(), // Set of existing No_Orden strings from "TOTAL" sheet
             });

             // State for sorting the ReviewArea table
             const [sortConfig, setSortConfig] = useState({ key: 'No_Orden', direction: 'ascending' });

             // --- Notification Management ---
             const hideNotification = useCallback(() => {
                 setState(prev => ({ ...prev, notification: null }));
             }, []);

             const showNotification = useCallback((message, type = 'info', duration = 5000) => {
                 // Clear previous timeout if exists
                 setState(prev => {
                     if (prev.notification && prev.notification.timeoutId) {
                         clearTimeout(prev.notification.timeoutId);
                     }
                     const timeoutId = setTimeout(hideNotification, duration);
                     return { ...prev, notification: { message, type, timeoutId } };
                 });
             }, [hideNotification]); // Dependency


             // --- Google Sheet Interaction ---
             const handleSetScriptUrl = useCallback(async (url) => { /* ... (Code from previous response, includes error handling) ... */ }, [showNotification]);
             const handleSave = useCallback(async () => { /* ... (Code from previous response, includes clearing finalData on success) ... */ }, [state.scriptUrl, state.onlineStatus, state.finalData, state.trackingData, state.archivedData, state.masterTrackingOrders, showNotification]);


             // --- Lifecycle and Setup ---
             useEffect(() => { /* ... (Code from previous response, fetches initial data, sets up online/offline listeners) ... */ }, [handleSetScriptUrl, showNotification]); // Dependencies


             // --- Edit Tracking ---
             const incrementEdits = useCallback(() => {
                 setState(prev => ({ ...prev, editsCount: prev.editsCount + 1 }));
             }, []);


             // --- Data Processing Logic ---
             const processPortalData = useCallback(() => { /* ... (Code from previous response, filters duplicates based on masterTrackingOrders) ... */ }, [state.portalData, state.masterTrackingOrders, showNotification]);
             const mergePdfData = useCallback(() => { /* ... (Code from previous response, ensures data is array) ... */ }, [state.pdfData, state.finalData, showNotification]);


             // --- Review Area Logic ---
             const updateFinalDataRow = useCallback((noOrden, partialUpdate) => { /* ... (Code from previous response, calls incrementEdits) ... */ }, [incrementEdits]);
             const handleClearReviewData = useCallback(() => { /* ... (Code from previous response) ... */ }, [showNotification]);
             const handleSendToTracking = useCallback((selectedOrderKeys) => { /* ... (Code from previous response, expects string keys) ... */ }, [state.templates, showNotification]); // Removed state deps, uses updater function


             // --- Export Logic ---
             const exportForMailMerge = useCallback((dataToExport) => { /* ... (Code from previous response, handles array input) ... */ }, [state.templates, showNotification]);


             // --- Tracking Area Logic ---
             const updateTrackingData = useCallback((index, updatedRow, isArchived) => { /* ... (Code from previous response, increments edits, handles index bounds) ... */ }, []);
             const archiveItems = useCallback((indicesToMove, fromArchived) => { /* ... (Code from previous response, increments edits, handles array indices) ... */ }, []);


             // --- Template Management ---
             const handleSaveTemplates = useCallback((newTemplates) => { /* ... (Code from previous response, includes validation) ... */ }, [showNotification]);
             const handleResetTemplates = useCallback(() => { /* ... (Code from previous response) ... */ }, [handleSaveTemplates]);


             // --- Memoized Sorted Data ---
             const sortedFinalData = useMemo(() => { /* ... (Code from previous response, includes safe access and localeCompare) ... */ }, [state.finalData, sortConfig]);


             // ================== Render Logic ==================
              if (state.isLoading && !state.isSetupNeeded) {
                  return <div className="fixed inset-0 bg-background/90 flex items-center justify-center z-[300]"><Spinner /> <span className="ml-4 text-xl text-text-primary">Cargando Datos...</span></div>;
              }

              if (state.isSetupNeeded || state.isReconfiguring) {
                  return <SetupModal
                      onSave={handleSetScriptUrl}
                      onClose={() => {
                          if (!state.isSetupNeeded) { // Only allow closing if not initial setup
                              setState(prev => ({ ...prev, isReconfiguring: false }));
                          } else {
                              alert("Debes configurar la URL del script para usar la aplicaci√≥n.");
                          }
                      }}
                      initialUrl={state.scriptUrl || ''}
                  />;
              }

              // Main application layout
              return (
                  <div className="p-4 sm:p-8 bg-background min-h-screen text-text-primary">
                      {/* --- Notifications --- */}
                      {state.notification && ( <Notification message={state.notification.message} type={state.notification.type} onClose={hideNotification} /> )}
                      {!state.onlineStatus && ( <div className="bg-yellow-500 text-black text-center p-2 fixed top-0 left-0 w-full z-[100] shadow">‚ö† Est√°s desconectado. El guardado en la nube est√° deshabilitado.</div> )}

                      {/* --- Main Content --- */}
                      <main className={`max-w-screen-2xl mx-auto bg-surface p-4 sm:p-6 rounded-xl border border-border-color space-y-8 ${!state.onlineStatus ? 'pt-12 md:pt-10' : ''}`}>
                          <Header
                              onSave={handleSave}
                              onManageTemplates={() => setState(prev => ({ ...prev, isTemplateManagerOpen: true }))}
                              onReconfigure={() => setState(prev => ({ ...prev, isReconfiguring: true }))}
                              isSaving={state.isSaving}
                          />
                          <Dashboard
                               reviewCount={Array.isArray(state.finalData) ? state.finalData.length : 0}
                               trackingCount={Array.isArray(state.trackingData) ? state.trackingData.length : 0}
                               archivedCount={Array.isArray(state.archivedData) ? state.archivedData.length : 0}
                               editsCount={state.editsCount}
                          />
                          <div className="text-right">
                              <button
                                  onClick={() => exportDetailedReport(state.finalData, state.trackingData, state.archivedData)}
                                  disabled={state.isSaving} // Disable while saving
                                  className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                              >
                                  Descargar Reporte Detallado
                              </button>
                          </div>

                          {/* --- Data Input Areas --- */}
                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                              <DataInputArea id="portal-area" title="√Årea 1: Cargar Excel del Portal" headers={PORTAL_HEADERS} data={state.portalData} onDataChange={(newData) => setState(prev => ({ ...prev, portalData: newData }))} onProcess={processPortalData} processButtonText="Procesar Datos del Archivo" inputType="file" />
                              <DataInputArea id="pdf-area" title="√Årea 2: Pegar Datos Extractor PDF" headers={PDF_HEADERS} data={state.pdfData} onDataChange={(newData) => setState(prev => ({ ...prev, pdfData: newData }))} onProcess={mergePdfData} processButtonText="Combinar Datos PDF" inputType="paste" />
                          </div>

                          {/* --- Review Area --- */}
                          <ReviewArea data={sortedFinalData} templates={state.templates} updateRow={updateFinalDataRow} incrementEdits={incrementEdits} onSendToTracking={handleSendToTracking} onPreview={(row) => setState(prev => ({ ...prev, previewData: row }))} onExportForMailMerge={exportForMailMerge} onClearReviewData={handleClearReviewData} sortConfig={sortConfig} setSortConfig={setSortConfig} />

                          {/* --- Tracking Area --- */}
                          <TrackingArea trackingData={state.trackingData} archivedData={state.archivedData} updateTrackingData={updateTrackingData} archiveItems={archiveItems} />

                           {/* Saving Overlay */}
                           {state.isSaving && <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[300]"><Spinner /> <span className="ml-4 text-xl text-white font-semibold">Guardando Datos...</span></div>}
                      </main>

                       {/* --- Modals --- */}
                      {state.isTemplateManagerOpen && ( <TemplateManagerModal templates={state.templates} onClose={() => setState(prev => ({...prev, isTemplateManagerOpen: false}))} onSave={handleSaveTemplates} onReset={handleResetTemplates} /> )}
                      {state.previewData && ( <PreviewModal data={state.previewData} template={state.templates.find(t => t.id === state.previewData?.Tipo_Carta)} onClose={() => setState(prev => ({...prev, previewData: null}))} /> )}
                  </div>
              );
        };


        // =================================================================================
        // INLINED: index.tsx (Render the application)
        // =================================================================================
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          console.error("Fatal Error: Root element '#root' not found in HTML.");
          // Display error directly in the body if root is missing
          document.body.innerHTML = '<div style="color: #ffcccc; background-color: #330000; border: 1px solid red; padding: 20px; font-family: sans-serif;">Error Cr√≠tico: No se encontr√≥ el elemento ra√≠z de la aplicaci√≥n (#root). Revisa que el div con id="root" exista en tu HTML.</div>';
        } else {
            try {
               const root = ReactDOM.createRoot(rootElement);
               // Use StrictMode for development checks (can be removed for production)
               root.render(<React.StrictMode><App /></React.StrictMode>);
               console.log("React application rendered successfully.");
            } catch(error) {
                console.error("Error rendering React application:", error);
                 // Display detailed error in the root element if React fails
                 rootElement.innerHTML = `<div style="color: #ffcccc; background-color: #330000; border: 1px solid red; padding: 20px; font-family: monospace; white-space: pre-wrap;">
                     <h2>Error Cr√≠tico al Iniciar la Aplicaci√≥n React</h2>
                     <p>${error.message}</p>
                     <hr style="border-color: #660000; margin: 10px 0;"/>
                     <p>Stack Trace:</p>
                     <pre>${error.stack || 'No stack trace available'}</pre>
                     <p style="margin-top: 15px; color: #ff9999;">Revisa la consola del navegador (F12) para m√°s detalles.</p>
                 </div>`;
            }
        }

        // React application code ends here
    </script>
</body>
</html>
