<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador DNGET - Auditoría IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* MODO OSCURO CORPORATIVO - AZUL COOMEVA */
        body { background-color: #0b1120; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        
        .container { max-width: 1200px; }
        
        /* Tarjetas */
        .card { background-color: #1e293b; border: 1px solid #334155; margin-bottom: 20px; }
        .card-header { background-color: #004481; /* Azul Coomeva */ color: white; font-weight: bold; }
        
        /* Inputs */
        .form-control, .form-select { 
            background-color: #0f172a; 
            border: 1px solid #475569; 
            color: #fff; 
        }
        .form-control:focus { background-color: #0f172a; color: #fff; border-color: #38bdf8; box-shadow: 0 0 0 0.2rem rgba(56, 189, 248, 0.25); }
        
        /* Botones */
        .btn-primary { background-color: #0056a3; border: none; }
        .btn-primary:hover { background-color: #004481; }

        /* Área de Archivos */
        .file-drop {
            border: 2px dashed #475569;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        .file-drop:hover { background-color: #334155; border-color: #38bdf8; }

        /* VISTA PREVIA CARTA (Fondo Blanco para PDF) */
        #previewContainer {
            background-color: white;
            color: black;
            padding: 20mm;
            min-height: 297mm;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.2;
        }
        
        /* Estilos Tabla Carta */
        .carta-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 10pt; }
        .carta-table th, .carta-table td { border: 1px solid black; padding: 5px; text-align: left; vertical-align: top; }
        .carta-table th { background-color: #f0f0f0; text-align: center; }

        /* Loading */
        #loadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; text-align: center; padding-top: 20%;
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status"></div>
    <h3 class="text-white mt-3">Analizando Documentos con IA...</h3>
    <p class="text-info">Buscando procedimientos e insumos (b10p002, etc)...</p>
</div>

<div class="container py-4">
    <div class="row">
        <div class="col-lg-4">
            <h4 class="text-primary mb-3">Generador DNGET <small class="text-muted text-sm">v3.0</small></h4>

            <div class="card">
                <div class="card-header p-2"><i class="fas fa-key"></i> Configuración</div>
                <div class="card-body p-2">
                    <input type="password" id="apiKey" class="form-control form-control-sm" placeholder="Pega tu API Key de Gemini aquí">
                    <small class="text-muted" style="font-size: 0.7rem;">Usa una clave habilitada para Gemini 1.5 Flash</small>
                </div>
            </div>

            <div class="card">
                <div class="card-header p-2"><i class="fas fa-file-medical"></i> Adjuntar Orden/HC</div>
                <div class="card-body">
                    <div class="file-drop" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-info"></i>
                        <p class="m-0 small">Clic para subir PDF o Imágenes</p>
                        <p class="m-0" style="font-size: 0.7rem; color: #94a3b8;">(La IA leerá el contenido automáticamente)</p>
                    </div>
                    <input type="file" id="fileInput" multiple accept="image/*, application/pdf" style="display: none;" onchange="mostrarArchivos()">
                    <div id="fileList" class="mt-2 small text-warning"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header p-2"><i class="fas fa-edit"></i> Datos Manuales</div>
                <div class="card-body">
                    <label class="small text-info">Intención:</label>
                    <select id="intencion" class="form-select form-select-sm mb-2">
                        <option value="cotizar">Cotizar</option>
                        <option value="modificar">Modificar Tarifa (Oferta)</option>
                        <option value="cobertura">Validar Cobertura</option>
                    </select>

                    <input type="text" id="documento" class="form-control form-control-sm mb-1" placeholder="CC Usuario">
                    <input type="text" id="nombre" class="form-control form-control-sm mb-1" placeholder="Nombre Paciente">
                    <input type="text" id="prestador" class="form-control form-control-sm mb-1" placeholder="IPS / Prestador">
                    
                    <div class="row g-1 mt-1">
                        <div class="col-6"><input type="text" id="valorPresmed" class="form-control form-control-sm" placeholder="$ Presmed"></div>
                        <div class="col-6"><input type="text" id="valorOferta" class="form-control form-control-sm" placeholder="$ Oferta"></div>
                    </div>

                    <button onclick="procesarConIA()" class="btn btn-primary w-100 mt-3">
                        <i class="fas fa-magic"></i> GENERAR CARTA
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="m-0">Vista Previa del Documento</h5>
                <button onclick="descargarPDF()" class="btn btn-success btn-sm"><i class="fas fa-download"></i> Descargar PDF</button>
            </div>
            
            <div id="previewContainer">
                <p style="color: #999; text-align: center; margin-top: 50px;">
                    Aquí aparecerá la carta generada...<br>
                    Sube los archivos y presiona "Generar Carta".
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LÓGICA DE PROCESAMIENTO ---

    function mostrarArchivos() {
        const files = document.getElementById('fileInput').files;
        const list = document.getElementById('fileList');
        list.innerHTML = files.length > 0 ? `<i class="fas fa-check"></i> ${files.length} archivo(s) listo(s)` : "";
    }

    // Convertir archivo a Base64 para que la API lo lea
    function fileToGenerativePart(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result.split(',')[1];
                resolve({
                    inline_data: {
                        mime_type: file.type,
                        data: base64Data
                    }
                });
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function procesarConIA() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const files = document.getElementById('fileInput').files;
        
        if (!apiKey) { alert("¡Error! Debes ingresar una API Key válida."); return; }
        if (files.length === 0) { alert("Por favor adjunta al menos un archivo (Orden Médica o Historia)."); return; }

        document.getElementById('loadingOverlay').style.display = 'block';

        try {
            // 1. Preparar Archivos
            const fileParts = await Promise.all([...files].map(file => fileToGenerativePart(file)));

            // 2. Preparar Datos Manuales
            const datos = {
                intencion: document.getElementById('intencion').value,
                doc: document.getElementById('documento').value,
                nombre: document.getElementById('nombre').value.toUpperCase(),
                prestador: document.getElementById('prestador').value.toUpperCase(),
                presmed: document.getElementById('valorPresmed').value,
                oferta: document.getElementById('valorOferta').value
            };

            // 3. Crear Prompt (Instrucciones)
            let instruccionEspecial = "";
            if (datos.intencion === 'modificar') {
                instruccionEspecial = `La intención es MODIFICAR TARIFA. Usa texto: "Solicito Visto Bueno para cambio de valor en presmed (${datos.presmed}) según oferta mercantil (${datos.oferta})." En la tabla, columna TARIFA pon "SEGUN OFERTA: ${datos.oferta}".`;
            } else {
                instruccionEspecial = `La intención es COTIZAR. Usa texto: "Agradezco cotizar los ítems". En tabla TARIFA pon "COTIZAR".`;
            }

            const promptText = `
                Actúa como auditor médico de Coomeva. Analiza las imágenes/PDF adjuntos (Orden Médica/Historia Clínica).
                Extrae: 
                1. Diagnóstico (Código y nombre).
                2. Procedimiento principal (CUPS y Descripción).
                3. **INSUMOS**: Busca meticulosamente códigos como "b10p002", catéteres, guías, o insumos de alto costo mencionados por el especialista.

                Genera un código HTML (SOLO el contenido del body, sin etiquetas <html> ni markdown) para una carta formal con este formato:
                
                Datos Paciente: ${datos.nombre} - ${datos.doc}
                Prestador: ${datos.prestador}
                
                ESTRUCTURA DEL HTML:
                <div style="font-family: Arial, sans-serif;">
                    <p>Buenos días Dres.,<br>Espero se encuentren bien. Agradezco validar caso...</p>
                    <p><strong>PACIENTE:</strong> ${datos.nombre} - ${datos.doc}</p>
                    <p>El especialista solicita: [Breve resumen de lo que leíste en el archivo]</p>
                    <ul>
                        <li>[Frase según intención: ${instruccionEspecial}]</li>
                        <li>Validar pertinencia médica.</li>
                    </ul>
                    
                    <table class="carta-table">
                        <thead>
                            <tr><th>SERVICIO/ITEMS</th><th>CUPS PROPUESTO EAI</th><th>TARIFA</th><th>PRESTADOR</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>[Descripción extraída del archivo + INSUMOS ENCONTRADOS]</td>
                                <td>[Código CUPS extraído]</td>
                                <td>[Tarifa según instrucción]</td>
                                <td>${datos.prestador}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p><strong>DX:</strong> [Diagnóstico encontrado]</p>
                    <p>Cordialmente,<br><strong>Departamento de Auditoría Médica</strong><br>Coomeva Medicina Prepagada</p>
                </div>
            `;

            // 4. Enviar a Gemini API (Modelo Flash es crucial para PDF/Imágenes)
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: promptText },
                            ...fileParts // Aquí van los PDFs e Imágenes convertidos
                        ]
                    }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error API: ${errorData.error.message}`);
            }

            const result = await response.json();
            let htmlGenerado = result.candidates[0].content.parts[0].text;
            
            // Limpiar Markdown si la IA lo pone
            htmlGenerado = htmlGenerado.replace(/```html/g, '').replace(/```/g, '');

            document.getElementById('previewContainer').innerHTML = htmlGenerado;

        } catch (error) {
            console.error(error);
            alert("FALLO EL SISTEMA:\n" + error.message + "\n\nIntenta generar una nueva API Key en Google AI Studio.");
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    function descargarPDF() {
        const elemento = document.getElementById('previewContainer');
        const docId = document.getElementById('documento').value || "archivo";
        
        const opt = {
            margin: 10,
            filename: `DNGET-${docId}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(elemento).save();
    }
</script>

</body>
</html>
