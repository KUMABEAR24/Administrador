<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GESTION NEGACIONES EJE CAFETERO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      // Tailwind CSS Configuration
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4e9fef',
              'background': '#1e1e1e',
              'surface': '#2d2d2d',
              'text-primary': '#d4d4d4',
              'text-secondary': '#a0a0a0',
              'border-color': '#444',
              'header': '#3a3a3a',
              'highlight': '#252526',
              'warning': '#6e550c',
              'archive': '#3a3a3a',
              'success': '#28a745',
              'danger': '#a02d2d',
              'danger-hover': '#c0392b',
              'btn-primary': '#0e639c',
              'btn-primary-hover': '#1a73e8',
            },
            animation: {
              'flash-success': 'flash-success 1s ease-out',
            },
            keyframes: {
              'flash-success': {
                'from': { backgroundColor: '#28a745' },
                'to': { backgroundColor: 'transparent' },
              }
            }
          }
        }
      }
    </script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-background text-text-primary">
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        // CORRECCI√ìN 1: Importamos createRoot directamente para evitar el error de "ReactDOM is undefined"
        import { createRoot } from 'react-dom/client'; 

        // =================================================================================
        // INLINED: constants.ts
        // =================================================================================
        
        const PORTAL_HEADERS = [
          "Fecha_Asignacion", "EJECUTIVO", "FECHA NEGACI√ìN", "REGIONAL", "N√öMERO ORDEN", 
          "TIPO DOCUMENTO", "IDENTIFICACI√ìN AFILIADO", "NOMBRE AFILIADO", "EDAD", 
          "PROCEDIMIENTO", "MOTIVO NEGACI√ìN", "PLAN", "PROGRAMA", "EPS", 
          "Fecha_Ingreso", "EMAIL", "CELULAR", "ESTADO"
        ];

        const PDF_HEADERS = [
          "Archivo (No. Orden)", "Descripci√≥n", "Justificaci√≥n", "Fundamento Legal", "C√≥digo"
        ];

        const TRACKING_STATUSES = ['Pendiente', 'En Gesti√≥n', 'Finalizado'];
        
        const COMMON_EMAIL_BODY = `<br><br><b>Si tiene alguna duda puede contactarse por medio de los canales que tenemos disponibles para usted:</b><br>¬∑ Nuestra l√≠nea nacional 018000931666. O con nuestras l√≠neas locales: Cali (602) 489 0073, Bogot√° (601) 743 5485, Medell√≠n (604) 604 4507, Barranquilla (605) 385 3165, Bucaramanga (607) 697 3350, Cartagena (605) 693 9853, Tulu√° (602) 235 9483, Valledupar (605)588 5699, Pereira (606) 340 2635.<br>¬∑ WhatsApp: 317-224-07-94<br><br>Gracias por su Atenci√≥n.`;
        const SIGNATURE = `<br><br>Cordialmente,<br><br><b>Juan Ricardo Morales Agudelo</b><br>Ejecutivo De Atenci√≥n Integral<br>Coomeva Medicina Prepagada<br>Cra. 13 No.11-12 Centro M√©dico Circunvalar<br>Coomeva Medicina Prepagada Pereira, Risaralda<br><br><i>Este correo es generado autom√°ticamente, por favor no responda este mensaje.</i>`;

        const defaultTemplates = [
            { id: 'tpl_neg_gen', name: 'PLANTILLA NEGACION GENERAL', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad no est√° aprobado debido a que corresponde a EXCLUSI√ìN ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El servicio negado anteriormente; debe tramitarlo a trav√©s su EPS asignada. Adjuntamos soporte de la carta de negaci√≥n.` },
            { id: 'tpl_neg_pert', name: 'PLANTILLA NO PERTINENCIA Y TEMAS ESTETICOS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad No est√° aprobado debido a que corresponde a NO PERTINENCIA ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>` },
            { id: 'tpl_comp_coinc', name: 'COMPLEMENTARIEDAD RED COINCIDENTE', body: `Apreciado Usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y el de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no fue aprobado, debido a que ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, est√° en gesti√≥n a trav√©s de su EPS ({{EPS}}) con el n√∫mero de radicado ({{Radicado_Comp}}), puede realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).<br><br>Adicional estaremos haciendo seguimiento al radicado y una vez se encuentre gestionado por la EPS, le notificaremos por medio de correo electr√≥nico.` },
            { id: 'tpl_comp_no_coinc', name: 'COMPLEMENTARIEDAD RED NO COINCIDENTE', body: `Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado, debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El prestador actual solicitado, no tiene convenio con la EPS, por lo que los costos adicionales del servicio o insumo estar√°n a cargo del paciente. Sin embargo; se radica la solicitud ante su EPS con el n√∫mero ({{Radicado_Comp}}) por favor realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).` },
            { id: 'tpl_comp_ayudas', name: 'COMPLEMENTARIEDAD AYUDAS DIAGNOSTICAS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, se encuentra en gesti√≥n a trav√©s de su EPS con el n√∫mero de radicado ({{Radicado_Comp}}), por favor realizar seguimiento mediante la oficina virtual. ({{Oficina_Virtual_EPS}}).` },
        ];


        // =================================================================================
        // INLINED: services/utilityService.ts
        // =================================================================================
        const capitalizeWords = (str) => {
          if (!str) return '';
          // CORRECCI√ìN 2: Forzamos a que sea String para que no rompa si viene un n√∫mero desde el Excel
          return String(str).toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        };

        const processPastedData = (pastedText, headers) => {
          return pastedText
            .trim()
            .split(/\r?\n/)
            .map(rowText => {
              const cells = rowText.split('\t');
              const rowObject = {};
              headers.forEach((header, index) => {
                if (cells[index]) {
                  rowObject[header] = cells[index].trim();
                }
              });
              return rowObject;
            });
        };

        const replacePlaceholders = (templateBody, data) => {
          const getOficinaVirtual = (eps) => {
            const e = String(eps || "").toUpperCase();
            if (e.includes("NUEVA EPS")) return `<a href='https://portal.nuevaeps.com.co/Portal/home.jspx' target='_blank' rel='noopener noreferrer'>NUEVA EPS</a>`;
            if (e.includes("SALUD TOTAL")) return `<a href='https://saludtotal.com.co/' target='_blank' rel='noopener noreferrer'>SALUD TOTAL</a>`;
            return eps;
          };

          const fullData = { ...data, Oficina_Virtual_EPS: getOficinaVirtual(data.EPS) };

          return templateBody.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return fullData[key] || match;
          });
        };

        const exportDetailedReport = (finalData, trackingData, archivedData) => {
          try {
            const masterDataMap = new Map();

            [...finalData, ...trackingData, ...archivedData].forEach(row => {
              if (row.No_Orden) {
                const key = String(row.No_Orden).trim();
                const existing = masterDataMap.get(key) || {};
                masterDataMap.set(key, { ...existing, ...row });
              }
            });
            
            const masterData = Array.from(masterDataMap.values());

            if (masterData.length === 0) {
              alert("No hay datos consolidados para exportar.");
              return;
            }

            const wb = XLSX.utils.book_new();
            
            if (finalData.length > 0) {
              const ws1 = XLSX.utils.json_to_sheet(finalData);
              XLSX.utils.book_append_sheet(wb, ws1, "Casos en Revisi√≥n");
            }
            
            if (trackingData.length > 0) {
              const ws2 = XLSX.utils.json_to_sheet(trackingData);
              XLSX.utils.book_append_sheet(wb, ws2, "Seguimiento Activo");
            }

            if (archivedData.length > 0) {
              const ws3 = XLSX.utils.json_to_sheet(archivedData);
              XLSX.utils.book_append_sheet(wb, ws3, "Seguimiento Archivado");
            }
            
            const ws4 = XLSX.utils.json_to_sheet(masterData);
            XLSX.utils.book_append_sheet(wb, ws4, "Maestro Consolidado");

            XLSX.writeFile(wb, `Sigweb_Reporte_Detallado_${new Date().toISOString().slice(0, 10)}.xlsx`);
          } catch (error) {
            console.error("Fall√≥ la exportaci√≥n del reporte Excel:", error);
            alert("Ocurri√≥ un error al generar el reporte.");
          }
        };

        const TEMPLATE_STORAGE_KEY = 'sigweb_emailTemplates';

        const loadTemplates = () => {
          try {
            const storedTemplates = localStorage.getItem(TEMPLATE_STORAGE_KEY);
            if (storedTemplates) {
              const parsed = JSON.parse(storedTemplates);
              if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].id && parsed[0].name) {
                return parsed;
              }
            }
          } catch (error) {
            console.error("Fall√≥ la carga de plantillas", error);
            localStorage.removeItem(TEMPLATE_STORAGE_KEY);
          }
          return defaultTemplates;
        };

        const saveTemplates = (templates) => {
          try {
            localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
          } catch (error) {
            console.error("Fall√≥ el guardado de plantillas", error);
          }
        };

        const fetchData = async (url) => {
            const response = await fetch(`${url}?action=getData`);
            if (!response.ok) {
                throw new Error('La respuesta de la red no fue correcta');
            }
            const data = await response.json();
            return {
                finalData: data.finalData || [],
                trackingData: data.trackingData || [],
                archivedData: data.archivedData || [],
            };
        };

        const saveData = async (url, data) => {
            const response = await fetch(url, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(data),
            });
            return { status: 'success', message: 'Datos enviados al servidor.' };
        };

        // --- INICIO DE COMPONENTES ---

        const Spinner = () => {
          return (
            <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent align-[-0.125em]" role="status">
              <span className="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Cargando...</span>
            </div>
          );
        };

        const Notification = ({ message, type, onClose }) => {
          const typeClasses = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500', info: 'bg-blue-600' };
          return (
            <div className={`fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white ${typeClasses[type]} flex items-center gap-4`}>
              <span>{message}</span>
              <button onClick={onClose} className="text-xl font-bold">&times;</button>
            </div>
          );
        };

        const Header = ({ onSave, onManageTemplates, onReconfigure }) => {
          return (
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-border-color">
              <div>
                <h1 className="text-3xl font-bold text-white">GESTION NEGACIONES EJE CAFETERO</h1>
                <p className="text-text-secondary">Sistema Integrado de Gesti√≥n de Flujos de Trabajo</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onManageTemplates} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">Gestionar Plantillas</button>
                <button onClick={onReconfigure} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Reconfigurar Conexi√≥n</button>
                <button onClick={onSave} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar en la Nube</button>
              </div>
            </header>
          );
        };

        const DashboardCard = ({ title, value, icon }) => (
          <div className="bg-surface p-4 rounded-lg border border-border-color flex items-center">
            <div className="text-3xl text-primary mr-4">{icon}</div>
            <div>
              <h4 className="text-sm font-semibold text-text-secondary uppercase tracking-wider">{title}</h4>
              <p className="text-2xl font-bold text-text-primary">{value}</p>
            </div>
          </div>
        );

        const Dashboard = ({ reviewCount, trackingCount, archivedCount, editsCount }) => (
          <section id="dashboard" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <DashboardCard title="Casos en Revisi√≥n" value={reviewCount} icon={'üìã'} />
            <DashboardCard title="Seguimiento Activo" value={trackingCount} icon={'‚è≥'} />
            <DashboardCard title="Casos Archivados" value={archivedCount} icon={'üóÑÔ∏è'} />
            <DashboardCard title="Ediciones en Sesi√≥n" value={editsCount} icon={'‚úèÔ∏è'} />
          </section>
        );

        function DataInputArea({ id, title, headers, data, onDataChange, onProcess, processButtonText = "Procesar Datos" }) {
          const handlePaste = useCallback((e) => {
            e.preventDefault();
            const pastedText = e.clipboardData.getData('text/plain');
            const newRows = processPastedData(pastedText, headers);
            const updatedData = [...data.filter(row => Object.values(row).some(val => val)), ...newRows];
            if (updatedData.length < 5) {
                for (let i = 0; i < (5 - updatedData.length); i++) updatedData.push({});
            }
            onDataChange(updatedData);
          }, [data, headers, onDataChange]);

          const handleCellChange = (rowIndex, header, value) => {
            const newData = [...data];
            newData[rowIndex] = { ...newData[rowIndex], [header]: value };
            onDataChange(newData);
          };

          return (
            <section id={id} className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">{title}</h2>
              <div className="table-container max-h-72 overflow-auto border border-border-color rounded-lg text-xs">
                <table className="w-full text-left text-text-secondary">
                  <thead className="text-text-primary uppercase bg-header sticky top-0">
                    <tr>{headers.map(header => (<th key={header} className="px-4 py-3 whitespace-nowrap">{header}</th>))}</tr>
                  </thead>
                  <tbody onPaste={handlePaste}>
                    {data.map((row, rowIndex) => (
                      <tr key={rowIndex} className="border-b border-border-color hover:bg-highlight">
                        {headers.map(header => (
                          <td key={`${rowIndex}-${header}`} className="px-4 py-2 border-r border-border-color outline-none" contentEditable suppressContentEditableWarning onBlur={(e) => handleCellChange(rowIndex, header, e.currentTarget.innerText)}>
                            {row[header] || ''}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="flex gap-4">
                <button onClick={onProcess} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg">{processButtonText}</button>
                <button onClick={() => onDataChange(Array(5).fill({}))} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Limpiar Tabla</button>
              </div>
            </section>
          );
        }

        const ReviewArea = ({ data, templates, updateRow, incrementEdits, onSendToTracking, onPreview, onExportForMailMerge, onClearReviewData, sortConfig, setSortConfig }) => {
          const [selectedRows, setSelectedRows] = useState(new Set());
          const [filter, setFilter] = useState('');
          
          const REVIEW_HEADERS = [
              { key: 'Fecha_Neg', label: 'Fecha de Negaci√≥n' },
              { key: 'No_Orden', label: 'N√∫mero de Orden' },
              { key: 'No_Cedula', label: 'N√∫mero de C√©dula' },
              { key: 'Nombre', label: 'Nombre Afiliado' },
              { key: 'EPS', label: 'EPS' },
              { key: 'Programa', label: 'Programa', compact: true },
              { key: 'Motivo_Negacion', label: 'Motivo Neg', compact: true },
              { key: 'Descripcion_PDF', label: 'Descripci√≥n', compact: true },
              { key: 'Justificacion_PDF', label: 'Justificaci√≥n', compact: true },
              { key: 'Fundamento_Legal_PDF', label: 'Fund. Legal', compact: true },
          ];

          const filteredData = useMemo(() => {
            if (!filter) return data;
            const lowFilter = filter.toLowerCase();
            return data.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(lowFilter)));
          }, [data, filter]);

          return (
            <section id="area3" className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 3: Revisi√≥n Final y Exportaci√≥n</h2>
              <div className="bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input type="text" placeholder="Buscar..." className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary text-sm" value={filter} onChange={(e) => setFilter(e.target.value)} />
                <span className="text-text-primary text-sm">{selectedRows.size} fila(s) seleccionada(s)</span>
              </div>
              <div className="table-container max-h-[700px] overflow-auto border border-border-color rounded-lg text-xs">
                <table className="w-full text-left">
                  <thead className="bg-header sticky top-0 uppercase">
                    <tr>
                      <th className="px-4 py-3"><input type="checkbox" onChange={(e) => setSelectedRows(e.target.checked ? new Set(filteredData.map(r => r.No_Orden)) : new Set())} /></th>
                      <th className="px-4 py-3">üëÅÔ∏è</th>
                      {REVIEW_HEADERS.map(h => (<th key={h.key} className="px-4 py-3 cursor-pointer">{h.label}</th>))}
                      <th className="px-4 py-3">Tipo de Carta</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((row, idx) => (
                      <tr key={idx} className="border-b border-border-color hover:bg-highlight">
                        <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(row.No_Orden)} onChange={() => { const s = new Set(selectedRows); s.has(row.No_Orden) ? s.delete(row.No_Orden) : s.add(row.No_Orden); setSelectedRows(s); }} /></td>
                        <td className="px-4 py-2 cursor-pointer" onClick={() => onPreview(row)}>üëÅÔ∏è</td>
                        {REVIEW_HEADERS.map(h => (
                          <td key={h.key} className="px-4 py-2 outline-none" contentEditable suppressContentEditableWarning onBlur={e => { updateRow(row.No_Orden, { [h.key]: e.currentTarget.innerText }); incrementEdits(); }}>
                            {row[h.key]}
                          </td>
                        ))}
                        <td className="px-4 py-2">
                           <select className="bg-surface text-xs border border-border-color p-1 rounded" value={row.Tipo_Carta || ''} onChange={e => { updateRow(row.No_Orden, { Tipo_Carta: e.target.value }); incrementEdits(); }}>
                              <option value="">-- Seleccionar --</option>
                              {templates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                           </select>
                           {String(templates.find(t=>t.id===row.Tipo_Carta)?.name || '').includes('COMPLEMENTARIEDAD') && (
                             <input type="text" placeholder="Radicado..." className="bg-surface border border-border-color p-1 rounded mt-1 block w-full" value={row.Radicado_Comp || ''} onChange={e => { updateRow(row.No_Orden, { Radicado_Comp: e.target.value }); incrementEdits(); }} />
                           )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="flex flex-wrap gap-4">
                <button onClick={() => onSendToTracking(Array.from(selectedRows))} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg">Enviar a Seguimiento</button>
                <button onClick={() => onExportForMailMerge(data)} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Exportar para Env√≠o Masivo</button>
                <button onClick={onClearReviewData} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Limpiar Tabla</button>
              </div>
            </section>
          );
        };

        const TrackingTable = ({ data, isArchived, onUpdate, onArchive, filter }) => {
          const statusClasses = { 'Pendiente': 'bg-yellow-600/20', 'En Gesti√≥n': 'bg-blue-600/20', 'Finalizado': 'bg-green-600/20' };
          const filteredData = useMemo(() => {
            if (!filter) return data;
            const f = filter.toLowerCase();
            return data.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(f)));
          }, [data, filter]);

          return (
            <div className="table-container max-h-[400px] overflow-auto border border-border-color rounded-lg text-xs">
              <table className="w-full text-left">
                <thead className="bg-header sticky top-0 uppercase">
                  <tr>
                    <th className="px-4 py-3">Fecha</th><th className="px-4 py-3">Orden</th><th className="px-4 py-3">C√©dula</th><th className="px-4 py-3">Nombre</th><th className="px-4 py-3">EPS</th><th className="px-4 py-3">Radicado</th><th className="px-4 py-3">Estado</th><th className="px-4 py-3">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredData.map((row, idx) => (
                    <tr key={idx} className={`border-b border-border-color ${statusClasses[row.Estado] || ''}`}>
                      <td className="px-4 py-2">{row.Fecha_Ing}</td><td className="px-4 py-2">{row.No_Orden}</td><td className="px-4 py-2">{row.No_Cedula}</td><td className="px-4 py-2">{row.Nombre}</td><td className="px-4 py-2">{row.EPS}</td><td className="px-4 py-2">{row.Radicado}</td>
                      <td className="px-4 py-2">
                        <select className="bg-surface text-xs" value={row.Estado} onChange={e => onUpdate(idx, { ...row, Estado: e.target.value })}>
                          {TRACKING_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                      </td>
                      <td className="px-4 py-2 cursor-pointer" onClick={() => onArchive([idx])}>{isArchived ? '‚ôªÔ∏è' : 'üóÑÔ∏è'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        };

        const TrackingArea = ({ trackingData, archivedData, updateTrackingData, archiveItems, onExportComplementariedades }) => {
          const [showArchived, setShowArchived] = useState(false);
          const [filter, setFilter] = useState('');
          return (
            <section id="area4" className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 4: Seguimiento</h2>
              <div className="flex flex-wrap gap-4">
                <input type="text" placeholder="Filtrar seguimiento..." className="bg-surface border border-border-color rounded px-3 py-2 text-sm" onChange={e => setFilter(e.target.value)} />
                <button onClick={() => setShowArchived(!showArchived)} className="bg-gray-600 text-white font-bold py-2 px-4 rounded">{showArchived ? 'Ocultar' : 'Mostrar'} Archivados ({archivedData.length})</button>
                <button onClick={onExportComplementariedades} className="bg-green-600 text-white font-bold py-2 px-4 rounded">Exportar Reporte</button>
              </div>
              <h3 className="text-xl font-semibold">Casos Activos ({trackingData.length})</h3>
              <TrackingTable data={trackingData} isArchived={false} onUpdate={(i, r) => updateTrackingData(i, r, false)} onArchive={ids => archiveItems(ids, false)} filter={filter} />
              {showArchived && (
                <div className="mt-8">
                   <h3 className="text-xl font-semibold">Hist√≥rico Archivados</h3>
                   <TrackingTable data={archivedData} isArchived={true} onUpdate={(i, r) => updateTrackingData(i, r, true)} onArchive={ids => archiveItems(ids, true)} filter={filter} />
                </div>
              )}
            </section>
          );
        };

        const SetupModal = ({ onSave, initialUrl = '' }) => {
          const [url, setUrl] = useState(initialUrl);
          return (
            <div className="fixed inset-0 bg-background/90 flex justify-center items-center z-50 p-4">
              <div className="bg-surface p-8 rounded-xl border border-border-color max-w-lg w-full space-y-6">
                <h2 className="text-2xl font-bold text-primary text-center">Configuraci√≥n de Base de Datos</h2>
                <input type="url" value={url} onChange={e => setUrl(e.target.value)} placeholder="URL del Script de Google..." className="w-full bg-background border border-border-color rounded p-3" />
                <button onClick={() => onSave(url)} className="w-full bg-btn-primary py-3 rounded-lg font-bold">Verificar y Conectar</button>
              </div>
            </div>
          );
        };

        const PreviewModal = ({ data, template, onClose }) => {
          const body = template ? replacePlaceholders(template.body, data) : 'No se seleccion√≥ plantilla.';
          const full = body + COMMON_EMAIL_BODY + SIGNATURE;
          return (
            <div className="fixed inset-0 bg-black/70 flex justify-center items-center z-50 p-4">
              <div className="bg-surface rounded-xl max-w-3xl w-full flex flex-col max-h-[90vh]">
                <div className="p-4 border-b border-border-color flex justify-between">
                  <h3 className="text-lg font-bold">Vista Previa de Correo</h3>
                  <button onClick={onClose} className="text-2xl">&times;</button>
                </div>
                <div className="p-8 overflow-y-auto bg-white text-black font-serif text-sm" dangerouslySetInnerHTML={{ __html: full }} />
                <div className="p-4 bg-header flex justify-end gap-2 rounded-b-xl">
                  <button onClick={() => { navigator.clipboard.writeText(full.replace(/<[^>]+>/g, '')); alert("Texto copiado."); }} className="bg-btn-primary px-6 py-2 rounded font-bold">Copiar Texto</button>
                  <button onClick={onClose} className="bg-gray-600 px-6 py-2 rounded font-bold">Cerrar</button>
                </div>
              </div>
            </div>
          );
        };

        // --- COMPONENTE PRINCIPAL APP ---

        const App = () => {
          const [state, setState] = useState({
            finalData: [], trackingData: [], archivedData: [],
            portalData: Array(5).fill({}), pdfData: Array(5).fill({}),
            templates: [], scriptUrl: null,
            isSetupNeeded: false, isReconfiguring: false, isLoading: true,
            isSaving: false, isTemplateManagerOpen: false, previewData: null,
            notification: null, editsCount: 0, onlineStatus: true,
          });

          const showNotification = (message, type) => {
            setState(prev => ({ ...prev, notification: { message, type } }));
            setTimeout(() => setState(prev => ({ ...prev, notification: null })), 5000);
          };

          const handleSetScriptUrl = async (url) => {
            setState(prev => ({ ...prev, isLoading: true }));
            try {
              const data = await fetchData(url);
              localStorage.setItem('sigweb_scriptUrl', url);
              setState(prev => ({ ...prev, ...data, scriptUrl: url, isSetupNeeded: false, isReconfiguring: false, isLoading: false }));
              showNotification('Conectado con √©xito', 'success');
            } catch (e) {
              setState(prev => ({ ...prev, isLoading: false }));
              showNotification('Error de conexi√≥n con el script', 'error');
            }
          };

          useEffect(() => {
            const url = localStorage.getItem('sigweb_scriptUrl');
            setState(prev => ({ ...prev, templates: loadTemplates() }));
            if (url) handleSetScriptUrl(url); else setState(prev => ({ ...prev, isSetupNeeded: true, isLoading: false }));
          }, []);

          const processPortalData = () => {
            const processed = state.portalData
              .filter(r => String(r['N√öMERO ORDEN'] || '').trim() !== '' && String(r['N√öMERO ORDEN']).toUpperCase() !== 'N√öMERO ORDEN')
              .map(r => ({
                Fecha_Neg: r['FECHA NEGACI√ìN'] || '',
                No_Orden: r['N√öMERO ORDEN'] || '',
                No_Cedula: r['IDENTIFICACI√ìN AFILIADO'] || '',
                Nombre: capitalizeWords(r['NOMBRE AFILIADO'] || ''),
                EPS: String(r.EPS || '').toUpperCase(),
                Programa: r.PROGRAMA || '',
                Motivo_Negacion: r['MOTIVO NEGACI√ìN'] || '',
                Email: r.EMAIL || '',
                Descripcion_PDF: '(pendiente)', Justificacion_PDF: '(pendiente)', Fundamento_Legal_PDF: '(pendiente)',
                Tipo_Carta: '', Radicado_Comp: ''
              }));
            setState(prev => ({ ...prev, finalData: processed }));
            showNotification(`${processed.length} casos cargados para revisi√≥n`, 'success');
          };

          const mergePdfData = () => {
            const map = new Map();
            state.pdfData.filter(r => String(r['Archivo (No. Orden)'] || '').trim()).forEach(r => {
              map.set(String(r['Archivo (No. Orden)']).trim(), {
                Descripcion_PDF: r.Descripci√≥n || '', Justificacion_PDF: r.Justificaci√≥n || '', Fundamento_Legal_PDF: r['Fundamento Legal'] || ''
              });
            });
            const merged = state.finalData.map(r => {
              const match = map.get(String(r.No_Orden).trim());
              return match ? { ...r, ...match } : r;
            });
            setState(prev => ({ ...prev, finalData: merged }));
            showNotification('Datos de PDF combinados correctamente', 'success');
          };

          const handleSave = async () => {
            if (!state.scriptUrl) return;
            setState(prev => ({ ...prev, isSaving: true }));
            try {
              await saveData(state.scriptUrl, { finalData: state.finalData, trackingData: state.trackingData, archivedData: state.archivedData });
              setState(prev => ({ ...prev, isSaving: false, editsCount: 0 }));
              showNotification('Cambios guardados en la nube', 'success');
            } catch (e) {
              setState(prev => ({ ...prev, isSaving: false }));
              showNotification('Error al guardar datos', 'error');
            }
          };

          const handleSendToTracking = (orderIds) => {
             const toSend = state.finalData.filter(r => orderIds.includes(r.No_Orden) && r.Radicado_Comp);
             if (!toSend.length) { showNotification('Debes ingresar un n√∫mero de radicado', 'warning'); return; }
             const newTrack = [...state.trackingData];
             toSend.forEach(item => {
               if (!newTrack.find(t => t.No_Orden === item.No_Orden)) {
                 newTrack.push({ Fecha_Ing: item.Fecha_Neg, No_Orden: item.No_Orden, No_Cedula: item.No_Cedula, Nombre: item.Nombre, EPS: item.EPS, Radicado: item.Radicado_Comp, Estado: 'Pendiente' });
               }
             });
             setState(prev => ({ ...prev, trackingData: newTrack, finalData: prev.finalData.filter(f => !orderIds.includes(f.No_Orden)), editsCount: prev.editsCount + 1 }));
          };

          if (state.isLoading) return <div className="h-screen flex items-center justify-center bg-background text-white"><Spinner /><p className="ml-4">Cargando Sistema...</p></div>;
          if (state.isSetupNeeded || state.isReconfiguring) return <SetupModal onSave={handleSetScriptUrl} initialUrl={state.scriptUrl} />;

          return (
            <div className="p-4 sm:p-8 space-y-8 min-h-screen">
              {state.notification && <Notification {...state.notification} onClose={() => setState(p => ({...p, notification: null}))} />}
              <main className="bg-surface p-6 rounded-xl border border-border-color space-y-8">
                <Header onSave={handleSave} onManageTemplates={() => {}} onReconfigure={() => setState(p => ({ ...p, isReconfiguring: true }))} />
                <Dashboard reviewCount={state.finalData.length} trackingCount={state.trackingData.length} archivedCount={state.archivedData.length} editsCount={state.editsCount} />
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <DataInputArea title="√Årea 1: Datos Portal" headers={PORTAL_HEADERS} data={state.portalData} onDataChange={d => setState(p => ({...p, portalData: d}))} onProcess={processPortalData} />
                  <DataInputArea title="√Årea 2: Extractor PDF" headers={PDF_HEADERS} data={state.pdfData} onDataChange={d => setState(p => ({...p, pdfData: d}))} onProcess={mergePdfData} processButtonText="Combinar PDFs" />
                </div>

                <ReviewArea 
                  data={state.finalData} templates={state.templates} 
                  updateRow={(id, up) => setState(p => ({ ...p, finalData: p.finalData.map(r => r.No_Orden === id ? {...r, ...up} : r) }))}
                  incrementEdits={() => setState(p => ({...p, editsCount: p.editsCount + 1}))}
                  onSendToTracking={handleSendToTracking}
                  onPreview={r => setState(p => ({...p, previewData: r}))}
                  onExportForMailMerge={() => exportDetailedReport(state.finalData, [], [])}
                  onClearReviewData={() => setState(p => ({...p, finalData: []}))}
                />

                <TrackingArea 
                  trackingData={state.trackingData} archivedData={state.archivedData}
                  updateTrackingData={(i, r, isA) => {
                    const key = isA ? 'archivedData' : 'trackingData';
                    const list = [...state[key]]; list[i] = r;
                    setState(p => ({...p, [key]: list, editsCount: p.editsCount + 1}));
                  }}
                  archiveItems={(ids, isA) => {
                    const from = isA ? 'archivedData' : 'trackingData';
                    const to = isA ? 'trackingData' : 'archivedData';
                    const items = ids.map(i => state[from][i]);
                    setState(p => ({ ...p, [from]: p[from].filter((_, i) => !ids.includes(i)), [to]: [...p[to], ...items], editsCount: p.editsCount + 1 }));
                  }}
                  onExportComplementariedades={() => exportDetailedReport([], state.trackingData, state.archivedData)}
                />
              </main>
              {state.previewData && <PreviewModal data={state.previewData} template={state.templates.find(t => t.id === state.previewData.Tipo_Carta)} onClose={() => setState(p => ({...p, previewData: null}))} />}
              {state.isSaving && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><Spinner /><p className="ml-4">Sincronizando...</p></div>}
            </div>
          );
        };

        // CORRECCI√ìN 3: Ajuste del renderizado para React 18
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
