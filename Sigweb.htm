<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GESTION NEGACIONES EJE CAFETERO</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Tailwind CSS Configuration
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4e9fef',
              'background': '#1e1e1e',
              'surface': '#2d2d2d',
              'text-primary': '#d4d4d4',
              'text-secondary': '#a0a0a0',
              'border-color': '#444',
              'header': '#3a3a3a',
              'highlight': '#252526',
              'warning': '#6e550c',
              'archive': '#3a3a3a',
              'success': '#28a745',
              'danger': '#a02d2d',
              'danger-hover': '#c0392b',
              'btn-primary': '#0e639c',
              'btn-primary-hover': '#1a73e8',
            },
            animation: {
              'flash-success': 'flash-success 1s ease-out',
            },
            keyframes: {
              'flash-success': {
                'from': { backgroundColor: '#28a745' },
                'to': { backgroundColor: 'transparent' },
              }
            }
          }
        }
      }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://esm.sh/react@18.2.0"></script>
    <script src="https://esm.sh/react-dom@18.2.0/client"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    </head>
<body class="bg-background text-text-primary">
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
        // 3. CORRECCI√ìN: Se reemplazaron los 'import' por destructuraci√≥n de variables globales.
        // Esto es necesario ya que eliminamos el importmap y Babel Standalone inyecta 'React' y 'ReactDOM' globalmente.
        const { useState, useEffect, useCallback, useMemo } = React;
        const ReactDOMClient = ReactDOM; 
        
        // =================================================================================
        // INLINED: constants.ts
        // =================================================================================
        
        // --- Cabeceras del Portal (√Årea 1) ---
        const PORTAL_HEADERS = [
          "Fecha_Asignacion", "EJECUTIVO", "FECHA NEGACI√ìN", "REGIONAL", "N√öMERO ORDEN", 
          "TIPO DOCUMENTO", "IDENTIFICACI√ìN AFILIADO", "NOMBRE AFILIADO", "EDAD", 
          "PROCEDIMIENTO", "MOTIVO NEGACI√ìN", "PLAN", "PROGRAMA", "EPS", 
          "Fecha_Ingreso", "EMAIL", "CELULAR", "ESTADO"
        ];

        const PDF_HEADERS = [
          "Archivo (No. Orden)", "Descripci√≥n", "Justificaci√≥n", "Fundamento Legal", "C√≥digo"
        ];

        const TRACKING_STATUSES = ['Pendiente', 'En Gesti√≥n', 'Finalizado'];
        
        const COMMON_EMAIL_BODY = `<br><br><b>Si tiene alguna duda puede contactarse por medio de los canales que tenemos disponibles para usted:</b><br>¬∑ Nuestra l√≠nea nacional 018000931666. O con nuestras l√≠neas locales: Cali (602) 489 0073, Bogot√° (601) 743 5485, Medell√≠n (604) 604 4507, Barranquilla (605) 385 3165, Bucaramanga (607) 697 3350, Cartagena (605) 693 9853, Tulu√° (602) 235 9483, Valledupar (605)588 5699, Pereira (606) 340 2635.<br>¬∑ WhatsApp: 317-224-07-94<br><br>Gracias por su Atenci√≥n.`;
        const SIGNATURE = `<br><br>Cordialmente,<br><br><b>Juan Ricardo Morales Agudelo</b><br>Ejecutivo De Atenci√≥n Integral<br>Coomeva Medicina Prepagada<br>Cra. 13 No.11-12 Centro M√©dico Circunvalar<br>Coomeva Medicina Prepagada Pereira, Risaralda<br><br><i>Este correo es generado autom√°ticamente, por favor no responda este mensaje.</i>`;

        const defaultTemplates = [
            { id: 'tpl_neg_gen', name: 'PLANTILLA NEGACION GENERAL', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad no est√° aprobado debido a que corresponde a EXCLUSI√ìN ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El servicio negado anteriormente; debe tramitarlo a trav√©s su EPS asignada. Adjuntamos soporte de la carta de negaci√≥n.` },
            { id: 'tpl_neg_pert', name: 'PLANTILLA NO PERTINENCIA Y TEMAS ESTETICOS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad No est√° aprobado debido a que corresponde a NO PERTINENCIA ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>` },
            { id: 'tpl_comp_coinc', name: 'COMPLEMENTARIEDAD RED COINCIDENTE', body: `Apreciado Usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y el de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no fue aprobado, debido a que ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, est√° en gesti√≥n a trav√©s de su EPS ({{EPS}}) con el n√∫mero de radicado ({{Radicado_Comp}}), puede realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).<br><br>Adicional estaremos haciendo seguimiento al radicado y una vez se encuentre gestionado por la EPS, le notificaremos por medio de correo electr√≥nico.` },
            { id: 'tpl_comp_no_coinc', name: 'COMPLEMENTARIEDAD RED NO COINCIDENTE', body: `Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado, debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El prestador actual solicitado, no tiene convenio con la EPS, por lo que los costos adicionales del servicio o insumo estar√°n a cargo del paciente. Sin embargo; se radica la solicitud ante su EPS con el n√∫mero ({{Radicado_Comp}}) por favor realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).` },
            { id: 'tpl_comp_ayudas', name: 'COMPLEMENTARIEDAD AYUDAS DIAGNOSTICAS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, se encuentra en gesti√≥n a trav√©s de su EPS con el n√∫mero de radicado ({{Radicado_Comp}}), por favor realizar seguimiento mediante la oficina virtual. ({{Oficina_Virtual_EPS}}).` },
        ];


        // =================================================================================
        // INLINED: services/utilityService.ts
        // =================================================================================
        const capitalizeWords = (str) => {
          if (!str) return '';
          return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        };

        const processPastedData = (pastedText, headers) => {
          return pastedText
            .trim()
            .split(/\r?\n/)
            .map(rowText => {
              const cells = rowText.split('\t');
              const rowObject = {};
              headers.forEach((header, index) => {
                if (cells[index]) {
                  rowObject[header] = cells[index].trim();
                }
              });
              return rowObject;
            });
        };

        const replacePlaceholders = (templateBody, data) => {
          const getOficinaVirtual = (eps) => {
            const e = (eps || "").toUpperCase();
            if (e.includes("NUEVA EPS")) return `<a href='https://portal.nuevaeps.com.co/Portal/home.jspx' target='_blank' rel='noopener noreferrer'>NUEVA EPS</a>`;
            if (e.includes("SALUD TOTAL")) return `<a href='https://saludtotal.com.co/' target='_blank' rel='noopener noreferrer'>SALUD TOTAL</a>`;
            return eps;
          };

          const fullData = { ...data, Oficina_Virtual_EPS: getOficinaVirtual(data.EPS) };

          return templateBody.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return fullData[key] || match;
          });
        };

        const exportDetailedReport = (finalData, trackingData, archivedData) => {
          try {
            const masterDataMap = new Map();

            [...finalData, ...trackingData, ...archivedData].forEach(row => {
              // Ajuste de clave: Usamos 'N√öMERO ORDEN' ya que est√° en PORTAL_HEADERS, 
              // asumiendo que el proceso de pegado lo utiliza. Si tus datos internos usan 'No_Orden', 
              // el c√≥digo debe ser ajustado en esa l√≥gica. Por seguridad, usamos 'N√öMERO ORDEN'.
              const orderKey = row['N√öMERO ORDEN'] || row.No_Orden; 

              if (orderKey) {
                const key = orderKey.trim();
                const existing = masterDataMap.get(key) || {};
                masterDataMap.set(key, { ...existing, ...row });
              }
            });
            
            const masterData = Array.from(masterDataMap.values());

            if (masterData.length === 0) {
              alert("No hay datos consolidados para exportar.");
              return;
            }

            const wb = XLSX.utils.book_new();
            
            if (finalData.length > 0) {
              const ws1 = XLSX.utils.json_to_sheet(finalData);
              XLSX.utils.book_append_sheet(wb, ws1, "Casos en Revisi√≥n");
            }
            
            if (trackingData.length > 0) {
              const ws2 = XLSX.utils.json_to_sheet(trackingData);
              XLSX.utils.book_append_sheet(wb, ws2, "Seguimiento Activo");
            }

            if (archivedData.length > 0) {
              const ws3 = XLSX.utils.json_to_sheet(archivedData);
              XLSX.utils.book_append_sheet(wb, ws3, "Seguimiento Archivado");
            }
            
            const ws4 = XLSX.utils.json_to_sheet(masterData);
            XLSX.utils.book_append_sheet(wb, ws4, "Maestro Consolidado");

            XLSX.writeFile(wb, `Sigweb_Reporte_Detallado_${new Date().toISOString().slice(0, 10)}.xlsx`);
          } catch (error) {
            console.error("Fall√≥ la exportaci√≥n del reporte Excel:", error);
            alert("Ocurri√≥ un error al generar el reporte.");
          }
        };

        // =================================================================================
        // INLINED: services/templateService.ts
        // =================================================================================
        const TEMPLATE_STORAGE_KEY = 'sigweb_emailTemplates';

        const loadTemplates = () => {
          try {
            const storedTemplates = localStorage.getItem(TEMPLATE_STORAGE_KEY);
            if (storedTemplates) {
              const parsed = JSON.parse(storedTemplates);
              if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].id && parsed[0].name) {
                return parsed;
              }
            }
          } catch (error) {
            console.error("Fall√≥ la carga de plantillas desde localStorage, se usar√°n las predeterminadas.", error);
            localStorage.removeItem(TEMPLATE_STORAGE_KEY);
          }
          return defaultTemplates;
        };

        const saveTemplates = (templates) => {
          try {
            localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
          } catch (error) {
            console.error("Fall√≥ el guardado de plantillas en localStorage", error);
          }
        };


        // =================================================================================
        // INLINED: services/googleSheetService.ts
        // =================================================================================
        const fetchData = async (url) => {
            const response = await fetch(`${url}?action=getData`);
            if (!response.ok) {
                throw new Error('La respuesta de la red no fue correcta');
            }
            const data = await response.json();
            return {
                finalData: data.finalData || [],
                trackingData: data.trackingData || [],
                archivedData: data.archivedData || [],
            };
        };

        const saveData = async (url, data) => {
            const response = await fetch(url, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(data),
            });
            
            return { status: 'success', message: 'Datos enviados al servidor.' };
        };


        // =================================================================================
        // INLINED: components/Spinner.tsx
        // =================================================================================
        const Spinner = () => {
          return (
            <div
              className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
              role="status"
            >
              <span className="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">
                Cargando...
              </span>
            </div>
          );
        };


        // =================================================================================
        // INLINED: components/Notification.tsx
        // =================================================================================
        const Notification = ({ message, type, onClose }) => {
          const typeClasses = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            warning: 'bg-yellow-500',
            info: 'bg-blue-600',
          };
          return (
            <div className={`fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white ${typeClasses[type]} flex items-center gap-4`}>
              <span>{message}</span>
              <button onClick={onClose} className="text-xl font-bold">&times;</button>
            </div>
          );
        };

        // =================================================================================
        // INLINED: components/Header.tsx
        // =================================================================================
        const Header = ({ onSave, onManageTemplates, onReconfigure }) => {
          return (
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-border-color">
              <div>
                <h1 className="text-3xl font-bold text-white">
                  GESTION NEGACIONES EJE CAFETERO
                </h1>
                <p className="text-text-secondary">Sistema Integrado de Gesti√≥n de Flujos de Trabajo</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onManageTemplates} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  Gestionar Plantillas
                </button>
                <button onClick={onReconfigure} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8.21 5.15a1.5 1.5 0 01-1.25.82l-2.09.28c-1.68.23-2.34 2.26-1.09 3.42l1.52 1.48a1.5 1.5 0 01-.42 2.1l-1.83 1.25c-1.38.94-.92 3.01.7 3.42l2.05.51a1.5 1.5 0 011.1.98l.8 2.07c.43 1.12 2.29 1.12 2.72 0l.8-2.07a1.5 1.5 0 011.1-.98l2.05-.51c1.62-.4 2.08-2.48.7-3.42l-1.83-1.25a1.5 1.5 0 01-.42-2.1l1.52-1.48c1.25-1.16.59-3.19-1.09-3.42L13 5.97a1.5 1.5 0 01-1.25-.82l-.3-1.98zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" />
                  </svg>
                  Reconfigurar Conexi√≥n
                </button>
                <button onClick={onSave} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M5.5 16.5a2.5 2.5 0 01-5 0V4.414a1.5 1.5 0 01.44-1.06L4.354.439A1.5 1.5 0 015.414 0H12.5a2.5 2.5 0 012.5 2.5v2" />
                      <path d="M5.5 16.5h8a2.5 2.5 0 002.5-2.5V8.5h-13v5.5a2.5 2.5 0 002.5 2.5z" />
                      <path d="M10.5 10a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" />
                  </svg>
                  Guardar en la Nube
                </button>
              </div>
            </header>
          );
        };
        

        // =================================================================================
        // INLINED: components/Dashboard.tsx
        // =================================================================================
        const DashboardCard = ({ title, value, icon }) => (
          <div className="bg-surface p-4 rounded-lg border border-border-color flex items-center">
            <div className="text-3xl text-primary mr-4">{icon}</div>
            <div>
              <h4 className="text-sm font-semibold text-text-secondary uppercase tracking-wider">{title}</h4>
              <p className="text-2xl font-bold text-text-primary">{value}</p>
            </div>
          </div>
        );

        const Dashboard = ({ reviewCount, trackingCount, archivedCount, editsCount }) => (
          <section id="dashboard" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <DashboardCard title="Casos en Revisi√≥n" value={reviewCount} icon={'üìã'} />
            <DashboardCard title="Seguimiento Activo" value={trackingCount} icon={'‚è≥'} />
            <DashboardCard title="Casos Archivados" value={archivedCount} icon={'üóÑÔ∏è'} />
            <DashboardCard title="Ediciones en Sesi√≥n" value={editsCount} icon={'‚úèÔ∏è'} />
          </section>
        );


        // =================================================================================
        // INLINED: components/DataInputArea.tsx
        // =================================================================================
        function DataInputArea({
          id,
          title,
          headers,
          data,
          onDataChange,
          onProcess,
          processButtonText = "Procesar Datos",
        }) {
          
          const handlePaste = useCallback((e) => {
            e.preventDefault();
            const pastedText = e.clipboardData.getData('text/plain');
            const newRows = processPastedData(pastedText, headers);

            const updatedData = [...data.filter(row => Object.values(row).some(val => val)), ...newRows];
            
            const emptyRowCount = updatedData.filter(row => !Object.values(row).some(val => val)).length;
            if (emptyRowCount < 5) {
                for (let i = 0; i < (5 - emptyRowCount); i++) {
                    updatedData.push({});
                }
            }

            onDataChange(updatedData);
          }, [data, headers, onDataChange]);

          const handleCellChange = (rowIndex, header, value) => {
            const newData = [...data];
            newData[rowIndex] = { ...newData[rowIndex], [header]: value };
            
            const emptyRowCount = newData.filter(row => !Object.values(row).some(val => val)).length;
            if (emptyRowCount < 5) {
                newData.push({});
            }

            onDataChange(newData);
          };
          
          const clearTable = () => {
            onDataChange(Array(5).fill({}));
          }

          return (
            <section id={id} className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">{title}</h2>
              <div className="table-container max-h-72 overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      {headers.map(header => (
                        <th key={header} scope="col" className="px-4 py-3 whitespace-nowrap">{header}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody onPaste={handlePaste}>
                    {data.map((row, rowIndex) => (
                      <tr key={rowIndex} className="border-b border-border-color hover:bg-highlight">
                        {headers.map(header => (
                          <td
                            key={`${rowIndex}-${header}`}
                            className="px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none"
                            contentEditable
                            onBlur={(e) => handleCellChange(rowIndex, header, e.currentTarget.innerText)}
                            suppressContentEditableWarning={true}
                          >
                            {row[header] || ''}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="flex gap-4">
                <button onClick={onProcess} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  {processButtonText}
                </button>
                <button onClick={clearTable} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  Limpiar Tabla
                </button>
              </div>
            </section>
          );
        }

        // =================================================================================
        // INLINED: components/ReviewArea.tsx
        // =================================================================================
        // Columnas de √Årea 3 (como en la versi√≥n anterior)
        const ReviewArea = ({
          data,
          templates,
          updateRow,
          incrementEdits,
          onSendToTracking,
          onPreview,
          onExportForMailMerge,
          onClearReviewData,
          sortConfig,
          setSortConfig,
        }) => {
          const [selectedRows, setSelectedRows] = useState(new Set());
          const [filter, setFilter] = useState('');
          
          // Columnas exactas solicitadas por el usuario
          const REVIEW_HEADERS = [
              { key: 'Fecha_Neg', label: 'Fecha de Negaci√≥n' },
              { key: 'No_Orden', label: 'N√∫mero de Orden' },
              { key: 'No_Cedula', label: 'N√∫mero de C√©dula' },
              { key: 'Nombre', label: 'Nombre Afiliado' },
              { key: 'EPS', label: 'EPS' },
              { key: 'Programa', label: 'Programa', compact: true },
              { key: 'Motivo_Negacion', label: 'Motivo Neg', compact: true },
              { key: 'Descripcion_PDF', label: 'Descripci√≥n', compact: true },
              { key: 'Justificacion_PDF', label: 'Justificaci√≥n', compact: true },
              { key: 'Fundamento_Legal_PDF', label: 'Fund. Legal', compact: true },
          ];

          const filteredData = useMemo(() => {
            if (!filter) return data;
            const lowercasedFilter = filter.toLowerCase();
            return data.filter(row =>
              Object.values(row).some(value =>
                String(value).toLowerCase().includes(lowercasedFilter)
              )
            );
          }, [data, filter]);

          const handleSelectRow = (noOrden) => {
            const newSelection = new Set(selectedRows);
            if (newSelection.has(noOrden)) {
              newSelection.delete(noOrden);
            } else {
              newSelection.add(noOrden);
            }
            setSelectedRows(newSelection);
          };

          const handleSelectAll = (e) => {
            if (e.target.checked) {
              const allOrderNumbers = filteredData.map(row => row.No_Orden);
              setSelectedRows(new Set(allOrderNumbers));
            } else {
              setSelectedRows(new Set());
            }
          };

          const handleCellBlur = (noOrden, key, value) => {
            const originalRow = data.find(r => r.No_Orden === noOrden);
            if (originalRow && originalRow[key] !== value) {
              updateRow(noOrden, { [key]: value });
              incrementEdits();
            }
          };
          
          const handleSelectChange = (noOrden, value) => {
            const changes = { Tipo_Carta: value };
            const template = templates.find(t => t.id === value);
            if (!template || !template.name.toUpperCase().includes('COMPLEMENTARIEDAD')) {
                changes.Radicado_Comp = '';
            }
            updateRow(noOrden, changes);
            incrementEdits();
          };

          const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                direction = 'descending';
            }
            setSortConfig({ key, direction });
          };
          
          const getSortIndicator = (key) => {
            if (sortConfig.key !== key) return null;
            return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
          };

          return (
            <section id="area3" className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 3: Revisi√≥n Final y Exportaci√≥n</h2>
              <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input
                  type="text"
                  placeholder="Buscar en tabla de revisi√≥n..."
                  className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                  value={filter}
                  onChange={(e) => setFilter(e.target.value)}
                />
                <span className="text-text-primary">{selectedRows.size} fila(s) seleccionada(s)</span>
              </div>

              <div className="table-container max-h-[700px] overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary table-auto">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      <th className="px-4 py-3"><input type="checkbox" onChange={handleSelectAll} checked={selectedRows.size === filteredData.length && filteredData.length > 0} /></th>
                      <th className="px-4 py-3">üëÅÔ∏è</th>
                        {REVIEW_HEADERS.map(({ key, label, compact }) => (
                          <th key={key} onClick={() => requestSort(key)} className={`px-4 py-3 cursor-pointer ${compact ? 'max-w-[150px]' : ''}`}>
                              {label}{getSortIndicator(key)}
                          </th>
                        ))}
                      <th className="px-4 py-3">Tipo de Carta</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((row, rowIndex) => {
                      const template = templates.find(t => t.id === row.Tipo_Carta);
                      const isComplementariedad = template && template.name.toUpperCase().includes('COMPLEMENTARIEDAD');
                      const requiresRadicado = isComplementariedad;
                      
                      const rowKey = `${row.No_Orden || 'new'}-${rowIndex}`;

                      return (
                        <tr key={rowKey} className={`border-b border-border-color hover:bg-highlight ${isComplementariedad ? 'bg-indigo-900/50' : ''}`}>
                          <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(row.No_Orden)} onChange={() => handleSelectRow(row.No_Orden)} /></td>
                          <td className="px-4 py-2 text-lg cursor-pointer" onClick={() => onPreview(row)}>üëÅÔ∏è</td>
                          
                          {REVIEW_HEADERS.map(({ key, compact }) => (
                            <td key={`${rowKey}-${key}`}
                                className={`px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none ${compact ? 'max-w-[150px] overflow-hidden text-ellipsis whitespace-nowrap' : ''}`}
                                contentEditable
                                onBlur={(e) => handleCellBlur(row.No_Orden, key, e.currentTarget.innerText)}
                                suppressContentEditableWarning={true}
                            >
                                {row[key]}
                            </td>
                          ))}

                          <td className="px-4 py-2">
                            <div className="flex flex-col gap-1">
                              <select 
                                value={row.Tipo_Carta || ''}
                                onChange={(e) => handleSelectChange(row.No_Orden, e.target.value)}
                                className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full"
                              >
                                <option value="">-- Seleccionar --</option>
                                {templates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                              </select>
                              {requiresRadicado && (
                                <input
                                  type="text"
                                  placeholder="Radicado..."
                                  value={row.Radicado_Comp || ''}
                                  onChange={(e) => {
                                      updateRow(row.No_Orden, { Radicado_Comp: e.target.value });
                                      incrementEdits();
                                    }}
                                  className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full mt-1"
                                />
                              )}
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              <div className="flex flex-wrap gap-4">
                <button 
                    onClick={() => onSendToTracking(Array.from(selectedRows))}
                    className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Enviar a Seguimiento
                </button>
                <button 
                    onClick={() => onExportForMailMerge(data)}
                    className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Exportar para Correo Masivo
                </button>
                <button 
                    onClick={onClearReviewData}
                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Limpiar √Årea de Revisi√≥n
                </button>
              </div>
            </section>
          );
        };
        // =================================================================================
        // FIN DEL C√ìDIGO PROPORCIONADO - CONTIN√öA EL C√ìDIGO PRINCIPAL ABAJO.
        // =================================================================================


        // =================================================================================
        // INLINED: components/TrackingArea.tsx
        // =================================================================================
        // Asumiendo que esta es la siguiente parte de tu c√≥digo (L√≠nea 1400+)
        const TrackingArea = ({
          data,
          updateRow,
          incrementEdits,
          onSendToArchive,
          onSendToReview,
          onExportDetailedReport,
          sortConfig,
          setSortConfig,
          archivedData // Recibimos data de archivo para el reporte detallado
        }) => {
          const [filter, setFilter] = useState('');
          const [selectedRows, setSelectedRows] = useState(new Set());

          const TRACKING_HEADERS = [
              { key: 'Fecha_Neg', label: 'Fecha Neg' },
              { key: 'No_Orden', label: 'Orden' },
              { key: 'Nombre', label: 'Afiliado' },
              { key: 'EPS', label: 'EPS', compact: true },
              { key: 'Tipo_Carta', label: 'Carta', compact: true },
              { key: 'Radicado_Comp', label: 'Radicado', compact: true },
              { key: 'Estado_Seguimiento', label: 'Estado', isStatus: true },
              { key: 'Notas_Seguimiento', label: 'Notas' },
          ];

          const sortedFilteredData = useMemo(() => {
            let currentData = data;
            
            // 1. Filtrado
            if (filter) {
                const lowercasedFilter = filter.toLowerCase();
                currentData = data.filter(row =>
                  Object.values(row).some(value =>
                    String(value).toLowerCase().includes(lowercasedFilter)
                  )
                );
            }

            // 2. Ordenamiento
            if (sortConfig.key) {
                currentData = [...currentData].sort((a, b) => {
                    const aValue = String(a[sortConfig.key] || "").toLowerCase();
                    const bValue = String(b[sortConfig.key] || "").toLowerCase();

                    if (aValue < bValue) {
                        return sortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                        return sortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }

            return currentData;
          }, [data, filter, sortConfig]);


          const handleSelectRow = (noOrden) => {
            const newSelection = new Set(selectedRows);
            if (newSelection.has(noOrden)) {
              newSelection.delete(noOrden);
            } else {
              newSelection.add(noOrden);
            }
            setSelectedRows(newSelection);
          };

          const handleSelectAll = (e) => {
            if (e.target.checked) {
              const allOrderNumbers = sortedFilteredData.map(row => row.No_Orden);
              setSelectedRows(new Set(allOrderNumbers));
            } else {
              setSelectedRows(new Set());
            }
          };

          const handleCellBlur = (noOrden, key, value) => {
            const originalRow = data.find(r => r.No_Orden === noOrden);
            if (originalRow && originalRow[key] !== value) {
              updateRow(noOrden, { [key]: value });
              incrementEdits();
            }
          };
          
          const handleStatusChange = (noOrden, value) => {
            updateRow(noOrden, { Estado_Seguimiento: value });
            incrementEdits();
          };

          const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                direction = 'descending';
            }
            setSortConfig({ key, direction });
          };
          
          const getSortIndicator = (key) => {
            if (sortConfig.key !== key) return null;
            return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
          };
          
          const getStatusClass = (status) => {
            switch (status) {
                case 'Finalizado': return 'bg-success text-white';
                case 'En Gesti√≥n': return 'bg-warning text-gray-900';
                default: return 'bg-surface text-text-primary';
            }
          };

          const selectedData = Array.from(selectedRows).map(noOrden => 
            data.find(row => row.No_Orden === noOrden)
          ).filter(row => row);

          return (
            <section id="area4" className="space-y-4 pt-8">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 4: Seguimiento y Archivo</h2>
              
              <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input
                  type="text"
                  placeholder="Buscar en tabla de seguimiento..."
                  className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                  value={filter}
                  onChange={(e) => setFilter(e.target.value)}
                />
                <span className="text-text-primary">{selectedRows.size} fila(s) seleccionada(s)</span>
                
                <button
                    onClick={() => onSendToArchive(Array.from(selectedRows))}
                    className="bg-archive hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Archivar Seleccionados
                </button>
                 <button
                    onClick={() => onSendToReview(Array.from(selectedRows))}
                    className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Mover a Revisi√≥n
                </button>
                <button
                    onClick={() => exportDetailedReport(data, archivedData, data)} // Pasa los datos necesarios para consolidar
                    className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Exportar Reporte Maestro
                </button>
              </div>

              <div className="table-container max-h-[700px] overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary table-auto">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      <th className="px-4 py-3"><input type="checkbox" onChange={handleSelectAll} checked={selectedRows.size === sortedFilteredData.length && sortedFilteredData.length > 0} /></th>
                        {TRACKING_HEADERS.map(({ key, label, compact }) => (
                          <th key={key} onClick={() => requestSort(key)} className={`px-4 py-3 cursor-pointer ${compact ? 'max-w-[150px]' : ''}`}>
                              {label}{getSortIndicator(key)}
                          </th>
                        ))}
                    </tr>
                  </thead>
                  <tbody>
                    {sortedFilteredData.map((row, rowIndex) => {
                      const rowKey = `${row.No_Orden || 'new'}-${rowIndex}`;

                      return (
                        <tr key={rowKey} className={`border-b border-border-color hover:bg-highlight`}>
                          <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(row.No_Orden)} onChange={() => handleSelectRow(row.No_Orden)} /></td>
                          
                          {TRACKING_HEADERS.map(({ key, compact, isStatus }) => (
                            <td key={`${rowKey}-${key}`}
                                className={`px-4 py-2 border-r border-border-color ${compact ? 'max-w-[150px] overflow-hidden text-ellipsis whitespace-nowrap' : ''}`}
                            >
                                {isStatus ? (
                                    <select
                                        value={row.Estado_Seguimiento || 'Pendiente'}
                                        onChange={(e) => handleStatusChange(row.No_Orden, e.target.value)}
                                        className={`px-2 py-1 rounded-md border border-border-color w-full ${getStatusClass(row.Estado_Seguimiento)}`}
                                    >
                                        {TRACKING_STATUSES.map(status => (
                                            <option key={status} value={status}>{status}</option>
                                        ))}
                                    </select>
                                ) : (
                                    <span
                                      className="focus:bg-primary focus:text-black outline-none block"
                                      contentEditable={key === 'Notas_Seguimiento' || key === 'Radicado_Comp'}
                                      onBlur={(e) => handleCellBlur(row.No_Orden, key, e.currentTarget.innerText)}
                                      suppressContentEditableWarning={true}
                                    >
                                        {row[key]}
                                    </span>
                                )}
                            </td>
                          ))}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </section>
          );
        };

        // =================================================================================
        // INLINED: components/TemplateManager.tsx
        // =================================================================================
        const TemplateManager = ({ templates, onSaveTemplates, onClose }) => {
            const [localTemplates, setLocalTemplates] = useState(templates);
            const [newTemplate, setNewTemplate] = useState({ id: '', name: '', body: '' });
            const [selectedTemplateId, setSelectedTemplateId] = useState(templates[0]?.id || '');

            useEffect(() => {
                // Sincronizar al abrir si hubo cambios externos
                setLocalTemplates(templates);
                if (selectedTemplateId && !templates.find(t => t.id === selectedTemplateId)) {
                    setSelectedTemplateId(templates[0]?.id || '');
                }
            }, [templates]);

            const selectedTemplate = localTemplates.find(t => t.id === selectedTemplateId);

            const handleTemplateChange = (field, value) => {
                if (!selectedTemplate) return;
                setLocalTemplates(prev => prev.map(t => 
                    t.id === selectedTemplateId ? { ...t, [field]: value } : t
                ));
            };

            const handleNewTemplateChange = (field, value) => {
                setNewTemplate(prev => ({ ...prev, [field]: value }));
            };

            const addTemplate = () => {
                if (!newTemplate.id || !newTemplate.name) return alert('ID y Nombre son obligatorios.');
                if (localTemplates.some(t => t.id === newTemplate.id)) return alert('Ya existe una plantilla con ese ID.');

                setLocalTemplates(prev => [...prev, newTemplate]);
                setNewTemplate({ id: '', name: '', body: '' });
                setSelectedTemplateId(newTemplate.id);
            };

            const deleteTemplate = () => {
                if (localTemplates.length <= defaultTemplates.length) {
                    return alert('No puedes eliminar plantillas predeterminadas.');
                }
                if (!confirm(`¬øEst√° seguro de eliminar la plantilla "${selectedTemplate.name}"?`)) return;

                setLocalTemplates(prev => prev.filter(t => t.id !== selectedTemplateId));
                setSelectedTemplateId(localTemplates.filter(t => t.id !== selectedTemplateId)[0]?.id || '');
            };

            const handleSave = () => {
                // Las plantillas predeterminadas no deben ser modificadas en su ID
                const isValid = localTemplates.every(t => {
                    if (defaultTemplates.find(dt => dt.id === t.id)) {
                        return t.id.startsWith('tpl_'); // Regla simple para IDs predeterminados
                    }
                    return true;
                });

                if (!isValid) return alert('Error: Las plantillas predeterminadas han sido modificadas o tienen IDs inv√°lidos.');

                onSaveTemplates(localTemplates);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4">
                    <div className="bg-surface p-6 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b border-border-color pb-2">Gestor de Plantillas de Correo</h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {/* Columna de Selecci√≥n */}
                            <div className="space-y-4">
                                <h4 className="text-xl font-semibold text-text-primary">Seleccionar Plantilla</h4>
                                <select 
                                    value={selectedTemplateId}
                                    onChange={(e) => setSelectedTemplateId(e.target.value)}
                                    className="bg-background border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                                >
                                    {localTemplates.map(t => (
                                        <option key={t.id} value={t.id}>{t.name}</option>
                                    ))}
                                </select>
                                
                                {selectedTemplate && !defaultTemplates.find(t => t.id === selectedTemplate.id) && (
                                    <button 
                                        onClick={deleteTemplate} 
                                        className="bg-danger hover:bg-danger-hover text-white font-bold py-2 px-4 rounded-lg w-full transition-colors"
                                    >
                                        Eliminar Plantilla
                                    </button>
                                )}
                            </div>

                            {/* Columna de Edici√≥n */}
                            <div className="md:col-span-2 space-y-4">
                                <h4 className="text-xl font-semibold text-text-primary">Editar Plantilla Seleccionada</h4>
                                {selectedTemplate ? (
                                    <div className="space-y-3">
                                        <label className="block text-sm font-medium">Nombre:</label>
                                        <input 
                                            type="text"
                                            value={selectedTemplate.name}
                                            onChange={(e) => handleTemplateChange('name', e.target.value)}
                                            className="bg-background border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                                        />
                                        <label className="block text-sm font-medium">Cuerpo del Correo (HTML permitido y Placeholders `{{CLAVE}}`):</label>
                                        <textarea
                                            value={selectedTemplate.body}
                                            onChange={(e) => handleTemplateChange('body', e.target.value)}
                                            rows="10"
                                            className="bg-background border border-border-color rounded-md px-3 py-2 text-text-primary w-full font-mono text-xs"
                                        ></textarea>
                                        
                                        <p className="text-xs text-text-secondary">Placeholders disponibles: `{{No_Orden}}`, `{{Nombre}}`, `{{EPS}}`, `{{Motivo_Negacion}}`, `{{Descripcion_PDF}}`, `{{Justificacion_PDF}}`, `{{Fundamento_Legal_PDF}}`, `{{Radicado_Comp}}`, etc. Se agregar√° la firma y el cuerpo com√∫n autom√°ticamente.</p>

                                    </div>
                                ) : (
                                    <p className="text-text-secondary">Seleccione una plantilla para editar.</p>
                                )}
                            </div>
                        </div>

                        <div className="mt-8 border-t border-border-color pt-4">
                            <h4 className="text-xl font-semibold text-text-primary mb-4">A√±adir Nueva Plantilla</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium">ID √önico (Ej: `tpl_nuevo`):</label>
                                    <input 
                                        type="text"
                                        value={newTemplate.id}
                                        onChange={(e) => handleNewTemplateChange('id', e.target.value.replace(/[^a-z0-9_]/g, ''))} // Limpia caracteres
                                        className="bg-background border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium">Nombre:</label>
                                    <input 
                                        type="text"
                                        value={newTemplate.name}
                                        onChange={(e) => handleNewTemplateChange('name', e.target.value)}
                                        className="bg-background border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                                    />
                                </div>
                                <div className="flex items-end">
                                    <button onClick={addTemplate} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full transition-colors">
                                        A√±adir
                                    </button>
                                </div>
                            </div>
                            <div className="mt-4">
                                <label className="block text-sm font-medium">Cuerpo (se guardar√° aqu√≠ si a√±ades):</label>
                                <textarea
                                    value={newTemplate.body}
                                    onChange={(e) => handleNewTemplateChange('body', e.target.value)}
                                    rows="3"
                                    placeholder="Cuerpo de la nueva plantilla..."
                                    className="bg-background border border-border-color rounded-md px-3 py-2 text-text-primary w-full font-mono text-xs"
                                ></textarea>
                            </div>
                        </div>


                        <div className="flex justify-end gap-4 mt-6">
                            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                Cerrar
                            </button>
                            <button onClick={handleSave} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                Guardar Cambios y Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // =================================================================================
        // INLINED: components/Modals.tsx (Email Preview)
        // =================================================================================
        const EmailPreviewModal = ({ rowData, template, onClose }) => {
            if (!rowData || !template) return null;

            const emailSubject = `Respuesta a Solicitud No. ${rowData.No_Orden || rowData['N√öMERO ORDEN']}`;
            const customizedBody = replacePlaceholders(template.body, rowData);
            const fullBody = customizedBody + COMMON_EMAIL_BODY + SIGNATURE;

            const createMailtoLink = () => {
                const recipient = rowData.EMAIL || '';
                const subject = encodeURIComponent(emailSubject);
                const body = encodeURIComponent(fullBody.replace(/<br>/g, '\n').replace(/<\/?[a-z][^>]*>/gi, '')); 
                return `mailto:${recipient}?subject=${subject}&body=${body}`;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4">
                    <div className="bg-surface p-6 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b border-border-color pb-2">Vista Previa de Correo Electr√≥nico</h3>
                        
                        <div className="space-y-4">
                            <p className="text-sm">**Asunto:** {emailSubject}</p>
                            <div className="border border-border-color p-4 rounded-lg bg-background space-y-2">
                                <h4 className="text-lg font-semibold text-text-primary">Cuerpo del Mensaje:</h4>
                                <div className="text-sm text-text-secondary" dangerouslySetInnerHTML={{ __html: fullBody }} />
                            </div>
                        </div>
                        
                        <div className="flex justify-end gap-4 mt-6">
                            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                Cerrar Vista Previa
                            </button>
                            <a 
                                href={createMailtoLink()} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                                Abrir en Outlook/Mail
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================================
        // INLINED: components/Modals.tsx (Config Modal)
        // =================================================================================
        const URL_STORAGE_KEY = 'sigweb_googleSheetUrl';
        const loadUrl = () => localStorage.getItem(URL_STORAGE_KEY) || '';
        const saveUrl = (url) => localStorage.setItem(URL_STORAGE_KEY, url);

        const ConfigModal = ({ onClose, onSuccess }) => {
            const [url, setUrl] = useState(loadUrl());

            const handleSave = () => {
                if (!url.trim()) {
                    alert('La URL del Script de Google Apps es obligatoria.');
                    return;
                }
                saveUrl(url.trim());
                onSuccess(url.trim());
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4">
                    <div className="bg-surface p-6 rounded-lg w-full max-w-md">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b border-border-color pb-2">Configuraci√≥n de Conexi√≥n</h3>
                        
                        <div className="space-y-4">
                            <p className="text-text-secondary">Introduce la URL del Script de Google Apps (API) para guardar y cargar datos de las hojas de c√°lculo.</p>
                            <label className="block text-sm font-medium">URL de Despliegue del Script:</label>
                            <input 
                                type="url"
                                value={url}
                                onChange={(e) => setUrl(e.target.value)}
                                placeholder="https://script.google.com/macros/s/..."
                                className="bg-background border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                            />
                        </div>

                        <div className="flex justify-end gap-4 mt-6">
                            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                Cerrar
                            </button>
                            <button onClick={handleSave} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                Guardar URL
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // =================================================================================
        // INLINED: SigwebApp.tsx (Main Application Component)
        // =================================================================================
        function SigwebApp() {
            const [portalData, setPortalData] = useState(Array(5).fill({}));
            const [pdfData, setPdfData] = useState(Array(5).fill({}));
            const [reviewData, setReviewData] = useState([]); // Casos en revisi√≥n (√Årea 3)
            const [trackingData, setTrackingData] = useState([]); // Casos en seguimiento (√Årea 4)
            const [archivedData, setArchivedData] = useState([]); // Casos archivados (Solo para reporte)
            const [isSaving, setIsSaving] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [notification, setNotification] = useState(null);
            const [editsCount, setEditsCount] = useState(0);
            const [templates, setTemplates] = useState(loadTemplates);
            const [showTemplateManager, setShowTemplateManager] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [googleSheetUrl, setGoogleSheetUrl] = useState(loadUrl());
            const [previewRow, setPreviewRow] = useState(null);
            const [reviewSortConfig, setReviewSortConfig] = useState({ key: 'Fecha_Neg', direction: 'descending' });
            const [trackingSortConfig, setTrackingSortConfig] = useState({ key: 'Fecha_Neg', direction: 'descending' });

            // --- Efectos y Configuraci√≥n Inicial ---
            useEffect(() => {
                if (!googleSheetUrl) {
                    setShowConfigModal(true);
                    return;
                }
                loadDataFromSheet();
            }, [googleSheetUrl]);

            // --- Helper Functions ---
            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 5000);
            };

            const incrementEdits = () => setEditsCount(prev => prev + 1);

            const sortData = (data, sortConfig) => {
                if (!sortConfig.key) return data;
                
                return [...data].sort((a, b) => {
                    const aValue = String(a[sortConfig.key] || "").toLowerCase();
                    const bValue = String(b[sortConfig.key] || "").toLowerCase();

                    if (aValue < bValue) {
                        return sortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                        return sortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            };

            // --- L√≥gica de Procesamiento y Carga de Datos ---
            const loadDataFromSheet = async () => {
                if (!googleSheetUrl) return;
                setIsLoading(true);
                setEditsCount(0);
                try {
                    const { finalData, trackingData, archivedData } = await fetchData(googleSheetUrl);
                    setReviewData(finalData);
                    setTrackingData(trackingData);
                    setArchivedData(archivedData);
                    showNotification('Datos cargados correctamente desde Google Sheets.', 'success');
                } catch (error) {
                    console.error('Error al cargar datos:', error);
                    showNotification('Error al cargar datos. Revisa la URL de conexi√≥n.', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const processData = () => {
                const validPortalRows = portalData.filter(row => row['N√öMERO ORDEN']);
                const validPdfRows = pdfData.filter(row => row['Archivo (No. Orden)']);

                if (validPortalRows.length === 0) {
                    return showNotification('No hay datos v√°lidos en el √Årea 1 (Portal).', 'warning');
                }

                if (validPdfRows.length === 0) {
                    return showNotification('No hay datos v√°lidos en el √Årea 2 (PDF).', 'warning');
                }

                const newReviewData = [...reviewData];

                validPortalRows.forEach(pRow => {
                    const orderNumber = pRow['N√öMERO ORDEN'] ? pRow['N√öMERO ORDEN'].trim() : null;
                    if (!orderNumber) return;

                    const existingRow = newReviewData.find(r => r.No_Orden === orderNumber);

                    // 1. Encontrar datos de PDF que coincidan con el No. de Orden
                    const matchingPdfRow = validPdfRows.find(pdfRow => {
                        const pdfOrderNumber = pdfRow['Archivo (No. Orden)'].trim();
                        return pdfOrderNumber.includes(orderNumber);
                    });
                    
                    // 2. Mapear datos
                    const mappedRow = {
                        Fecha_Asignacion: pRow.Fecha_Asignacion,
                        EJECUTIVO: pRow.EJECUTIVO,
                        Fecha_Neg: pRow['FECHA NEGACI√ìN'], // Usamos la clave limpia para consistencia
                        REGIONAL: pRow.REGIONAL,
                        No_Orden: orderNumber, // Clave √∫nica para manejo interno
                        No_Cedula: pRow['IDENTIFICACI√ìN AFILIADO'],
                        Nombre: capitalizeWords(pRow['NOMBRE AFILIADO']),
                        EDAD: pRow.EDAD,
                        PROCEDIMIENTO: pRow.PROCEDIMIENTO,
                        Motivo_Negacion: pRow['MOTIVO NEGACI√ìN'],
                        PLAN: pRow.PLAN,
                        PROGRAMA: pRow.PROGRAMA,
                        EPS: pRow.EPS,
                        Fecha_Ingreso: pRow.Fecha_Ingreso,
                        EMAIL: pRow.EMAIL,
                        CELULAR: pRow.CELULAR,
                        ESTADO_PORTAL: pRow.ESTADO, // Estado inicial del portal

                        // Campos de PDF
                        Descripcion_PDF: matchingPdfRow ? matchingPdfRow.Descripci√≥n : '',
                        Justificacion_PDF: matchingPdfRow ? matchingPdfRow.Justificaci√≥n : '',
                        Fundamento_Legal_PDF: matchingPdfRow ? matchingPdfRow['Fundamento Legal'] : '',
                        
                        // Campos de Gesti√≥n
                        Tipo_Carta: existingRow ? existingRow.Tipo_Carta : '', 
                        Radicado_Comp: existingRow ? existingRow.Radicado_Comp : '', // Conserva radicado si existe
                    };

                    // 3. Agregar/Actualizar en √Årea de Revisi√≥n
                    if (existingRow) {
                        // Actualiza el existente (ej. si cambian los datos del portal/pdf)
                        Object.assign(existingRow, mappedRow);
                        incrementEdits();
                    } else {
                        // Agrega nuevo caso
                        newReviewData.push(mappedRow);
                    }
                });

                setReviewData(sortData(newReviewData, reviewSortConfig));
                setPortalData(Array(5).fill({}));
                setPdfData(Array(5).fill({}));
                showNotification(`Se procesaron ${validPortalRows.length} caso(s).`, 'success');
            };

            // --- L√≥gica de Movimiento y Archivo ---

            const updateReviewRow = useCallback((noOrden, updates) => {
                setReviewData(prev => prev.map(row => {
                    if (row.No_Orden === noOrden) {
                        return { ...row, ...updates };
                    }
                    return row;
                }));
            }, []);

            const updateTrackingRow = useCallback((noOrden, updates) => {
                setTrackingData(prev => prev.map(row => {
                    if (row.No_Orden === noOrden) {
                        return { ...row, ...updates };
                    }
                    return row;
                }));
            }, []);

            const sendToTracking = (selectedOrders) => {
                if (selectedOrders.length === 0) return showNotification('Selecciona al menos una fila.', 'warning');

                const rowsToMove = reviewData.filter(row => selectedOrders.includes(row.No_Orden));
                
                // Validaci√≥n para campos obligatorios
                const invalidRows = rowsToMove.filter(row => 
                    !row.Tipo_Carta || (
                        row.Tipo_Carta.includes('comp') && (!row.Radicado_Comp || row.Radicado_Comp.length < 5)
                    )
                );

                if (invalidRows.length > 0) {
                    return showNotification('Error: Hay filas seleccionadas sin Tipo de Carta o con Radicado Complementariedad incompleto.', 'error');
                }

                setReviewData(prev => prev.filter(row => !selectedOrders.includes(row.No_Orden)));
                
                const newTrackingRows = rowsToMove.map(row => ({
                    ...row,
                    Estado_Seguimiento: 'Pendiente', // Estado inicial en seguimiento
                    Notas_Seguimiento: row.Notas_Seguimiento || '',
                    Fecha_Movimiento_Tracking: new Date().toISOString().slice(0, 10),
                }));
                
                setTrackingData(prev => sortData([...prev, ...newTrackingRows], trackingSortConfig));
                setEditsCount(prev => prev + rowsToMove.length);
                showNotification(`Movidos ${rowsToMove.length} casos a Seguimiento.`, 'info');
            };

            const sendToArchive = (selectedOrders) => {
                if (selectedOrders.length === 0) return showNotification('Selecciona al menos una fila.', 'warning');

                const rowsToMove = trackingData.filter(row => selectedOrders.includes(row.No_Orden));

                setTrackingData(prev => prev.filter(row => !selectedOrders.includes(row.No_Orden)));
                
                const newArchivedRows = rowsToMove.map(row => ({
                    ...row,
                    Fecha_Archivo: new Date().toISOString().slice(0, 10),
                }));

                setArchivedData(prev => [...prev, ...newArchivedRows]);
                setEditsCount(prev => prev + rowsToMove.length);
                showNotification(`Archivados ${rowsToMove.length} casos.`, 'info');
            };

            const sendToReview = (selectedOrders) => {
                 if (selectedOrders.length === 0) return showNotification('Selecciona al menos una fila.', 'warning');

                const rowsToMove = trackingData.filter(row => selectedOrders.includes(row.No_Orden));

                setTrackingData(prev => prev.filter(row => !selectedOrders.includes(row.No_Orden)));
                
                const newReviewRows = rowsToMove.map(row => {
                    const { Estado_Seguimiento, Notas_Seguimiento, Fecha_Movimiento_Tracking, ...rest } = row;
                    return rest; // Quita los campos de seguimiento
                });

                setReviewData(prev => sortData([...prev, ...newReviewRows], reviewSortConfig));
                setEditsCount(prev => prev + rowsToMove.length);
                showNotification(`Movidos ${rowsToMove.length} casos de vuelta a Revisi√≥n.`, 'warning');
            };

            // --- Guardar en Google Sheets ---
            const saveToSheet = async () => {
                if (!googleSheetUrl) {
                    showConfigModal(true);
                    return;
                }
                if (editsCount === 0) {
                    return showNotification('No hay cambios pendientes para guardar.', 'info');
                }

                setIsSaving(true);
                try {
                    const dataToSave = {
                        reviewData,
                        trackingData,
                        archivedData
                    };

                    // Aqu√≠ se llama a la funci√≥n de Google Apps Script para guardar los datos
                    await saveData(googleSheetUrl, dataToSave);
                    
                    setEditsCount(0);
                    showNotification('Todos los cambios han sido guardados en la nube.', 'success');
                } catch (error) {
                    console.error('Error al guardar datos:', error);
                    showNotification('Error al guardar. Revisa la consola y la configuraci√≥n de tu Script.', 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            // --- L√≥gica de Plantillas y Correo ---
            const handleSaveTemplates = (newTemplates) => {
                saveTemplates(newTemplates);
                setTemplates(newTemplates);
                showNotification('Plantillas guardadas correctamente.', 'success');
            };

            const handlePreview = (row) => {
                const template = templates.find(t => t.id === row.Tipo_Carta);
                if (!template) {
                    return showNotification('Selecciona un Tipo de Carta para previsualizar.', 'warning');
                }
                setPreviewRow({ row, template });
            };

            const handleExportForMailMerge = (dataToExport) => {
                if (dataToExport.length === 0) return showNotification('No hay datos en el √Årea de Revisi√≥n para exportar.', 'warning');
                
                try {
                    const exportData = dataToExport
                        .filter(row => row.Tipo_Carta) // Solo exporta las que tienen plantilla seleccionada
                        .map(row => {
                            const template = templates.find(t => t.id === row.Tipo_Carta);
                            const customizedBody = replacePlaceholders(template.body, row);

                            return {
                                No_Orden: row.No_Orden,
                                Email: row.EMAIL,
                                Asunto: `Respuesta a Solicitud No. ${row.No_Orden}`,
                                Cuerpo_Correo: customizedBody + COMMON_EMAIL_BODY + SIGNATURE,
                                Tipo_Carta: template.name,
                                EPS: row.EPS,
                                Radicado: row.Radicado_Comp || '',
                            };
                        });

                    if (exportData.length === 0) {
                        return showNotification('Ninguna fila tiene un "Tipo de Carta" seleccionado para exportar.', 'warning');
                    }

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    XLSX.utils.book_append_sheet(wb, ws, "MailMerge_Export");
                    XLSX.writeFile(wb, `Sigweb_MailMerge_Export_${new Date().toISOString().slice(0, 10)}.xlsx`);
                    showNotification(`Exportadas ${exportData.length} filas para Correo Masivo.`, 'success');
                } catch (error) {
                    console.error('Error al exportar para Mail Merge:', error);
                    showNotification('Ocurri√≥ un error al generar el archivo de exportaci√≥n.', 'error');
                }
            };

            // --- Renderizaci√≥n Principal ---
            return (
                <div className="p-6 space-y-8 min-h-screen">
                    {/* Modales */}
                    {showConfigModal && (
                        <ConfigModal 
                            onClose={() => setShowConfigModal(false)}
                            onSuccess={setGoogleSheetUrl}
                        />
                    )}
                    {showTemplateManager && (
                        <TemplateManager 
                            templates={templates} 
                            onSaveTemplates={handleSaveTemplates}
                            onClose={() => setShowTemplateManager(false)}
                        />
                    )}
                    {previewRow && (
                        <EmailPreviewModal 
                            rowData={previewRow.row}
                            template={previewRow.template}
                            onClose={() => setPreviewRow(null)}
                        />
                    )}

                    {/* Notificaci√≥n */}
                    {notification && (
                        <Notification 
                            message={notification.message}
                            type={notification.type}
                            onClose={() => setNotification(null)}
                        />
                    )}
                    
                    {/* Encabezado y Guardado */}
                    <Header 
                        onSave={saveToSheet} 
                        onManageTemplates={() => setShowTemplateManager(true)}
                        onReconfigure={() => setShowConfigModal(true)}
                    />

                    {/* Dashboard */}
                    <Dashboard
                        reviewCount={reviewData.length}
                        trackingCount={trackingData.length}
                        archivedCount={archivedData.length}
                        editsCount={editsCount}
                    />

                    {/* Contenido Principal */}
                    {isLoading || isSaving ? (
                        <div className="flex justify-center items-center py-10">
                            <Spinner />
                            <span className="ml-3 text-lg">{isSaving ? 'Guardando datos...' : 'Cargando datos...'}</span>
                        </div>
                    ) : (
                        <main className="space-y-8">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                {/* √Årea 1: Datos del Portal (Entrada) */}
                                <DataInputArea
                                    id="area1"
                                    title="√Årea 1: Pegar Datos del Portal"
                                    headers={PORTAL_HEADERS}
                                    data={portalData}
                                    onDataChange={setPortalData}
                                    onProcess={processData}
                                    processButtonText="Procesar Datos (Combinar con PDF)"
                                />

                                {/* √Årea 2: Datos del PDF (Entrada) */}
                                <DataInputArea
                                    id="area2"
                                    title="√Årea 2: Pegar Datos de la Carta de Negaci√≥n (PDF)"
                                    headers={PDF_HEADERS}
                                    data={pdfData}
                                    onDataChange={setPdfData}
                                    onProcess={processData}
                                    processButtonText="Procesar Datos (Combinar con Portal)"
                                />
                            </div>

                            {/* √Årea 3: Revisi√≥n Final */}
                            <ReviewArea
                                data={sortData(reviewData, reviewSortConfig)}
                                templates={templates}
                                updateRow={updateReviewRow}
                                incrementEdits={incrementEdits}
                                onSendToTracking={sendToTracking}
                                onPreview={handlePreview}
                                onExportForMailMerge={handleExportForMailMerge}
                                onClearReviewData={() => setReviewData([])}
                                sortConfig={reviewSortConfig}
                                setSortConfig={setReviewSortConfig}
                            />

                            {/* √Årea 4: Seguimiento */}
                            <TrackingArea
                                data={sortData(trackingData, trackingSortConfig)}
                                updateRow={updateTrackingRow}
                                incrementEdits={incrementEdits}
                                onSendToArchive={sendToArchive}
                                onSendToReview={sendToReview}
                                onExportDetailedReport={() => exportDetailedReport(reviewData, trackingData, archivedData)}
                                sortConfig={trackingSortConfig}
                                setSortConfig={setTrackingSortConfig}
                                archivedData={archivedData}
                            />

                            {/* √Årea de Archivo - Solo para visualizaci√≥n (Opcional, pero se mantiene la l√≥gica) */}
                            <section id="area5" className="space-y-4 pt-8">
                                <h2 className="text-2xl font-bold text-text-secondary border-b border-border-color pb-2">Casos Archivados ({archivedData.length})</h2>
                                <p className="text-sm text-text-secondary">Los casos archivados solo se muestran en el Reporte Maestro (√Årea 4).</p>
                            </section>

                        </main>
                    )}
                </div>
            );
        }

        // --- Renderizaci√≥n de la Aplicaci√≥n (React) ---
        // Usamos createRoot de ReactDOMClient (React 18)
        const rootElement = document.getElementById('root');
        if (rootElement) {
            ReactDOMClient.createRoot(rootElement).render(<SigwebApp />);
        }

    </script>
</body>
</html>
