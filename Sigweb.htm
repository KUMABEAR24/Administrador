<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GESTION NEGACIONES EJE CAFETERO</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4e9fef',
                        'background': '#1e1e1e',
                        'surface': '#2d2d2d',
                        'text-primary': '#d4d4d4',
                        'text-secondary': '#a0a0a0',
                        'border-color': '#444',
                        'header': '#3a3a3a',
                        'highlight': '#252526',
                        'warning': '#6e550c',
                        'archive': '#3a3a3a',
                        'success': '#28a745',
                        'danger': '#a02d2d',
                        'danger-hover': '#c0392b',
                        'btn-primary': '#0e639c',
                        'btn-primary-hover': '#1a73e8',
                    },
                    animation: {
                        'flash-success': 'flash-success 1s ease-out',
                    },
                    keyframes: {
                        'flash-success': {
                            'from': { backgroundColor: '#28a745' },
                            'to': { backgroundColor: 'transparent' },
                        }
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

</head>
<body class="bg-background text-text-primary">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        // 3. CORRECCI√ìN: La destructuraci√≥n de 'React' y 'ReactDOM' funcionar√° correctamente ahora.
        const { useState, useEffect, useCallback, useMemo } = React;
        const ReactDOMClient = ReactDOM; 
        
        // =================================================================================
        // INLINED: constants.ts
        // =================================================================================
        
        // --- Cabeceras del Portal (√Årea 1) ---
        const PORTAL_HEADERS = [
          "Fecha_Asignacion", "EJECUTIVO", "FECHA NEGACI√ìN", "REGIONAL", "N√öMERO ORDEN", 
          "TIPO DOCUMENTO", "IDENTIFICACI√ìN AFILIADO", "NOMBRE AFILIADO", "EDAD", 
          "PROCEDIMIENTO", "MOTIVO NEGACI√ìN", "PLAN", "PROGRAMA", "EPS", 
          "Fecha_Ingreso", "EMAIL", "CELULAR", "ESTADO"
        ];

        const PDF_HEADERS = [
          "Archivo (No. Orden)", "Descripci√≥n", "Justificaci√≥n", "Fundamento Legal", "C√≥digo"
        ];

        const TRACKING_STATUSES = ['Pendiente', 'En Gesti√≥n', 'Finalizado'];
        
        const COMMON_EMAIL_BODY = `<br><br><b>Si tiene alguna duda puede contactarse por medio de los canales que tenemos disponibles para usted:</b><br>¬∑ Nuestra l√≠nea nacional 018000931666. O con nuestras l√≠neas locales: Cali (602) 489 0073, Bogot√° (601) 743 5485, Medell√≠n (604) 604 4507, Barranquilla (605) 385 3165, Bucaramanga (607) 697 3350, Cartagena (605) 693 9853, Tulu√° (602) 235 9483, Valledupar (605)588 5699, Pereira (606) 340 2635.<br>¬∑ WhatsApp: 317-224-07-94<br><br>Gracias por su Atenci√≥n.`;
        const SIGNATURE = `<br><br>Cordialmente,<br><br><b>Juan Ricardo Morales Agudelo</b><br>Ejecutivo De Atenci√≥n Integral<br>Coomeva Medicina Prepagada<br>Cra. 13 No.11-12 Centro M√©dico Circunvalar<br>Coomeva Medicina Prepagada Pereira, Risaralda<br><br><i>Este correo es generado autom√°ticamente, por favor no responda este mensaje.</i>`;

        const defaultTemplates = [
            { id: 'tpl_neg_gen', name: 'PLANTILLA NEGACION GENERAL', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad no est√° aprobado debido a que corresponde a EXCLUSI√ìN ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El servicio negado anteriormente; debe tramitarlo a trav√©s su EPS asignada. Adjuntamos soporte de la carta de negaci√≥n.` },
            { id: 'tpl_neg_pert', name: 'PLANTILLA NO PERTINENCIA Y TEMAS ESTETICOS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad No est√° aprobado debido a que corresponde a NO PERTINENCIA ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>` },
            { id: 'tpl_comp_coinc', name: 'COMPLEMENTARIEDAD RED COINCIDENTE', body: `Apreciado Usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y el de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no fue aprobado, debido a que ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, est√° en gesti√≥n a trav√©s de su EPS ({{EPS}}) con el n√∫mero de radicado ({{Radicado_Comp}}), puede realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).<br><br>Adicional estaremos haciendo seguimiento al radicado y una vez se encuentre gestionado por la EPS, le notificaremos por medio de correo electr√≥nico.` },
            { id: 'tpl_comp_no_coinc', name: 'COMPLEMENTARIEDAD RED NO COINCIDENTE', body: `Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado, debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El prestador actual solicitado, no tiene convenio con la EPS, por lo que los costos adicionales del servicio o insumo estar√°n a cargo del paciente. Sin embargo; se radica la solicitud ante su EPS con el n√∫mero ({{Radicado_Comp}}) por favor realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).` },
            { id: 'tpl_comp_ayudas', name: 'COMPLEMENTARIEDAD AYUDAS DIAGNOSTICAS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, se encuentra en gesti√≥n a trav√©s de su EPS con el n√∫mero de radicado ({{Radicado_Comp}}), por favor realizar seguimiento mediante la oficina virtual. ({{Oficina_Virtual_EPS}}).` },
        ];


        // =================================================================================
        // INLINED: services/utilityService.ts
        // =================================================================================
        const capitalizeWords = (str) => {
          if (!str) return '';
          return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        };

        const processPastedData = (pastedText, headers) => {
          return pastedText
            .trim()
            .split(/\r?\n/)
            .map(rowText => {
              const cells = rowText.split('\t');
              const rowObject = {};
              headers.forEach((header, index) => {
                if (cells[index]) {
                  rowObject[header] = cells[index].trim();
                }
              });
              return rowObject;
            });
        };

        const replacePlaceholders = (templateBody, data) => {
          const getOficinaVirtual = (eps) => {
            const e = (eps || "").toUpperCase();
            if (e.includes("NUEVA EPS")) return `<a href='https://portal.nuevaeps.com.co/Portal/home.jspx' target='_blank' rel='noopener noreferrer'>NUEVA EPS</a>`;
            if (e.includes("SALUD TOTAL")) return `<a href='https://saludtotal.com.co/' target='_blank' rel='noopener noreferrer'>SALUD TOTAL</a>`;
            return eps;
          };

          const fullData = { ...data, Oficina_Virtual_EPS: getOficinaVirtual(data.EPS) };

          return templateBody.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return fullData[key] || match;
          });
        };

        const exportDetailedReport = (finalData, trackingData, archivedData) => {
          try {
            const masterDataMap = new Map();

            [...finalData, ...trackingData, ...archivedData].forEach(row => {
              // Ajuste de clave: Usamos 'N√öMERO ORDEN' ya que est√° en PORTAL_HEADERS, 
              // asumiendo que el proceso de pegado lo utiliza. Si tus datos internos usan 'No_Orden', 
              // el c√≥digo debe ser ajustado en esa l√≥gica. Por seguridad, usamos 'N√öMERO ORDEN'.
              const orderKey = row['N√öMERO ORDEN'] || row.No_Orden; 

              if (orderKey) {
                const key = orderKey.trim();
                const existing = masterDataMap.get(key) || {};
                masterDataMap.set(key, { ...existing, ...row });
              }
            });
            
            const masterData = Array.from(masterDataMap.values());

            if (masterData.length === 0) {
              alert("No hay datos consolidados para exportar.");
              return;
            }

            const wb = XLSX.utils.book_new();
            
            if (finalData.length > 0) {
              const ws1 = XLSX.utils.json_to_sheet(finalData);
              XLSX.utils.book_append_sheet(wb, ws1, "Casos en Revisi√≥n");
            }
            
            if (trackingData.length > 0) {
              const ws2 = XLSX.utils.json_to_sheet(trackingData);
              XLSX.utils.book_append_sheet(wb, ws2, "Seguimiento Activo");
            }

            if (archivedData.length > 0) {
              const ws3 = XLSX.utils.json_to_sheet(archivedData);
              XLSX.utils.book_append_sheet(wb, ws3, "Seguimiento Archivado");
            }
            
            const ws4 = XLSX.utils.json_to_sheet(masterData);
            XLSX.utils.book_append_sheet(wb, ws4, "Maestro Consolidado");

            XLSX.writeFile(wb, `Sigweb_Reporte_Detallado_${new Date().toISOString().slice(0, 10)}.xlsx`);
          } catch (error) {
            console.error("Fall√≥ la exportaci√≥n del reporte Excel:", error);
            alert("Ocurri√≥ un error al generar el reporte.");
          }
        };

        // =================================================================================
        // INLINED: services/templateService.ts
        // =================================================================================
        const TEMPLATE_STORAGE_KEY = 'sigweb_emailTemplates';

        const loadTemplates = () => {
          try {
            const storedTemplates = localStorage.getItem(TEMPLATE_STORAGE_KEY);
            if (storedTemplates) {
              const parsed = JSON.parse(storedTemplates);
              if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].id && parsed[0].name) {
                return parsed;
              }
            }
          } catch (error) {
            console.error("Fall√≥ la carga de plantillas desde localStorage, se usar√°n las predeterminadas.", error);
            localStorage.removeItem(TEMPLATE_STORAGE_KEY);
          }
          return defaultTemplates;
        };

        const saveTemplates = (templates) => {
          try {
            localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
          } catch (error) {
            console.error("Fall√≥ el guardado de plantillas en localStorage", error);
          }
        };


        // =================================================================================
        // INLINED: services/googleSheetService.ts
        // =================================================================================
        const fetchData = async (url) => {
            const response = await fetch(`${url}?action=getData`);
            if (!response.ok) {
                throw new Error('La respuesta de la red no fue correcta');
            }
            const data = await response.json();
            return {
                finalData: data.finalData || [],
                trackingData: data.trackingData || [],
                archivedData: data.archivedData || [],
            };
        };

        const saveData = async (url, data) => {
            const response = await fetch(url, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(data),
            });
            
            return { status: 'success', message: 'Datos enviados al servidor.' };
        };


        // =================================================================================
        // INLINED: components/Spinner.tsx
        // =================================================================================
        const Spinner = () => {
          return (
            <div
              className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
              role="status"
            >
              <span className="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">
                Cargando...
              </span>
            </div>
          );
        };


        // =================================================================================
        // INLINED: components/Notification.tsx
        // =================================================================================
        const Notification = ({ message, type, onClose }) => {
          const typeClasses = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            warning: 'bg-yellow-500',
            info: 'bg-blue-600',
          };
          // useEffect para cerrar autom√°ticamente
          useEffect(() => {
              if (message) {
                  const timer = setTimeout(() => {
                      onClose();
                  }, 5000); // 5 segundos
                  return () => clearTimeout(timer);
              }
          }, [message, onClose]);
          
          if (!message) return null;

          return (
            <div className={`fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white ${typeClasses[type]} flex items-center gap-4 transition-opacity duration-300`}>
              <span>{message}</span>
              <button onClick={onClose} className="text-xl font-bold hover:text-gray-200">&times;</button>
            </div>
          );
        };

        // =================================================================================
        // INLINED: components/Header.tsx
        // =================================================================================
        const Header = ({ onSave, onManageTemplates, onReconfigure }) => {
          return (
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-border-color">
              <div>
                <h1 className="text-3xl font-bold text-white">
                  GESTION NEGACIONES EJE CAFETERO
                </h1>
                <p className="text-text-secondary">Sistema Integrado de Gesti√≥n de Flujos de Trabajo</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onManageTemplates} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  Gestionar Plantillas
                </button>
                <button onClick={onReconfigure} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8.21 5.15a1.5 1.5 0 01-1.25.82l-2.09.28c-1.68.23-2.34 2.26-1.09 3.42l1.52 1.48a1.5 1.5 0 01-.42 2.1l-1.83 1.25c-1.38.94-.92 3.01.7 3.42l2.05.51a1.5 1.5 0 011.1.98l.8 2.07c.43 1.12 2.29 1.12 2.72 0l.8-2.07a1.5 1.5 0 011.1-.98l2.05-.51c1.62-.4 2.08-2.48.7-3.42l-1.83-1.25a1.5 1.5 0 01-.42-2.1l1.52-1.48c1.25-1.16.59-3.19-1.09-3.42L13 5.97a1.5 1.5 0 01-1.25-.82l-.3-1.98zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" />
                  </svg>
                  Reconfigurar Conexi√≥n
                </button>
                <button onClick={onSave} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M5.5 16.5a2.5 2.5 0 01-5 0V4.414a1.5 1.5 0 01.44-1.06L4.354.439A1.5 1.5 0 015.414 0H12.5a2.5 2.5 0 012.5 2.5v2" />
                      <path d="M5.5 16.5h8a2.5 2.5 0 002.5-2.5V8.5h-13v5.5a2.5 2.5 0 002.5 2.5z" />
                      <path d="M10.5 10a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" />
                  </svg>
                  Guardar en la Nube
                </button>
              </div>
            </header>
          );
        };
        

        // =================================================================================
        // INLINED: components/Dashboard.tsx
        // =================================================================================
        const DashboardCard = ({ title, value, icon }) => (
          <div className="bg-surface p-4 rounded-lg border border-border-color flex items-center">
            <div className="text-3xl text-primary mr-4">{icon}</div>
            <div>
              <h4 className="text-sm font-semibold text-text-secondary uppercase tracking-wider">{title}</h4>
              <p className="text-2xl font-bold text-text-primary">{value}</p>
            </div>
          </div>
        );

        const Dashboard = ({ reviewCount, trackingCount, archivedCount, editsCount }) => (
          <section id="dashboard" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <DashboardCard title="Casos en Revisi√≥n" value={reviewCount} icon={'üìã'} />
            <DashboardCard title="Seguimiento Activo" value={trackingCount} icon={'‚è≥'} />
            <DashboardCard title="Casos Archivados" value={archivedCount} icon={'üóÑÔ∏è'} />
            <DashboardCard title="Ediciones en Sesi√≥n" value={editsCount} icon={'‚úèÔ∏è'} />
          </section>
        );


        // =================================================================================
        // INLINED: components/DataInputArea.tsx
        // =================================================================================
        function DataInputArea({
          id,
          title,
          headers,
          data,
          onDataChange,
          onProcess,
          processButtonText = "Procesar Datos",
        }) {
          
          const handlePaste = useCallback((e) => {
            e.preventDefault();
            const pastedText = e.clipboardData.getData('text/plain');
            const newRows = processPastedData(pastedText, headers);

            const updatedData = [...data.filter(row => Object.values(row).some(val => val)), ...newRows];
            
            // Asegurar que haya al menos 5 filas vac√≠as al final si se pega contenido
            const emptyRowCount = updatedData.filter(row => !Object.values(row).some(val => val)).length;
            if (emptyRowCount < 5) {
                for (let i = 0; i < (5 - emptyRowCount); i++) {
                    updatedData.push({});
                }
            }

            onDataChange(updatedData);
          }, [data, headers, onDataChange]);

          const handleCellChange = (rowIndex, header, value) => {
            const newData = [...data];
            newData[rowIndex] = { ...newData[rowIndex], [header]: value };
            
            // Asegurar que haya al menos 5 filas vac√≠as
            const emptyRowCount = newData.filter(row => !Object.values(row).some(val => val)).length;
            if (emptyRowCount < 5) {
                newData.push({});
            }

            onDataChange(newData);
          };
          
          const clearTable = () => {
            onDataChange(Array(5).fill({}));
          }

          return (
            <section id={id} className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">{title}</h2>
              <div className="table-container max-h-72 overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      {headers.map(header => (
                        <th key={header} scope="col" className="px-4 py-3 whitespace-nowrap">{header}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody onPaste={handlePaste}>
                    {data.map((row, rowIndex) => (
                      <tr key={rowIndex} className="border-b border-border-color hover:bg-highlight">
                        {headers.map(header => (
                          <td
                            key={`${rowIndex}-${header}`}
                            className="px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none"
                            contentEditable
                            onBlur={(e) => handleCellChange(rowIndex, header, e.currentTarget.innerText)}
                            suppressContentEditableWarning={true}
                          >
                            {row[header] || ''}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="flex gap-4">
                <button onClick={onProcess} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  {processButtonText}
                </button>
                <button onClick={clearTable} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  Limpiar Tabla
                </button>
              </div>
            </section>
          );
        }

        // =================================================================================
        // INLINED: components/ReviewArea.tsx
        // =================================================================================
        // Columnas de √Årea 3 (como en la versi√≥n anterior)
        const ReviewArea = ({
          data,
          templates,
          updateRow,
          incrementEdits,
          onSendToTracking,
          onPreview,
          onExportForMailMerge,
          onClearReviewData,
          sortConfig,
          setSortConfig,
        }) => {
          const [selectedRows, setSelectedRows] = useState(new Set());
          const [filter, setFilter] = useState('');
          
          // Columnas exactas solicitadas por el usuario
          const REVIEW_HEADERS = [
              { key: 'Fecha_Neg', label: 'Fecha de Negaci√≥n' },
              { key: 'No_Orden', label: 'N√∫mero de Orden' },
              { key: 'No_Cedula', label: 'N√∫mero de C√©dula' },
              { key: 'Nombre', label: 'Nombre Afiliado' },
              { key: 'EPS', label: 'EPS' },
              { key: 'Programa', label: 'Programa', compact: true },
              { key: 'Motivo_Negacion', label: 'Motivo Neg', compact: true },
              { key: 'Descripcion_PDF', label: 'Descripci√≥n', compact: true },
              { key: 'Justificacion_PDF', label: 'Justificaci√≥n', compact: true },
              { key: 'Fundamento_Legal_PDF', label: 'Fund. Legal', compact: true },
          ];

          // L√≥gica de ordenamiento
          const sortedData = useMemo(() => {
              let sortableData = [...data];
              if (sortConfig.key) {
                  sortableData.sort((a, b) => {
                      const aValue = a[sortConfig.key] || '';
                      const bValue = b[sortConfig.key] || '';
                      if (aValue < bValue) {
                          return sortConfig.direction === 'ascending' ? -1 : 1;
                      }
                      if (aValue > bValue) {
                          return sortConfig.direction === 'ascending' ? 1 : -1;
                      }
                      return 0;
                  });
              }
              return sortableData;
          }, [data, sortConfig]);


          const filteredData = useMemo(() => {
            const currentData = sortedData;
            if (!filter) return currentData;
            const lowercasedFilter = filter.toLowerCase();
            return currentData.filter(row =>
              Object.values(row).some(value =>
                String(value).toLowerCase().includes(lowercasedFilter)
              )
            );
          }, [sortedData, filter]);

          const handleSelectRow = (noOrden) => {
            const newSelection = new Set(selectedRows);
            if (newSelection.has(noOrden)) {
              newSelection.delete(noOrden);
            } else {
              newSelection.add(noOrden);
            }
            setSelectedRows(newSelection);
          };

          const handleSelectAll = (e) => {
            if (e.target.checked) {
              const allOrderNumbers = filteredData.map(row => row.No_Orden).filter(Boolean); // Filtrar valores nulos/vac√≠os
              setSelectedRows(new Set(allOrderNumbers));
            } else {
              setSelectedRows(new Set());
            }
          };

          const handleCellBlur = (noOrden, key, value) => {
            const originalRow = data.find(r => r.No_Orden === noOrden);
            if (originalRow && originalRow[key] !== value) {
              updateRow(noOrden, { [key]: value });
              incrementEdits();
            }
          };
          
          const handleSelectChange = (noOrden, value) => {
            const changes = { Tipo_Carta: value };
            const template = templates.find(t => t.id === value);
            if (!template || !template.name.toUpperCase().includes('COMPLEMENTARIEDAD')) {
                changes.Radicado_Comp = '';
            }
            updateRow(noOrden, changes);
            incrementEdits();
          };

          const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                direction = 'descending';
            }
            setSortConfig({ key, direction });
          };
          
          const getSortIndicator = (key) => {
            if (sortConfig.key !== key) return null;
            return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
          };

          return (
            <section id="area3" className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 3: Revisi√≥n Final y Exportaci√≥n</h2>
              <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input
                  type="text"
                  placeholder="Buscar en tabla de revisi√≥n..."
                  className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                  value={filter}
                  onChange={(e) => setFilter(e.target.value)}
                />
                <span className="text-text-primary">{selectedRows.size} fila(s) seleccionada(s)</span>
                <button
                    onClick={() => onExportForMailMerge(Array.from(selectedRows))}
                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors ml-auto"
                    disabled={selectedRows.size === 0}
                >
                    Exportar para Mail Merge ({selectedRows.size})
                </button>
                <button
                    onClick={() => onSendToTracking(Array.from(selectedRows))}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                    disabled={selectedRows.size === 0}
                >
                    Mover a Seguimiento ({selectedRows.size})
                </button>
                 <button
                    onClick={onClearReviewData}
                    className="bg-danger hover:bg-danger-hover text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Limpiar √Årea
                </button>
              </div>

              <div className="table-container max-h-[700px] overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary table-auto">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      <th className="px-4 py-3"><input type="checkbox" onChange={handleSelectAll} checked={selectedRows.size === filteredData.length && filteredData.length > 0} /></th>
                      <th className="px-4 py-3">üëÅÔ∏è</th>
                        {REVIEW_HEADERS.map(({ key, label, compact }) => (
                          <th key={key} onClick={() => requestSort(key)} className={`px-4 py-3 cursor-pointer ${compact ? 'max-w-[150px]' : ''}`}>
                              {label}{getSortIndicator(key)}
                          </th>
                        ))}
                      <th className="px-4 py-3">Tipo de Carta</th>
                      <th className="px-4 py-3">Archivar</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((row, rowIndex) => {
                      const template = templates.find(t => t.id === row.Tipo_Carta);
                      const isComplementariedad = template && template.name.toUpperCase().includes('COMPLEMENTARIEDAD');
                      const requiresRadicado = isComplementariedad;
                      
                      const rowKey = `${row.No_Orden || 'new'}-${rowIndex}`;

                      return (
                        <tr key={rowKey} className={`border-b border-border-color ${row.isEdited ? 'animate-flash-success' : 'hover:bg-highlight'} ${isComplementariedad ? 'bg-indigo-900/50' : ''}`}>
                          <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(row.No_Orden)} onChange={() => handleSelectRow(row.No_Orden)} /></td>
                          <td className="px-4 py-2 text-lg cursor-pointer" onClick={() => onPreview(row)}>üëÅÔ∏è</td>
                          
                          {REVIEW_HEADERS.map(({ key, compact }) => (
                            <td key={`${rowKey}-${key}`}
                                className={`px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none ${compact ? 'max-w-[150px] overflow-hidden text-ellipsis whitespace-nowrap' : ''}`}
                                contentEditable={key !== 'No_Orden' && key !== 'No_Cedula'} // No editar claves primarias
                                onBlur={(e) => handleCellBlur(row.No_Orden, key, e.currentTarget.innerText)}
                                suppressContentEditableWarning={true}
                            >
                                {row[key]}
                            </td>
                          ))}

                          <td className="px-4 py-2 w-[250px]">
                            <div className="flex flex-col gap-1">
                              <select 
                                value={row.Tipo_Carta || ''}
                                onChange={(e) => handleSelectChange(row.No_Orden, e.target.value)}
                                className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full"
                              >
                                <option value="">-- Seleccionar --</option>
                                {templates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                              </select>
                              {requiresRadicado && (
                                <input
                                  type="text"
                                  placeholder="Radicado..."
                                  value={row.Radicado_Comp || ''}
                                  onChange={(e) => {
                                      updateRow(row.No_Orden, { Radicado_Comp: e.target.value });
                                      incrementEdits();
                                    }}
                                  className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full mt-1"
                                />
                              )}
                            </div>
                          </td>
                           <td className="px-4 py-2">
                                <button
                                    onClick={() => updateRow(row.No_Orden, { ESTADO_ACTUAL: 'Archivado' })}
                                    className="bg-archive hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-xs"
                                >
                                    Archivar
                                </button>
                            </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </section>
          );
        };

        // =================================================================================
        // INLINED: components/TrackingArea.tsx
        // =================================================================================
        // Columnas de √Årea 4 (como en la versi√≥n anterior)
        const TrackingArea = ({
            data,
            updateRow,
            incrementEdits,
            onSendToArchive,
            onExportAll,
            sortConfig,
            setSortConfig,
        }) => {
            const [filter, setFilter] = useState('');

            const TRACKING_HEADERS = [
                { key: 'Fecha_Neg', label: 'Fecha Negaci√≥n' },
                { key: 'No_Orden', label: 'No. Orden' },
                { key: 'Nombre', label: 'Afiliado' },
                { key: 'Tipo_Carta', label: 'Tipo Carta', compact: true },
                { key: 'Radicado_Comp', label: 'Radicado', compact: true },
                { key: 'ESTADO_ACTUAL', label: 'Estado' },
                { key: 'Comentarios', label: 'Comentarios' },
            ];

            // L√≥gica de ordenamiento
            const sortedData = useMemo(() => {
                let sortableData = [...data];
                if (sortConfig.key) {
                    sortableData.sort((a, b) => {
                        const aValue = a[sortConfig.key] || '';
                        const bValue = b[sortConfig.key] || '';
                        if (aValue < bValue) {
                            return sortConfig.direction === 'ascending' ? -1 : 1;
                        }
                        if (aValue > bValue) {
                            return sortConfig.direction === 'ascending' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return sortableData;
            }, [data, sortConfig]);


            const filteredData = useMemo(() => {
                const currentData = sortedData;
                if (!filter) return currentData;
                const lowercasedFilter = filter.toLowerCase();
                return currentData.filter(row =>
                    Object.values(row).some(value =>
                        String(value).toLowerCase().includes(lowercasedFilter)
                    )
                );
            }, [sortedData, filter]);

            const handleCellBlur = (noOrden, key, value) => {
                const originalRow = data.find(r => r.No_Orden === noOrden);
                if (originalRow && originalRow[key] !== value) {
                    updateRow(noOrden, { [key]: value, isEdited: true });
                    incrementEdits();
                }
            };

            const handleStatusChange = (noOrden, status) => {
                updateRow(noOrden, { ESTADO_ACTUAL: status, isEdited: true });
                incrementEdits();
            };

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };
            
            const getSortIndicator = (key) => {
                if (sortConfig.key !== key) return null;
                return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
            };

            return (
                <section id="area4" className="space-y-4">
                    <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 4: Seguimiento Activo</h2>
                    
                    <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                        <input
                            type="text"
                            placeholder="Buscar en seguimiento..."
                            className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                            value={filter}
                            onChange={(e) => setFilter(e.target.value)}
                        />
                         <button
                            onClick={onExportAll}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors ml-auto flex items-center gap-2"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.5-11.5a1 1 0 10-2 0V11a1 1 0 102 0V5.5zm4 0a1 1 0 10-2 0V11a1 1 0 102 0V5.5zm4 0a1 1 0 10-2 0V11a1 1 0 102 0V5.5z" clipRule="evenodd" />
                            </svg>
                            Exportar Todo
                        </button>
                    </div>

                    <div className="table-container max-h-[500px] overflow-auto border border-border-color rounded-lg">
                        <table className="w-full text-sm text-left text-text-secondary table-auto">
                            <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                                <tr>
                                    {TRACKING_HEADERS.map(({ key, label, compact }) => (
                                        <th key={key} onClick={() => requestSort(key)} className={`px-4 py-3 cursor-pointer ${compact ? 'max-w-[150px]' : ''}`}>
                                            {label}{getSortIndicator(key)}
                                        </th>
                                    ))}
                                    <th className="px-4 py-3">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredData.map((row) => {
                                    const rowKey = row.No_Orden;
                                    const isFinalizado = row.ESTADO_ACTUAL === 'Finalizado';

                                    return (
                                        <tr key={rowKey} className={`border-b border-border-color ${row.isEdited ? 'animate-flash-success' : 'hover:bg-highlight'} ${isFinalizado ? 'opacity-70 bg-success/10' : ''}`}>
                                            {TRACKING_HEADERS.map(({ key, compact }) => (
                                                <td key={`${rowKey}-${key}`}
                                                    className={`px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none ${compact ? 'max-w-[150px] overflow-hidden text-ellipsis whitespace-nowrap' : ''}`}
                                                    contentEditable={key === 'Radicado_Comp' || key === 'Comentarios'}
                                                    onBlur={(e) => handleCellBlur(row.No_Orden, key, e.currentTarget.innerText)}
                                                    suppressContentEditableWarning={true}
                                                >
                                                    {key === 'ESTADO_ACTUAL' ? (
                                                        <select
                                                            value={row.ESTADO_ACTUAL || 'Pendiente'}
                                                            onChange={(e) => handleStatusChange(row.No_Orden, e.target.value)}
                                                            className={`bg-surface border rounded-md px-2 py-1 text-text-primary w-full ${row.ESTADO_ACTUAL === 'Finalizado' ? 'text-success border-success' : 'border-border-color'}`}
                                                        >
                                                            {TRACKING_STATUSES.map(status => <option key={status} value={status}>{status}</option>)}
                                                        </select>
                                                    ) : row[key]}
                                                </td>
                                            ))}
                                            <td className="px-4 py-2">
                                                <button
                                                    onClick={() => onSendToArchive(row.No_Orden)}
                                                    disabled={!isFinalizado}
                                                    className={`font-bold py-1 px-3 rounded-lg text-xs transition-colors ${isFinalizado ? 'bg-archive hover:bg-gray-700 text-white' : 'bg-gray-500 text-gray-300 cursor-not-allowed'}`}
                                                >
                                                    Archivar
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </section>
            );
        };

        // =================================================================================
        // INLINED: components/ArchiveArea.tsx
        // =================================================================================
        const ArchiveArea = ({ data }) => {
            const [filter, setFilter] = useState('');
            const ARCHIVE_HEADERS = ['Fecha Negaci√≥n', 'No. Orden', 'Nombre', 'Tipo Carta', 'Radicado', 'Fecha Archivaci√≥n'];

            const filteredData = useMemo(() => {
                if (!filter) return data;
                const lowercasedFilter = filter.toLowerCase();
                return data.filter(row =>
                    Object.values(row).some(value =>
                        String(value).toLowerCase().includes(lowercasedFilter)
                    )
                );
            }, [data, filter]);

            return (
                <section id="area5" className="space-y-4">
                    <h2 className="text-2xl font-bold text-text-secondary border-b border-border-color pb-2">√Årea 5: Casos Archivados</h2>
                    <input
                        type="text"
                        placeholder="Buscar en archivo..."
                        className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                        value={filter}
                        onChange={(e) => setFilter(e.target.value)}
                    />
                    <div className="table-container max-h-40 overflow-auto border border-border-color rounded-lg">
                        <table className="w-full text-sm text-left text-text-secondary">
                            <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                                <tr>
                                    {ARCHIVE_HEADERS.map(header => <th key={header} className="px-4 py-3">{header}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {filteredData.map((row, index) => (
                                    <tr key={index} className="border-b border-border-color bg-archive/50">
                                        <td className="px-4 py-2">{row.Fecha_Neg}</td>
                                        <td className="px-4 py-2">{row.No_Orden}</td>
                                        <td className="px-4 py-2">{row.Nombre}</td>
                                        <td className="px-4 py-2">{row.Tipo_Carta_Name || row.Tipo_Carta}</td>
                                        <td className="px-4 py-2">{row.Radicado_Comp || 'N/A'}</td>
                                        <td className="px-4 py-2">{row.Fecha_Archivado || 'N/A'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </section>
            );
        };

        // =================================================================================
        // INLINED: components/TemplateModal.tsx
        // =================================================================================
        const TemplateModal = ({ isOpen, onClose, templates, onSaveTemplates }) => {
            const [currentTemplates, setCurrentTemplates] = useState(templates);
            const [notification, setNotification] = useState({ message: '', type: '' });

            useEffect(() => {
                setCurrentTemplates(templates);
            }, [templates]);

            if (!isOpen) return null;

            const handleTemplateChange = (id, key, value) => {
                setCurrentTemplates(prev => prev.map(t =>
                    t.id === id ? { ...t, [key]: value } : t
                ));
            };

            const handleSave = () => {
                // Validaci√≥n b√°sica de que no haya nombres vac√≠os o IDs duplicados (simplificado)
                const isValid = currentTemplates.every(t => t.name.trim() !== '' && t.body.trim() !== '');
                if (!isValid) {
                    setNotification({ message: 'Error: El nombre y cuerpo de la plantilla no pueden estar vac√≠os.', type: 'error' });
                    return;
                }

                onSaveTemplates(currentTemplates);
                setNotification({ message: 'Plantillas guardadas con √©xito.', type: 'success' });
                setTimeout(onClose, 1500);
            };
            
            const addNewTemplate = () => {
                const newId = `custom_tpl_${Date.now()}`;
                setCurrentTemplates(prev => [...prev, { id: newId, name: 'Nueva Plantilla', body: 'Cuerpo de la nueva plantilla...' }]);
            };

            const deleteTemplate = (idToDelete) => {
                setCurrentTemplates(prev => prev.filter(t => t.id !== idToDelete));
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                    <div className="bg-surface p-6 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b border-border-color pb-2">
                            Gestionar Plantillas de Correo
                        </h3>
                        
                        <Notification 
                            message={notification.message} 
                            type={notification.type} 
                            onClose={() => setNotification({ message: '', type: '' })} 
                        />

                        <div className="space-y-6">
                            {currentTemplates.map((template, index) => (
                                <div key={template.id} className="border border-border-color p-4 rounded-lg bg-highlight">
                                    <div className="flex justify-between items-start mb-2">
                                        <h4 className="text-xl text-white font-semibold">{template.name}</h4>
                                        <div>
                                            {index >= defaultTemplates.length && (
                                                <button onClick={() => deleteTemplate(template.id)} className="text-danger hover:text-red-400 font-bold ml-4">
                                                    Eliminar
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        <label className="block text-text-secondary text-sm">Nombre de la Plantilla:</label>
                                        <input
                                            type="text"
                                            value={template.name}
                                            onChange={(e) => handleTemplateChange(template.id, 'name', e.target.value)}
                                            className="w-full bg-background border border-border-color rounded-md px-3 py-2 text-text-primary"
                                        />
                                        <label className="block text-text-secondary text-sm">Cuerpo (Use {{Placeholders}}):</label>
                                        <textarea
                                            value={template.body}
                                            onChange={(e) => handleTemplateChange(template.id, 'body', e.target.value)}
                                            className="w-full h-32 bg-background border border-border-color rounded-md px-3 py-2 text-text-primary font-mono text-sm"
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="flex justify-between items-center mt-6 pt-4 border-t border-border-color">
                            <button onClick={addNewTemplate} className="bg-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg">
                                + Agregar Nueva Plantilla
                            </button>
                            <div>
                                <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2">
                                    Cancelar
                                </button>
                                <button onClick={handleSave} className="bg-success hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                                    Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================================
        // INLINED: components/PreviewModal.tsx
        // =================================================================================
        const PreviewModal = ({ isOpen, onClose, rowData, templates }) => {
            if (!isOpen || !rowData) return null;

            const selectedTemplate = templates.find(t => t.id === rowData.Tipo_Carta);

            const emailSubject = selectedTemplate ? `Informaci√≥n sobre ${rowData.Motivo_Negacion || 'su solicitud'}` : 'Previsualizaci√≥n de Correo';
            
            const emailBody = useMemo(() => {
                if (!selectedTemplate) {
                    return `<p class="text-warning">‚ö†Ô∏è No se ha seleccionado una plantilla v√°lida para esta fila.</p>`;
                }
                let body = selectedTemplate.body + COMMON_EMAIL_BODY + SIGNATURE;
                // Reemplazar saltos de l√≠nea por <br> para HTML
                body = body.replace(/\n/g, '<br>');
                return replacePlaceholders(body, rowData);
            }, [rowData, selectedTemplate]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                    <div className="bg-surface p-6 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b border-border-color pb-2">
                            Previsualizaci√≥n de Correo Electr√≥nico
                        </h3>
                        
                        <div className="space-y-4 text-sm">
                            <p><strong>Para:</strong> {rowData.EMAIL || '<span class="text-danger">Correo no disponible</span>'}</p>
                            <p><strong>Asunto:</strong> {emailSubject}</p>
                            <p><strong>Plantilla Seleccionada:</strong> {selectedTemplate?.name || 'Ninguna'}</p>
                        </div>
                        
                        <div className="mt-4 p-4 border border-border-color rounded-lg bg-background min-h-[300px]">
                            <h4 className="font-bold text-white mb-2">Cuerpo del Correo (HTML):</h4>
                            <div className="prose text-text-primary" dangerouslySetInnerHTML={{ __html: emailBody }}></div>
                        </div>
                        
                        <div className="flex justify-end mt-6 pt-4 border-t border-border-color">
                            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================================
        // INLINED: components/ConfigModal.tsx
        // =================================================================================
        const ConfigModal = ({ isOpen, onClose, currentUrl, onSaveUrl }) => {
            const [url, setUrl] = useState(currentUrl);

            useEffect(() => {
                setUrl(currentUrl);
            }, [currentUrl]);

            if (!isOpen) return null;

            const handleSave = () => {
                // Validaci√≥n b√°sica de URL
                if (url && url.startsWith('https://script.google.com/macros/')) {
                    onSaveUrl(url);
                    alert('URL de App Script guardada con √©xito.');
                    onClose();
                } else {
                    alert('Por favor, introduce una URL de Google App Script v√°lida.');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                    <div className="bg-surface p-6 rounded-lg shadow-2xl w-full max-w-xl">
                        <h3 className="text-2xl font-bold text-primary mb-4 border-b border-border-color pb-2">
                            Configurar Conexi√≥n a Google Sheets
                        </h3>
                        
                        <p className="text-text-secondary mb-4">
                            Introduce la URL de implementaci√≥n de tu Google App Script. Esta URL permite a la aplicaci√≥n leer y escribir datos en tu hoja de c√°lculo.
                        </p>

                        <div className="mb-4">
                            <label htmlFor="appScriptUrl" className="block text-text-secondary mb-2">URL de Google App Script:</label>
                            <input
                                id="appScriptUrl"
                                type="url"
                                value={url}
                                onChange={(e) => setUrl(e.target.value)}
                                placeholder="https://script.google.com/macros/s/..."
                                className="w-full bg-background border border-border-color rounded-md px-3 py-2 text-text-primary"
                            />
                        </div>

                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                                Cancelar
                            </button>
                            <button onClick={handleSave} className="bg-success hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                                Guardar y Conectar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================================
        // MAIN APPLICATION: App.tsx
        // =================================================================================

        const STORAGE_URL_KEY = 'sigweb_appScriptUrl';
        const STORAGE_DATA_KEY = 'sigweb_localData';

        // Custom Hook para manejar el estado persistente de la URL
        const useAppScriptUrl = () => {
            const [url, setUrl] = useState(() => {
                return localStorage.getItem(STORAGE_URL_KEY) || '';
            });

            const saveUrl = useCallback((newUrl) => {
                localStorage.setItem(STORAGE_URL_KEY, newUrl);
                setUrl(newUrl);
            }, []);

            return [url, saveUrl];
        };

        // Custom Hook para manejar el estado de la data
        const useDataState = (initialTemplates) => {
            const [data, setData] = useState(() => {
                const storedData = localStorage.getItem(STORAGE_DATA_KEY);
                return storedData ? JSON.parse(storedData) : {
                    finalData: [],
                    trackingData: [],
                    archivedData: [],
                };
            });
            const [editsCount, setEditsCount] = useState(0);

            // Sincronizaci√≥n con localStorage
            useEffect(() => {
                localStorage.setItem(STORAGE_DATA_KEY, JSON.stringify(data));
            }, [data]);
            
            // Funci√≥n para a√±adir datos del portal (√Årea 1)
            const addPortalData = useCallback((newData) => {
                setData(prev => {
                    const existingOrders = new Set(prev.finalData.map(r => r['N√öMERO ORDEN'] || r.No_Orden).filter(Boolean));
                    const newUniqueData = newData.filter(row => !(row['N√öMERO ORDEN'] && existingOrders.has(row['N√öMERO ORDEN'])));
                    
                    if (newUniqueData.length === 0) return prev;

                    // Normalizar y a√±adir campos de revisi√≥n
                    const processedData = newUniqueData.map(row => ({
                        ...row,
                        Fecha_Neg: row['FECHA NEGACI√ìN'],
                        No_Orden: row['N√öMERO ORDEN'],
                        No_Cedula: row['IDENTIFICACI√ìN AFILIADO'],
                        Nombre: capitalizeWords(row['NOMBRE AFILIADO']),
                        Motivo_Negacion: row['MOTIVO NEGACI√ìN'],
                        Tipo_Carta: '',
                        Descripcion_PDF: '',
                        Justificacion_PDF: '',
                        Fundamento_Legal_PDF: '',
                        isEdited: true, 
                        ESTADO_ACTUAL: 'En Revisi√≥n',
                    }));

                    setEditsCount(prev => prev + processedData.length);
                    
                    return {
                        ...prev,
                        finalData: [...prev.finalData, ...processedData].filter(r => r.No_Orden),
                    };
                });
            }, []);

            // Funci√≥n para a√±adir datos del PDF (√Årea 2)
            const addPdfData = useCallback((newData) => {
                setData(prev => {
                    const finalDataMap = new Map(prev.finalData.map(r => [r.No_Orden, r]));
                    let changedCount = 0;

                    newData.forEach(pdfRow => {
                        const orderKey = pdfRow['Archivo (No. Orden)'];
                        if (orderKey && finalDataMap.has(orderKey)) {
                            const current = finalDataMap.get(orderKey);
                            
                            // Comparar y actualizar solo si hay cambios en los campos de PDF
                            const newRow = { 
                                ...current, 
                                Descripcion_PDF: pdfRow.Descripci√≥n || current.Descripcion_PDF,
                                Justificacion_PDF: pdfRow.Justificaci√≥n || current.Justificacion_PDF,
                                Fundamento_Legal_PDF: pdfRow['Fundamento Legal'] || current.Fundamento_Legal_PDF,
                            };
                            
                            if (newRow.Descripcion_PDF !== current.Descripcion_PDF || 
                                newRow.Justificacion_PDF !== current.Justificacion_PDF || 
                                newRow.Fundamento_Legal_PDF !== current.Fundamento_Legal_PDF) {
                                
                                newRow.isEdited = true;
                                changedCount++;
                            }

                            finalDataMap.set(orderKey, newRow);
                        }
                    });

                    if (changedCount > 0) {
                        setEditsCount(prev => prev + changedCount);
                    }

                    return {
                        ...prev,
                        finalData: Array.from(finalDataMap.values()),
                    };
                });
            }, []);

            // Funci√≥n para actualizar una fila espec√≠fica (√Årea 3 y 4)
            const updateRow = useCallback((noOrden, changes, targetArea = 'finalData') => {
                setData(prev => {
                    const targetKey = targetArea === 'finalData' ? 'finalData' : 'trackingData';
                    
                    const newData = prev[targetKey].map(row => {
                        if (row.No_Orden === noOrden) {
                            // Si se est√° actualizando un campo, marca como editado
                            const newRow = { ...row, ...changes, isEdited: true }; 
                            return newRow;
                        }
                        return row;
                    });
                    
                    // Solo incrementa si los cambios no incluyen el archivado y no viene de la sync inicial
                    if (changes.ESTADO_ACTUAL !== 'Archivado') {
                         setEditsCount(prev => prev + 1);
                    }
                    
                    return { ...prev, [targetKey]: newData };
                });
            }, []);


            // Funci√≥n para mover a seguimiento
            const sendToTracking = useCallback((selectedOrderNumbers) => {
                setData(prev => {
                    const toMove = prev.finalData.filter(row => selectedOrderNumbers.includes(row.No_Orden));
                    const remaining = prev.finalData.filter(row => !selectedOrderNumbers.includes(row.No_Orden));

                    const movedWithStatus = toMove.map(row => ({
                        ...row,
                        ESTADO_ACTUAL: 'Pendiente', // Estado inicial de seguimiento
                        isEdited: true, // Marcar para guardar
                    }));
                    
                    setEditsCount(prev => prev + movedWithStatus.length);

                    return {
                        ...prev,
                        finalData: remaining,
                        trackingData: [...prev.trackingData, ...movedWithStatus],
                    };
                });
                return true;
            }, []);

            // Funci√≥n para mover a archivo
            const sendToArchive = useCallback((noOrden) => {
                setData(prev => {
                    const rowToArchive = prev.trackingData.find(row => row.No_Orden === noOrden);
                    if (!rowToArchive) return prev;
                    
                    const remainingTracking = prev.trackingData.filter(row => row.No_Orden !== noOrden);
                    
                    const archivedRow = {
                        ...rowToArchive,
                        ESTADO_ACTUAL: 'Archivado',
                        Fecha_Archivado: new Date().toISOString().slice(0, 10),
                        Tipo_Carta_Name: initialTemplates.find(t => t.id === rowToArchive.Tipo_Carta)?.name || rowToArchive.Tipo_Carta,
                    };
                    
                    setEditsCount(prev => prev + 1);

                    return {
                        ...prev,
                        trackingData: remainingTracking,
                        archivedData: [...prev.archivedData, archivedRow],
                    };
                });
            }, [initialTemplates]);

            // Funci√≥n para limpiar data de revisi√≥n
            const clearReviewData = useCallback(() => {
                if (window.confirm("¬øEst√°s seguro de que quieres eliminar todos los casos en el √Årea de Revisi√≥n? Esta acci√≥n es irreversible.")) {
                    setData(prev => ({ ...prev, finalData: [] }));
                    setEditsCount(prev => prev + 1); // Contar como una edici√≥n para sincronizar si es necesario
                    return true;
                }
                return false;
            }, []);


            return {
                data,
                editsCount,
                incrementEdits: () => setEditsCount(prev => prev + 1),
                clearEdits: () => setEditsCount(0),
                addPortalData,
                addPdfData,
                updateRow,
                sendToTracking,
                sendToArchive,
                clearReviewData,
                setData, // Para la carga inicial desde la nube
            };
        };

        
        const App = () => {
            const [appScriptUrl, saveAppScriptUrl] = useAppScriptUrl();
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(!appScriptUrl);
            const [isTemplateModalOpen, setIsTemplateModalOpen] = useState(false);
            const [isPreviewModalOpen, setIsPreviewModalOpen] = useState(false);
            const [previewRowData, setPreviewRowData] = useState(null);
            
            const [portalDataInput, setPortalDataInput] = useState(Array(5).fill({}));
            const [pdfDataInput, setPdfDataInput] = useState(Array(5).fill({}));
            
            const [templates, setTemplates] = useState(loadTemplates);
            
            const [notification, setNotification] = useState({ message: '', type: '' });
            const [isLoading, setIsLoading] = useState(false);
            
            const [sortConfig, setSortConfig] = useState({ key: 'Fecha_Neg', direction: 'ascending' });

            const { 
                data, 
                editsCount, 
                incrementEdits, 
                clearEdits, 
                addPortalData, 
                addPdfData, 
                updateRow, 
                sendToTracking, 
                sendToArchive,
                clearReviewData,
                setData
            } = useDataState(templates);

            // --- Handlers de Plantillas ---
            const handleSaveTemplates = useCallback((newTemplates) => {
                saveTemplates(newTemplates);
                setTemplates(newTemplates);
            }, []);

            // --- Handlers de Modales ---
            const handleReconfigure = () => setIsConfigModalOpen(true);
            const handleManageTemplates = () => setIsTemplateModalOpen(true);
            
            const handlePreview = (row) => {
                setPreviewRowData(row);
                setIsPreviewModalOpen(true);
            };
            
            // --- Sync con Google Sheets ---

            const loadDataFromSheet = useCallback(async () => {
                if (!appScriptUrl) return;
                setIsLoading(true);
                setNotification({ message: 'Cargando datos desde la nube...', type: 'info' });
                try {
                    const loadedData = await fetchData(appScriptUrl);
                    // Solo reemplazamos la data local si la data cargada tiene contenido significativo
                    if (loadedData.finalData.length > 0 || loadedData.trackingData.length > 0 || loadedData.archivedData.length > 0) {
                        setData(loadedData);
                        setNotification({ message: 'Datos sincronizados desde la nube con √©xito.', type: 'success' });
                    } else {
                        setNotification({ message: 'Conectado a la nube, pero no se encontraron datos nuevos.', type: 'warning' });
                    }
                    clearEdits();
                } catch (error) {
                    console.error("Error al cargar datos:", error);
                    setNotification({ message: 'Error al conectar o cargar datos: ' + error.message, type: 'error' });
                } finally {
                    setIsLoading(false);
                }
            }, [appScriptUrl, setData, clearEdits]);


            const saveLocalDataToSheet = useCallback(async () => {
                if (!appScriptUrl) {
                    setNotification({ message: 'Error: Configura la URL del App Script primero.', type: 'error' });
                    setIsConfigModalOpen(true);
                    return;
                }
                if (editsCount === 0) {
                    setNotification({ message: 'No hay ediciones locales pendientes para guardar.', type: 'info' });
                    return;
                }

                setIsLoading(true);
                setNotification({ message: 'Guardando datos en la nube...', type: 'info' });

                try {
                    // Limpiar la bandera isEdited antes de enviar
                    const dataToSend = {
                        finalData: data.finalData.map(r => ({ ...r, isEdited: false })),
                        trackingData: data.trackingData.map(r => ({ ...r, isEdited: false })),
                        archivedData: data.archivedData,
                    };

                    await saveData(appScriptUrl, dataToSend);
                    
                    // Actualizar el estado local con la bandera limpia si el guardado fue exitoso
                    setData(dataToSend);
                    clearEdits(); 
                    setNotification({ message: '¬°Datos guardados en la nube con √©xito!', type: 'success' });

                } catch (error) {
                    console.error("Error al guardar datos:", error);
                    setNotification({ message: 'Error al guardar datos: ' + error.message, type: 'error' });
                } finally {
                    setIsLoading(false);
                }
            }, [appScriptUrl, data, editsCount, clearEdits, setData]);
            
            // --- Exportaci√≥n para Mail Merge y Reporte Detallado ---

            const handleExportForMailMerge = (selectedOrderNumbers) => {
                const mailMergeData = data.finalData
                    .filter(row => selectedOrderNumbers.includes(row.No_Orden))
                    .map(row => {
                        const template = templates.find(t => t.id === row.Tipo_Carta);
                        
                        // Generar el cuerpo final con la firma y el cuerpo com√∫n
                        let finalBody = template ? template.body + COMMON_EMAIL_BODY + SIGNATURE : '';
                        finalBody = finalBody.replace(/\n/g, '<br>'); // Reemplazar saltos de l√≠nea por <br>

                        return {
                            ...row,
                            Tipo_Carta_Nombre: template?.name || 'N/A',
                            Cuerpo_Correo_HTML: replacePlaceholders(finalBody, row),
                            Asunto_Correo: `Informaci√≥n sobre ${row.Motivo_Negacion || 'su solicitud'}`,
                            // Asegurarse de que las cabeceras de Excel sean planas
                            Descripcion_PDF: row.Descripcion_PDF, 
                            Justificacion_PDF: row.Justificacion_PDF,
                            Fundamento_Legal_PDF: row.Fundamento_Legal_PDF,
                        };
                    });

                if (mailMergeData.length === 0) {
                    setNotification({ message: 'No hay filas seleccionadas para exportar o la data est√° incompleta.', type: 'warning' });
                    return;
                }

                try {
                    const ws = XLSX.utils.json_to_sheet(mailMergeData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "MailMerge_Export");
                    XLSX.writeFile(wb, `MailMerge_Export_${new Date().toISOString().slice(0, 10)}.xlsx`);
                    setNotification({ message: `Exportados ${mailMergeData.length} casos para Mail Merge.`, type: 'success' });
                } catch (error) {
                    console.error("Error al exportar Mail Merge:", error);
                    setNotification({ message: 'Error al generar el archivo de Mail Merge.', type: 'error' });
                }
            };

            const handleExportDetailedReport = () => {
                 exportDetailedReport(data.finalData, data.trackingData, data.archivedData);
                 setNotification({ message: 'Reporte detallado de seguimiento generado.', type: 'info' });
            };


            // Carga inicial de datos desde la nube (si hay URL)
            useEffect(() => {
                if (appScriptUrl) {
                    loadDataFromSheet();
                }
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [appScriptUrl]); // Ejecutar solo una vez al inicio si hay URL

            // --- Render ---

           return (
                <div className="min-h-screen p-6 space-y-8 max-w-full px-12">
                    
                    <Header 
                        onSave={saveLocalDataToSheet} 
                        onManageTemplates={handleManageTemplates}
                        onReconfigure={handleReconfigure}
                    />

                    <Dashboard 
                        reviewCount={data.finalData.length} 
                        trackingCount={data.trackingData.length} 
                        archivedCount={data.archivedData.length}
                        editsCount={editsCount}
                    />

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <DataInputArea
                            id="area1"
                            title="√Årea 1: Datos del Portal"
                            headers={PORTAL_HEADERS}
                            data={portalDataInput}
                            onDataChange={setPortalDataInput}
                            onProcess={() => {
                                const validData = portalDataInput.filter(row => row['N√öMERO ORDEN']);
                                if (validData.length > 0) {
                                    addPortalData(validData);
                                    setPortalDataInput(Array(5).fill({}));
                                    setNotification({ message: `A√±adidos ${validData.length} casos a Revisi√≥n.`, type: 'success' });
                                } else {
                                    setNotification({ message: 'No hay datos v√°lidos del portal para procesar.', type: 'warning' });
                                }
                            }}
                            processButtonText="A√±adir a Revisi√≥n"
                        />
                        <DataInputArea
                            id="area2"
                            title="√Årea 2: Datos del PDF (Justificaci√≥n, Fundamento, etc.)"
                            headers={PDF_HEADERS}
                            data={pdfDataInput}
                            onDataChange={setPdfDataInput}
                            onProcess={() => {
                                const validData = pdfDataInput.filter(row => row['Archivo (No. Orden)']);
                                if (validData.length > 0) {
                                    addPdfData(validData);
                                    setPdfDataInput(Array(5).fill({}));
                                    setNotification({ message: `Actualizados ${validData.length} casos en Revisi√≥n.`, type: 'success' });
                                } else {
                                    setNotification({ message: 'No hay datos v√°lidos de PDF para procesar.', type: 'warning' });
                                }
                            }}
                            processButtonText="Actualizar Revisi√≥n"
                        />
                    </div>
                    
                    <ReviewArea
                        data={data.finalData}
                        templates={templates}
                        updateRow={(noOrden, changes) => updateRow(noOrden, changes, 'finalData')}
                        incrementEdits={incrementEdits}
                        onSendToTracking={(selectedOrders) => {
                            if (sendToTracking(selectedOrders)) {
                                setNotification({ message: `Movidos ${selectedOrders.length} casos a Seguimiento Activo.`, type: 'info' });
                            }
                            // Limpiar selecci√≥n despu√©s de mover
                            document.querySelectorAll('#area3 input[type="checkbox"]').forEach(cb => cb.checked = false);
                        }}
                        onPreview={handlePreview}
                        onExportForMailMerge={handleExportForMailMerge}
                        onClearReviewData={clearReviewData}
                        sortConfig={sortConfig}
                        setSortConfig={setSortConfig}
                    />

                    <hr className="border-border-color" />

                    <TrackingArea
                        data={data.trackingData}
                        updateRow={(noOrden, changes) => updateRow(noOrden, changes, 'trackingData')}
                        incrementEdits={incrementEdits}
                        onSendToArchive={(noOrden) => {
                            sendToArchive(noOrden);
                            setNotification({ message: `Caso ${noOrden} finalizado y archivado.`, type: 'info' });
                        }}
                        onExportAll={handleExportDetailedReport}
                        sortConfig={sortConfig}
                        setSortConfig={setSortConfig}
                    />
                    
                    <hr className="border-border-color" />

                    <ArchiveArea
                        data={data.archivedData}
                    />

                    {/* Modales */}
                    <TemplateModal 
                        isOpen={isTemplateModalOpen} 
                        onClose={() => setIsTemplateModalOpen(false)} 
                        templates={templates}
                        onSaveTemplates={handleSaveTemplates}
                    />
                    
                    <PreviewModal
                        isOpen={isPreviewModalOpen}
                        onClose={() => setIsPreviewModalOpen(false)}
                        rowData={previewRowData}
                        templates={templates}
                    />

                    <ConfigModal
                        isOpen={isConfigModalOpen}
                        onClose={() => setIsConfigModalOpen(false)}
                        currentUrl={appScriptUrl}
                        onSaveUrl={(url) => {
                            saveAppScriptUrl(url);
                            // Intentar cargar datos inmediatamente despu√©s de guardar la URL
                            loadDataFromSheet();
                        }}
                    />

                    {/* Notificaciones y Spinner */}
                    <Notification 
                        message={notification.message} 
                        type={notification.type} 
                        onClose={() => setNotification({ message: '', type: '' })} 
                    />

                    {isLoading && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center">
                            <div className="flex flex-col items-center p-6 bg-surface rounded-lg shadow-xl">
                                <Spinner />
                                <p className="mt-4 text-white">Procesando datos...</p>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        // Montaje de la aplicaci√≥n React
        const container = document.getElementById('root');
        const root = ReactDOMClient.createRoot(container);
        root.render(<App />);

    </script>

</body>
</html>

