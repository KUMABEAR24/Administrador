<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GESTION NEGACIONES EJE CAFETERO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      // Tailwind CSS Configuration
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4e9fef',
              'background': '#1e1e1e',
              'surface': '#2d2d2d',
              'text-primary': '#d4d4d4',
              'text-secondary': '#a0a0a0',
              'border-color': '#444',
              'header': '#3a3a3a',
              'highlight': '#252526',
              'warning': '#6e550c',
              'archive': '#3a3a3a',
              'success': '#28a745',
              'danger': '#a02d2d',
              'danger-hover': '#c0392b',
              'btn-primary': '#0e639c',
              'btn-primary-hover': '#1a73e8',
            },
            animation: {
              'flash-success': 'flash-success 1s ease-out',
            },
            keyframes: {
              'flash-success': {
                'from': { backgroundColor: '#28a745' },
                'to': { backgroundColor: 'transparent' },
              }
            }
          }
        }
      }
    </script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-background text-text-primary min-h-screen p-4 sm:p-8">
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';

        // =================================================================================
        // CONSTANTES
        // =================================================================================
        
        // --- Cabeceras del Portal (√Årea 1) ---
        const PORTAL_HEADERS = [
          "Fecha_Asignacion", "EJECUTIVO", "FECHA NEGACI√ìN", "REGIONAL", "N√öMERO ORDEN", 
          "TIPO DOCUMENTO", "IDENTIFICACI√ìN AFILIADO", "NOMBRE AFILIADO", "EDAD", 
          "PROCEDIMIENTO", "MOTIVO NEGACI√ìN", "PLAN", "PROGRAMA", "EPS", 
          "Fecha_Ingreso", "EMAIL", "CELULAR", "ESTADO"
        ];

        // --- Cabeceras de los Datos del PDF (√Årea 2) ---
        const PDF_HEADERS = [
          "Archivo (No. Orden)", "Descripci√≥n", "Justificaci√≥n", "Fundamento Legal", "C√≥digo"
        ];

        // --- Cabeceras para la Exportaci√≥n de Mail Merge (CR√çTICO: FORMATO REQUERIDO) ---
        const MAIL_MERGE_HEADERS = [
          'No_Orden', 'Fecha_Neg', 'No_Cedula', 'Nombre', 'EPS', 'Programa', 'Motivo_Negacion', 
          'Descripcion_PDF', 'Justificacion_PDF', 'Fundamento_Legal_PDF', 'Tipo_Carta', 'Radicado_Comp',
          'EMAIL', 'CELULAR', 'Fecha_Asignacion', 'EJECUTIVO', 'REGIONAL'
        ];

        const TRACKING_STATUSES = ['Pendiente', 'En Gesti√≥n', 'Finalizado'];
        
        const COMMON_EMAIL_BODY = `<br><br><b>Si tiene alguna duda puede contactarse por medio de los canales que tenemos disponibles para usted:</b><br>¬∑ Nuestra l√≠nea nacional 018000931666. O con nuestras l√≠neas locales: Cali (602) 489 0073, Bogot√° (601) 743 5485, Medell√≠n (604) 604 4507, Barranquilla (605) 385 3165, Bucaramanga (607) 697 3350, Cartagena (605) 693 9853, Tulu√° (602) 235 9483, Valledupar (605)588 5699, Pereira (606) 340 2635.<br>¬∑ WhatsApp: 317-224-07-94<br><br>Gracias por su Atenci√≥n.`;
        const SIGNATURE = `<br><br>Cordialmente,<br><br><b>Juan Ricardo Morales Agudelo</b><br>Ejecutivo De Atenci√≥n Integral<br>Coomeva Medicina Prepagada<br>Cra. 13 No.11-12 Centro M√©dico Circunvalar<br>Coomeva Medicina Prepagada Pereira, Risaralda<br><br><i>Este correo es generado autom√°ticamente, por favor no responda este mensaje.</i>`;

        const defaultTemplates = [
            { id: 'tpl_neg_gen', name: 'PLANTILLA NEGACION GENERAL', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad no est√° aprobado debido a que corresponde a EXCLUSI√ìN ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}), ({{Programa}}).<br><br>El servicio negado anteriormente; debe tramitarlo a trav√©s su EPS asignada. Adjuntamos soporte de la carta de negaci√≥n.` },
            { id: 'tpl_neg_pert', name: 'PLANTILLA NO PERTINENCIA Y TEMAS ESTETICOS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad No est√° aprobado debido a que corresponde a NO PERTINENCIA ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}), ({{Programa}}).<br><br>` },
            { id: 'tpl_comp_coinc', name: 'COMPLEMENTARIEDAD RED COINCIDENTE', body: `Apreciado Usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y el de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no fue aprobado, debido a que ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, est√° en gesti√≥n a trav√©s de su EPS ({{EPS}}) con el n√∫mero de radicado ({{Radicado_Comp}}), puede realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).<br><br>Adicional estaremos haciendo seguimiento al radicado y una vez se encuentre gestionado por la EPS, le notificaremos por medio de correo electr√≥nico.` },
            { id: 'tpl_comp_no_coinc', name: 'COMPLEMENTARIEDAD RED NO COINCIDENTE', body: `Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado, debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El prestador actual solicitado, no tiene convenio con la EPS, por lo que los costos adicionales del servicio o insumo estar√°n a cargo del paciente. Sin embargo; se radica la solicitud ante su EPS con el n√∫mero ({{Radicado_Comp}}) por favor realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).` },
            { id: 'tpl_comp_ayudas', name: 'COMPLEMENTARIEDAD AYUDAS DIAGNOSTICAS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, se encuentra en gesti√≥n a trav√©s de su EPS con el n√∫mero de radicado ({{Radicado_Comp}}), por favor realizar seguimiento mediante la oficina virtual. ({{Oficina_Virtual_EPS}}).` },
        ];


        // =================================================================================
        // SERVICIOS/UTILIDADES
        // =================================================================================
        const capitalizeWords = (str) => {
          if (!str) return '';
          return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        };

        const processPastedData = (pastedText, headers) => {
            return pastedText
                .trim()
                .split(/\r?\n/)
                .map(rowText => {
                    // Split por tabulador (\t) para datos pegados de Excel/Google Sheets
                    const cells = rowText.split('\t'); 
                    const rowObject = {};
                    
                    headers.forEach((header, index) => {
                        if (cells[index]) {
                            const cleanHeader = header.trim();
                            rowObject[cleanHeader] = cells[index].trim();
                        }
                    });
                    
                    return rowObject;
                })
                .filter(row => Object.values(row).some(val => val)); // Filtrar filas completamente vac√≠as
        };

        const replacePlaceholders = (templateBody, data) => {
          const getOficinaVirtual = (eps) => {
            const e = (eps || "").toUpperCase();
            if (e.includes("NUEVA EPS")) return `<a href='https://portal.nuevaeps.com.co/Portal/home.jspx' target='_blank' rel='noopener noreferrer'>NUEVA EPS</a>`;
            if (e.includes("SALUD TOTAL")) return `<a href='https://saludtotal.com.co/' target='_blank' rel='noopener noreferrer'>SALUD TOTAL</a>`;
            return eps;
          };

          const fullData = { ...data, Oficina_Virtual_EPS: getOficinaVirtual(data.EPS) };

          return templateBody.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return fullData[key] || match;
          });
        };

        const exportDetailedReport = (finalData, trackingData, archivedData) => {
          // Funci√≥n auxiliar para exportar tablas de datos detalladas
          try {
            const masterDataMap = new Map();

            [...finalData, ...trackingData, ...archivedData].forEach(row => {
              if (row.No_Orden) {
                const key = row.No_Orden.trim();
                const existing = masterDataMap.get(key) || {};
                masterDataMap.set(key, { ...existing, ...row });
              }
            });
            
            const masterData = Array.from(masterDataMap.values());

            if (masterData.length === 0) {
              alert("No hay datos consolidados para exportar.");
              return;
            }

            const wb = XLSX.utils.book_new();
            
            if (finalData.length > 0) {
              const ws1 = XLSX.utils.json_to_sheet(finalData);
              XLSX.utils.book_append_sheet(wb, ws1, "Casos en Revisi√≥n");
            }
            
            if (trackingData.length > 0) {
              const ws2 = XLSX.utils.json_to_sheet(trackingData);
              XLSX.utils.book_append_sheet(wb, ws2, "Seguimiento Activo");
            }

            if (archivedData.length > 0) {
              const ws3 = XLSX.utils.json_to_sheet(archivedData);
              XLSX.utils.book_append_sheet(wb, ws3, "Seguimiento Archivado");
            }
            
            const ws4 = XLSX.utils.json_to_sheet(masterData);
            XLSX.utils.book_append_sheet(wb, ws4, "Maestro Consolidado");

            XLSX.writeFile(wb, `Sigweb_Reporte_Detallado_${new Date().toISOString().slice(0, 10)}.xlsx`);
          } catch (error) {
            console.error("Fall√≥ la exportaci√≥n del reporte Excel:", error);
            alert("Ocurri√≥ un error al generar el reporte.");
          }
        };

        // --- Gesti√≥n de Plantillas ---
        const TEMPLATE_STORAGE_KEY = 'sigweb_emailTemplates';

        const loadTemplates = () => {
          try {
            const storedTemplates = localStorage.getItem(TEMPLATE_STORAGE_KEY);
            if (storedTemplates) {
              const parsed = JSON.parse(storedTemplates);
              if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].id && parsed[0].name) {
                return parsed;
              }
            }
          } catch (error) {
            console.error("Fall√≥ la carga de plantillas desde localStorage, se usar√°n las predeterminadas.", error);
            localStorage.removeItem(TEMPLATE_STORAGE_KEY);
          }
          return defaultTemplates;
        };

        const saveTemplates = (templates) => {
          try {
            localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
          } catch (error) {
            console.error("Fall√≥ el guardado de plantillas en localStorage", error);
          }
        };

        // --- Simulaci√≥n de Conexi√≥n a Google Sheet (Debe ser reemplazado por la URL real) ---
        const fetchData = async (url) => {
            console.log("Simulando FETCH de datos de Google Sheet...");
            await new Promise(resolve => setTimeout(resolve, 500)); 
            return {
                finalData: JSON.parse(localStorage.getItem('saved_finalData') || '[]'),
                trackingData: JSON.parse(localStorage.getItem('saved_trackingData') || '[]'),
                archivedData: JSON.parse(localStorage.getItem('saved_archivedData') || '[]'),
            };
        };

        const saveData = async (url, data) => {
            console.log("Simulando SAVE de datos a Google Sheet:", data);
            
            localStorage.setItem('saved_finalData', JSON.stringify(data.finalData || []));
            localStorage.setItem('saved_trackingData', JSON.stringify(data.trackingData || []));
            localStorage.setItem('saved_archivedData', JSON.stringify(data.archivedData || []));
            
            await new Promise(resolve => setTimeout(resolve, 1000)); 
            return { status: 'success', message: 'Datos guardados en la simulaci√≥n local.' };
        };


        // =================================================================================
        // COMPONENTES (Spinner, Notification, Header, etc.)
        // =================================================================================
        const Spinner = () => {
          return (
            <div
              className="inline-block h-6 w-6 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
              role="status"
            >
              <span className="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">
                Cargando...
              </span>
            </div>
          );
        };


        const Notification = ({ message, type, onClose }) => {
          const typeClasses = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            warning: 'bg-yellow-500',
            info: 'bg-blue-600',
          };
          return (
            <div className={`fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white ${typeClasses[type]} flex items-center gap-4`}>
              <span>{message}</span>
              <button onClick={onClose} className="text-xl font-bold">&times;</button>
            </div>
          );
        };

        const Header = ({ onSave, onManageTemplates, onReconfigure, isSaving }) => {
          return (
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-border-color sticky top-0 bg-background z-10">
              <div>
                <h1 className="text-3xl font-bold text-white">
                  GESTION NEGACIONES EJE CAFETERO
                </h1>
                <p className="text-text-secondary">Sistema Integrado de Gesti√≥n de Flujos de Trabajo</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onManageTemplates} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  Gestionar Plantillas
                </button>
                <button onClick={onReconfigure} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8.21 5.15a1.5 1.5 0 01-1.25.82l-2.09.28c-1.68.23-2.34 2.26-1.09 3.42l1.52 1.48a1.5 1.5 0 01-.42 2.1l-1.83 1.25c-1.38.94-.92 3.01.7 3.42l2.05.51a1.5 1.5 0 011.1.98l.8 2.07c.43 1.12 2.29 1.12 2.72 0l.8-2.07a1.5 1.5 0 011.1-.98l2.05-.51c1.62-.4 2.08-2.48.7-3.42l-1.83-1.25a1.5 1.5 0 01-.42-2.1l1.52-1.48c1.25-1.16.59-3.19-1.09-3.42L13 5.97a1.5 1.5 0 01-1.25-.82l-.3-1.98zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" />
                  </svg>
                  Reconfigurar Conexi√≥n
                </button>
                <button 
                    onClick={onSave} 
                    disabled={isSaving}
                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed"
                >
                    {isSaving ? <Spinner /> : (
                        <>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M5.5 16.5a2.5 2.5 0 01-5 0V4.414a1.5 1.5 0 01.44-1.06L4.354.439A1.5 1.5 0 015.414 0H12.5a2.5 2.5 0 012.5 2.5v2" />
                                <path d="M5.5 16.5h8a2.5 2.5 0 002.5-2.5V8.5h-13v5.5a2.5 2.5 0 002.5 2.5z" />
                                <path d="M10.5 10a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" />
                            </svg>
                            Guardar en la Nube
                        </>
                    )}
                </button>
              </div>
            </header>
          );
        };
        

        const DashboardCard = ({ title, value, icon }) => (
          <div className="bg-surface p-4 rounded-lg border border-border-color flex items-center">
            <div className="text-3xl text-primary mr-4">{icon}</div>
            <div>
              <h4 className="text-sm font-semibold text-text-secondary uppercase tracking-wider">{title}</h4>
              <p className="text-2xl font-bold text-text-primary">{value}</p>
            </div>
          </div>
        );

        const Dashboard = ({ reviewCount, trackingCount, archivedCount, editsCount }) => (
          <section id="dashboard" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 py-4">
            <DashboardCard title="Casos en Revisi√≥n" value={reviewCount} icon={'üìã'} />
            <DashboardCard title="Seguimiento Activo" value={trackingCount} icon={'‚è≥'} />
            <DashboardCard title="Casos Archivados" value={archivedCount} icon={'üóÑÔ∏è'} />
            <DashboardCard title="Ediciones en Sesi√≥n" value={editsCount} icon={'‚úèÔ∏è'} />
          </section>
        );

        function DataInputArea({
          id,
          title,
          headers,
          data,
          onDataChange,
          onProcess,
          processButtonText = "Procesar Datos",
        }) {
          
          const handlePaste = useCallback((e) => {
            e.preventDefault();
            const pastedText = e.clipboardData.getData('text/plain');
            const newRows = processPastedData(pastedText, headers);

            const existingData = data.filter(row => Object.values(row).some(val => val));
            let updatedData = [...existingData, ...newRows];
            
            // Eliminar duplicados vac√≠os y garantiza un m√≠nimo de filas para entrada manual
            const finalData = updatedData.filter((row, index, self) => 
                index === self.findIndex(r => JSON.stringify(r) === JSON.stringify(row)) || Object.values(row).some(val => val)
            );
            
            // Asegura al menos 5 filas vac√≠as
            while (finalData.length < 5 || finalData.filter(row => !Object.values(row).some(val => val)).length < 5) {
                finalData.push({});
            }
            
            onDataChange(finalData);
          }, [data, headers, onDataChange]);

          const handleCellChange = (rowIndex, header, value) => {
            const newData = [...data];
            newData[rowIndex] = { ...newData[rowIndex], [header]: value };
            
            // Auto-a√±adir fila vac√≠a si se est√° escribiendo en la √∫ltima fila v√°lida
            const hasData = Object.values(newData[rowIndex]).some(val => val);
            const isLastRow = rowIndex === newData.length - 1;

            if (hasData && isLastRow) {
                newData.push({});
            }

            onDataChange(newData);
          };
          
          const clearTable = () => {
            onDataChange(Array(5).fill({}));
          }

          return (
            <section id={id} className="space-y-4 py-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">{title}</h2>
              <div className="table-container max-h-96 overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      {headers.map(header => (
                        <th key={header} scope="col" className="px-4 py-3 whitespace-nowrap">{header}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody onPaste={handlePaste}>
                    {data.map((row, rowIndex) => (
                      <tr key={rowIndex} className="border-b border-border-color hover:bg-highlight">
                        {headers.map(header => (
                          <td
                            key={`${rowIndex}-${header}`}
                            className="px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none"
                            contentEditable
                            onBlur={(e) => handleCellChange(rowIndex, header, e.currentTarget.innerText)}
                            suppressContentEditableWarning={true}
                          >
                            {row[header] || ''}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="flex gap-4">
                <button onClick={onProcess} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  {processButtonText}
                </button>
                <button onClick={clearTable} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  Limpiar Tabla
                </button>
              </div>
            </section>
          );
        }

        const ReviewArea = ({
          data,
          templates,
          updateRow,
          incrementEdits,
          onSendToTracking,
          onPreview,
          onExportForMailMerge,
          onClearReviewData,
          sortConfig,
          setSortConfig,
        }) => {
          const [selectedRows, setSelectedRows] = useState(new Set());
          const [filter, setFilter] = useState('');
          
          const REVIEW_HEADERS = [
              { key: 'Fecha_Neg', label: 'Fecha de Negaci√≥n' },
              { key: 'No_Orden', label: 'N√∫mero de Orden' },
              { key: 'No_Cedula', label: 'N√∫mero de C√©dula' },
              { key: 'Nombre', label: 'Nombre Afiliado' },
              { key: 'EPS', label: 'EPS' },
              { key: 'Programa', label: 'Programa', compact: true },
              { key: 'Motivo_Negacion', label: 'Motivo Neg', compact: true },
              { key: 'Descripcion_PDF', label: 'Descripci√≥n', compact: true },
              { key: 'Justificacion_PDF', label: 'Justificaci√≥n', compact: true },
              { key: 'Fundamento_Legal_PDF', label: 'Fund. Legal', compact: true },
          ];

          const sortedData = useMemo(() => {
              const sortableItems = [...data];
              if (sortConfig.key) {
                  sortableItems.sort((a, b) => {
                      const aValue = a[sortConfig.key] || '';
                      const bValue = b[sortConfig.key] || '';
                      if (aValue < bValue) {
                          return sortConfig.direction === 'ascending' ? -1 : 1;
                      }
                      if (aValue > bValue) {
                          return sortConfig.direction === 'ascending' ? 1 : -1;
                      }
                      return 0;
                  });
              }
              return sortableItems;
          }, [data, sortConfig]);

          const filteredData = useMemo(() => {
            if (!filter) return sortedData;
            const lowercasedFilter = filter.toLowerCase();
            return sortedData.filter(row =>
              Object.values(row).some(value =>
                String(value).toLowerCase().includes(lowercasedFilter)
              )
            );
          }, [sortedData, filter]);

          const handleSelectRow = (noOrden) => {
            const newSelection = new Set(selectedRows);
            if (newSelection.has(noOrden)) {
              newSelection.delete(noOrden);
            } else {
              newSelection.add(noOrden);
            }
            setSelectedRows(newSelection);
          };

          const handleSelectAll = (e) => {
            if (e.target.checked) {
              const allOrderNumbers = filteredData.map(row => row.No_Orden).filter(Boolean);
              setSelectedRows(new Set(allOrderNumbers));
            } else {
              setSelectedRows(new Set());
            }
          };

          const handleCellBlur = (noOrden, key, value) => {
            const originalRow = data.find(r => r.No_Orden === noOrden);
            if (originalRow && originalRow[key] !== value) {
              updateRow(noOrden, { [key]: value });
              incrementEdits();
            }
          };
          
          const handleSelectChange = (noOrden, value) => {
            const changes = { Tipo_Carta: value };
            const template = templates.find(t => t.id === value);
            if (!template || !template.name.toUpperCase().includes('COMPLEMENTARIEDAD')) {
                // Si la nueva plantilla no es de Complementariedad, limpiar el radicado.
                changes.Radicado_Comp = ''; 
            }
            updateRow(noOrden, changes);
            incrementEdits();
          };

          const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                direction = 'descending';
            }
            setSortConfig({ key, direction });
          };
          
          const getSortIndicator = (key) => {
            if (sortConfig.key !== key) return null;
            return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
          };

          return (
            <section id="area3" className="space-y-4 py-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 3: Revisi√≥n Final y Exportaci√≥n</h2>
              <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input
                  type="text"
                  placeholder="Buscar en tabla de revisi√≥n..."
                  className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                  value={filter}
                  onChange={(e) => setFilter(e.target.value)}
                />
                <span className="text-text-primary">{selectedRows.size} fila(s) seleccionada(s)</span>
                <button 
                  onClick={() => onExportForMailMerge(filteredData)}
                  className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors ml-auto"
                >
                    Exportar para Mail Merge ({filteredData.length})
                </button>
                <button 
                    onClick={() => onSendToTracking(Array.from(selectedRows))}
                    disabled={selectedRows.size === 0}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:bg-gray-500"
                >
                    Mover a Seguimiento ({selectedRows.size})
                </button>
                <button 
                    onClick={onClearReviewData}
                    className="bg-danger hover:bg-danger-hover text-white font-bold py-2 px-4 rounded-lg transition-colors"
                >
                    Limpiar √Årea
                </button>
              </div>

              <div className="table-container max-h-[700px] overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary table-fixed">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      <th className="px-4 py-3 w-10"><input type="checkbox" onChange={handleSelectAll} checked={selectedRows.size === filteredData.length && filteredData.length > 0} /></th>
                      <th className="px-4 py-3 w-10">üëÅÔ∏è</th>
                        {REVIEW_HEADERS.map(({ key, label, compact }) => (
                          <th key={key} onClick={() => requestSort(key)} className={`px-4 py-3 cursor-pointer ${compact ? 'w-[150px]' : 'w-[100px]'} whitespace-nowrap`}>
                            {label}{getSortIndicator(key)}
                          </th>
                        ))}
                      <th className="px-4 py-3 w-[200px]">Tipo de Carta / Radicado</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((row, rowIndex) => {
                      const template = templates.find(t => t.id === row.Tipo_Carta);
                      const isComplementariedad = template && template.name.toUpperCase().includes('COMPLEMENTARIEDAD');
                      const requiresRadicado = isComplementariedad;
                      
                      const rowKey = row.No_Orden ? `key-${row.No_Orden}` : `new-${rowIndex}`;
                      const isMissingPdfData = !row.Descripcion_PDF && !row.Justificacion_PDF && !row.Fundamento_Legal_PDF;

                      return (
                        <tr key={rowKey} className={`border-b border-border-color hover:bg-highlight ${isComplementariedad ? 'bg-indigo-900/50' : isMissingPdfData ? 'bg-yellow-900/40' : ''}`}>
                          <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(row.No_Orden)} onChange={() => handleSelectRow(row.No_Orden)} /></td>
                          <td className="px-4 py-2 text-lg cursor-pointer text-center" onClick={() => onPreview(row)}>üëÅÔ∏è</td>
                          
                          {REVIEW_HEADERS.map(({ key, compact }) => (
                            <td key={`${rowKey}-${key}`}
                                className={`px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none overflow-hidden text-ellipsis whitespace-nowrap ${compact ? 'max-w-[150px]' : 'max-w-[100px]'}`}
                                contentEditable
                                onBlur={(e) => handleCellBlur(row.No_Orden, key, e.currentTarget.innerText)}
                                suppressContentEditableWarning={true}
                            >
                                {row[key]}
                            </td>
                          ))}

                          <td className="px-4 py-2">
                            <div className="flex flex-col gap-1 w-full">
                              <select 
                                value={row.Tipo_Carta || ''}
                                onChange={(e) => handleSelectChange(row.No_Orden, e.target.value)}
                                className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full"
                              >
                                <option value="">-- Seleccionar --</option>
                                {templates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                              </select>
                              {requiresRadicado && (
                                <input
                                  type="text"
                                  placeholder="Radicado..."
                                  value={row.Radicado_Comp || ''}
                                  onChange={(e) => {
                                      updateRow(row.No_Orden, { Radicado_Comp: e.target.value });
                                      incrementEdits();
                                    }}
                                  className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full mt-1"
                                />
                              )}
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                {filteredData.length === 0 && (
                    <div className="p-4 text-center text-text-secondary bg-surface">
                        No hay casos en revisi√≥n.
                    </div>
                )}
              </div>
            </section>
          );
        };

        const TrackingArea = ({
            title,
            data,
            updateRow,
            incrementEdits,
            onArchive,
            onExportToExcel,
            canArchive = true,
            statusOptions = TRACKING_STATUSES,
            sortConfig,
            setSortConfig,
        }) => {
            const [filter, setFilter] = useState('');

            const TRACKING_HEADERS = [
                { key: 'Fecha_Neg', label: 'Fecha Negaci√≥n' },
                { key: 'No_Orden', label: 'N√∫mero de Orden' },
                { key: 'Nombre', label: 'Nombre Afiliado' },
                { key: 'Motivo_Negacion', label: 'Motivo Neg.' },
                { key: 'Tipo_Carta', label: 'Tipo Carta' },
                { key: 'Radicado_Comp', label: 'Radicado' },
                { key: 'ESTADO', label: 'Estado' },
            ];
            
            const sortedData = useMemo(() => {
                const sortableItems = [...data];
                if (sortConfig.key) {
                    sortableItems.sort((a, b) => {
                        const aValue = a[sortConfig.key] || '';
                        const bValue = b[sortConfig.key] || '';
                        if (aValue < bValue) {
                            return sortConfig.direction === 'ascending' ? -1 : 1;
                        }
                        if (aValue > bValue) {
                            return sortConfig.direction === 'ascending' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return sortableItems;
            }, [data, sortConfig]);

            const filteredData = useMemo(() => {
                if (!filter) return sortedData;
                const lowercasedFilter = filter.toLowerCase();
                return sortedData.filter(row =>
                    Object.values(row).some(value =>
                        String(value).toLowerCase().includes(lowercasedFilter)
                    )
                );
            }, [sortedData, filter]);

            const handleStatusChange = (noOrden, newStatus) => {
                updateRow(noOrden, { ESTADO: newStatus });
                incrementEdits();
            };

            const handleRadicadoChange = (noOrden, value) => {
                 updateRow(noOrden, { Radicado_Comp: value });
                 incrementEdits();
            };

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };
            
            const getSortIndicator = (key) => {
                if (sortConfig.key !== key) return null;
                return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
            };

            return (
                <section id="area4" className="space-y-4 py-4">
                    <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">{title}</h2>
                    <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                        <input
                            type="text"
                            placeholder="Buscar en seguimiento..."
                            className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto"
                            value={filter}
                            onChange={(e) => setFilter(e.target.value)}
                        />
                        <button 
                            onClick={() => onExportToExcel(data, title)}
                            className="bg-success hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors ml-auto"
                        >
                            Exportar Tabla
                        </button>
                        {canArchive && (
                            <button 
                                onClick={onArchive}
                                className="bg-archive hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                            >
                                Archivar Casos Finalizados
                            </button>
                        )}
                    </div>

                    <div className="table-container max-h-[500px] overflow-auto border border-border-color rounded-lg">
                        <table className="w-full text-sm text-left text-text-secondary table-fixed">
                            <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                                <tr>
                                    {TRACKING_HEADERS.map(({ key, label }) => (
                                        <th key={key} onClick={() => requestSort(key)} className="px-4 py-3 cursor-pointer whitespace-nowrap">
                                            {label}{getSortIndicator(key)}
                                        </th>
                                    ))}
                                    <th className="px-4 py-3 w-[150px]">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredData.map((row, rowIndex) => (
                                    <tr key={row.No_Orden} className={`border-b border-border-color hover:bg-highlight ${row.ESTADO === 'Finalizado' ? 'bg-archive/50' : ''}`}>
                                        <td className="px-4 py-2 overflow-hidden text-ellipsis whitespace-nowrap max-w-[120px]">{row.Fecha_Neg}</td>
                                        <td className="px-4 py-2 overflow-hidden text-ellipsis whitespace-nowrap max-w-[120px]">{row.No_Orden}</td>
                                        <td className="px-4 py-2 overflow-hidden text-ellipsis whitespace-nowrap max-w-[180px]">{row.Nombre}</td>
                                        <td className="px-4 py-2 overflow-hidden text-ellipsis whitespace-nowrap max-w-[150px]">{row.Motivo_Negacion}</td>
                                        <td className="px-4 py-2 overflow-hidden text-ellipsis whitespace-nowrap max-w-[150px]">{row.Tipo_Carta}</td>
                                        <td className="px-4 py-2">
                                             <input
                                                type="text"
                                                value={row.Radicado_Comp || ''}
                                                placeholder="Radicado EPS"
                                                onChange={(e) => handleRadicadoChange(row.No_Orden, e.target.value)}
                                                className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full"
                                            />
                                        </td>
                                        <td className="px-4 py-2">
                                            <select 
                                                value={row.ESTADO || 'Pendiente'} 
                                                onChange={(e) => handleStatusChange(row.No_Orden, e.target.value)}
                                                className={`bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full ${row.ESTADO === 'Finalizado' ? 'bg-success/50' : row.ESTADO === 'En Gesti√≥n' ? 'bg-warning/50' : 'bg-gray-500/50'}`}
                                            >
                                                {statusOptions.map(status => (
                                                    <option key={status} value={status}>{status}</option>
                                                ))}
                                            </select>
                                        </td>
                                        <td className="px-4 py-2">
                                            {canArchive && (
                                                <button 
                                                    onClick={() => onArchive([row.No_Orden])}
                                                    className="bg-archive hover:bg-gray-600 text-white text-xs font-bold py-1 px-2 rounded transition-colors w-full"
                                                    disabled={row.ESTADO !== 'Finalizado'}
                                                >
                                                    Archivar
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filteredData.length === 0 && (
                            <div className="p-4 text-center text-text-secondary bg-surface">
                                No hay casos en seguimiento.
                            </div>
                        )}
                    </div>
                </section>
            );
        };

        const TemplateModal = ({ isOpen, onClose, templates, setTemplates, showNotification }) => {
            const [editingTemplate, setEditingTemplate] = useState(null);
            const [newTemplate, setNewTemplate] = useState({ name: '', body: '' });

            if (!isOpen) return null;

            const handleEdit = (template) => setEditingTemplate(template);
            const handleDelete = (id) => {
                const updatedTemplates = templates.filter(t => t.id !== id);
                setTemplates(updatedTemplates);
                showNotification({ message: 'Plantilla eliminada.', type: 'info' });
            };

            const handleSaveEdit = () => {
                if (!editingTemplate.name || !editingTemplate.body) {
                    showNotification({ message: 'Nombre y cuerpo de la plantilla son obligatorios.', type: 'warning' });
                    return;
                }
                const updatedTemplates = templates.map(t => 
                    t.id === editingTemplate.id ? editingTemplate : t
                );
                setTemplates(updatedTemplates);
                setEditingTemplate(null);
                showNotification({ message: 'Plantilla actualizada.', type: 'success' });
            };

            const handleAdd = () => {
                if (!newTemplate.name || !newTemplate.body) {
                    showNotification({ message: 'Nombre y cuerpo de la plantilla son obligatorios.', type: 'warning' });
                    return;
                }
                const newId = `tpl_${Date.now()}`;
                const updatedTemplates = [...templates, { ...newTemplate, id: newId }];
                setTemplates(updatedTemplates);
                setNewTemplate({ name: '', body: '' });
                showNotification({ message: 'Plantilla a√±adida.', type: 'success' });
            };

            const placeholderTags = ['Motivo_Negacion', 'Descripcion_PDF', 'Justificacion_PDF', 'Fundamento_Legal_PDF', 'Programa', 'EPS', 'Radicado_Comp', 'Oficina_Virtual_EPS', 'Nombre'];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-start overflow-y-auto p-4 sm:p-8">
                    <div className="bg-surface rounded-lg shadow-2xl w-full max-w-4xl mt-10">
                        <div className="p-6 border-b border-border-color flex justify-between items-center">
                            <h3 className="text-xl font-bold text-white">Gesti√≥n de Plantillas de Correo</h3>
                            <button onClick={onClose} className="text-xl text-text-secondary hover:text-white">&times;</button>
                        </div>
                        <div className="p-6 space-y-8">

                            {/* Seccion de Etiquetas Disponibles */}
                            <div className="bg-highlight p-4 rounded-md">
                                <h4 className="text-lg font-semibold text-primary mb-2">Etiquetas de Reemplazo Disponibles:</h4>
                                <p className="text-sm text-text-secondary">Usa estas etiquetas (Ej: `{{Nombre}}`) en el cuerpo del correo. Se reemplazar√°n autom√°ticamente con los datos del caso.</p>
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {placeholderTags.map(tag => (
                                        <span key={tag} className="bg-header text-text-primary text-xs px-2 py-1 rounded">
                                            {`{{${tag}}}`}
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {/* Secci√≥n para A√±adir Nueva Plantilla */}
                            <div className="space-y-4 border-t border-border-color pt-4">
                                <h4 className="text-xl font-bold text-success">A√±adir Nueva Plantilla</h4>
                                <input
                                    type="text"
                                    placeholder="Nombre de la Plantilla"
                                    value={newTemplate.name}
                                    onChange={(e) => setNewTemplate({ ...newTemplate, name: e.target.value })}
                                    className="bg-header border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                                />
                                <textarea
                                    placeholder="Cuerpo de la Plantilla (acepta c√≥digo HTML para formato como <br> y <b>)"
                                    value={newTemplate.body}
                                    onChange={(e) => setNewTemplate({ ...newTemplate, body: e.target.value })}
                                    className="bg-header border border-border-color rounded-md px-3 py-2 text-text-primary w-full min-h-[150px]"
                                ></textarea>
                                <button onClick={handleAdd} className="bg-success hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                    A√±adir Plantilla
                                </button>
                            </div>

                            {/* Lista de Plantillas Existentes */}
                            <div className="space-y-4 border-t border-border-color pt-4">
                                <h4 className="text-xl font-bold text-primary">Plantillas Existentes ({templates.length})</h4>
                                {templates.map(template => (
                                    <div key={template.id} className="bg-highlight p-3 rounded-md border border-border-color">
                                        {editingTemplate && editingTemplate.id === template.id ? (
                                            <div className="space-y-2">
                                                <input
                                                    type="text"
                                                    value={editingTemplate.name}
                                                    onChange={(e) => setEditingTemplate({ ...editingTemplate, name: e.target.value })}
                                                    className="bg-header border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                                                />
                                                <textarea
                                                    value={editingTemplate.body}
                                                    onChange={(e) => setEditingTemplate({ ...editingTemplate, body: e.target.value })}
                                                    className="bg-header border border-border-color rounded-md px-3 py-2 text-text-primary w-full min-h-[100px]"
                                                ></textarea>
                                                <div className="flex gap-2">
                                                    <button onClick={handleSaveEdit} className="bg-success hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded-lg">Guardar</button>
                                                    <button onClick={() => setEditingTemplate(null)} className="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-lg">Cancelar</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex justify-between items-center">
                                                <div className="flex-1 overflow-hidden">
                                                    <p className="font-semibold text-text-primary">{template.name}</p>
                                                    <p className="text-sm text-text-secondary truncate">{template.body}</p>
                                                </div>
                                                <div className="flex gap-2 ml-4">
                                                    <button onClick={() => handleEdit(template)} className="bg-primary hover:bg-btn-primary-hover text-white text-xs font-bold py-1 px-3 rounded-lg">Editar</button>
                                                    <button onClick={() => handleDelete(template.id)} className="bg-danger hover:bg-danger-hover text-white text-xs font-bold py-1 px-3 rounded-lg">Eliminar</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {templates.length === 0 && <p className="text-center text-text-secondary">No hay plantillas personalizadas.</p>}
                            </div>

                        </div>
                    </div>
                </div>
            );
        };


        const PreviewModal = ({ isOpen, onClose, data, templates }) => {
            if (!isOpen || !data) return null;

            const selectedTemplate = templates.find(t => t.id === data.Tipo_Carta);
            const templateBody = selectedTemplate ? selectedTemplate.body : 'Seleccione una plantilla.';
            
            const emailSubject = `Respuesta a Solicitud No. ${data.No_Orden || 'N/A'}`;
            const finalEmailBody = replacePlaceholders(templateBody, data) + COMMON_EMAIL_BODY + SIGNATURE;

            const handleCopy = () => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = finalEmailBody;
                document.body.appendChild(tempDiv);

                const range = document.createRange();
                range.selectNodeContents(tempDiv);

                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                try {
                    document.execCommand('copy');
                    alert('Contenido del correo copiado al portapapeles.');
                } catch (err) {
                    console.error('No se pudo copiar el texto: ', err);
                    alert('Error al copiar el contenido. Por favor, intente seleccionar y copiar manualmente.');
                }

                selection.removeAllRanges();
                document.body.removeChild(tempDiv);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-start overflow-y-auto p-4 sm:p-8">
                    <div className="bg-surface rounded-lg shadow-2xl w-full max-w-3xl mt-10">
                        <div className="p-6 border-b border-border-color flex justify-between items-center">
                            <h3 className="text-xl font-bold text-white">Previsualizaci√≥n de Correo y Copiado</h3>
                            <button onClick={onClose} className="text-xl text-text-secondary hover:text-white">&times;</button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div className="bg-highlight p-3 rounded-md border border-primary">
                                <p className="text-sm font-semibold text-text-primary">Asunto:</p>
                                <p className="text-text-secondary">{emailSubject}</p>
                            </div>

                            <div className="bg-highlight p-3 rounded-md border border-border-color min-h-[300px] max-h-[500px] overflow-y-auto">
                                <p className="text-sm font-semibold text-text-primary mb-2">Cuerpo del Correo (HTML):</p>
                                <div className="text-sm text-text-primary p-2 border border-border-color bg-background" 
                                    dangerouslySetInnerHTML={{ __html: finalEmailBody }}>
                                </div>
                            </div>

                            <div className="flex justify-between items-center pt-4">
                                <p className="text-sm text-text-secondary">Destinatario: {data.EMAIL || 'N/A'}</p>
                                <button onClick={handleCopy} className="bg-success hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                    Copiar Contenido HTML
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, sheetUrl, setSheetUrl, showNotification }) => {
            const [localUrl, setLocalUrl] = useState(sheetUrl);

            if (!isOpen) return null;

            const handleSave = () => {
                if (localUrl.trim().length < 20) {
                    showNotification({ message: 'URL del Google App Script inv√°lida o muy corta.', type: 'error' });
                    return;
                }
                setSheetUrl(localUrl.trim());
                onClose();
                showNotification({ message: 'URL de conexi√≥n guardada. Recarga la p√°gina para cargar datos nuevos.', type: 'success' });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-start overflow-y-auto p-4 sm:p-8">
                    <div className="bg-surface rounded-lg shadow-2xl w-full max-w-2xl mt-10">
                        <div className="p-6 border-b border-border-color flex justify-between items-center">
                            <h3 className="text-xl font-bold text-white">Configurar Conexi√≥n a Google Sheet</h3>
                            <button onClick={onClose} className="text-xl text-text-secondary hover:text-white">&times;</button>
                        </div>
                        <div className="p-6 space-y-4">
                            <p className="text-text-secondary">Introduce la URL desplegada de tu Web App de Google Apps Script para la comunicaci√≥n con Google Sheets.</p>
                            <input
                                type="text"
                                placeholder="Ej: https://script.google.com/macros/s/AKfycb..."
                                value={localUrl}
                                onChange={(e) => setLocalUrl(e.target.value)}
                                className="bg-header border border-border-color rounded-md px-3 py-2 text-text-primary w-full"
                            />
                            <div className="flex justify-end gap-2 pt-4">
                                <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                                <button onClick={handleSave} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar URL</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // =================================================================================
        // MAIN APP COMPONENT
        // =================================================================================
        function App() {
            // ---------------------------------------------------------------------------------
            // ESTADO Y HOOKS (Declarados primero para evitar el ReferenceError)
            // ---------------------------------------------------------------------------------
            const [portalData, setPortalData] = useState(Array(5).fill({}));
            const [pdfData, setPdfData] = useState(Array(5).fill({}));
            
            const [finalData, setFinalData] = useState([]);
            const [trackingData, setTrackingData] = useState([]);
            const [archivedData, setArchivedData] = useState([]);

            const [sheetUrl, setSheetUrl] = useState(localStorage.getItem('googleSheetUrl') || '');
            const [templates, setTemplates] = useState(loadTemplates);
            const [editsCount, setEditsCount] = useState(0);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);

            const [notification, setNotification] = useState(null);
            const [isTemplateModalOpen, setIsTemplateModalOpen] = useState(false);
            const [isPreviewModalOpen, setIsPreviewModalOpen] = useState(false);
            const [previewData, setPreviewData] = useState(null);
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
            const [sortConfigReview, setSortConfigReview] = useState({ key: 'Fecha_Neg', direction: 'ascending' });
            const [sortConfigTracking, setSortConfigTracking] = useState({ key: 'Fecha_Neg', direction: 'ascending' });
            const [sortConfigArchived, setSortConfigArchived] = useState({ key: 'Fecha_Neg', direction: 'ascending' });
            
            // ---------------------------------------------------------------------------------
            // HANDLERS B√ÅSICOS (Declarados antes de los callbacks complejos)
            // ---------------------------------------------------------------------------------
            
            const showNotification = useCallback((note) => {
                setNotification(note);
                setTimeout(() => setNotification(null), 5000);
            }, []);
            
            const incrementEdits = useCallback(() => {
                setEditsCount(prev => prev + 1);
            }, []);

            // ---------------------------------------------------------------------------------
            // L√ìGICA DE PROCESAMIENTO (Callbacks que usan los Handlers B√°sicos)
            // ---------------------------------------------------------------------------------

            // --- L√≥gica de Procesamiento del Portal (√Årea 1 -> √Årea 3) ---
            const processPortalData = useCallback(() => {
                const validPortalData = portalData.filter(row => Object.values(row).some(val => val));
                
                if (validPortalData.length === 0) {
                    showNotification({ message: 'Primero, pegue los datos del Portal (√Årea 1).', type: 'warning' });
                    return;
                }

                try {
                    const newFinalData = [];

                    validPortalData.forEach(portalRow => {
                        const portalKey = (portalRow["N√öMERO ORDEN"] || "").trim();

                        if (!portalKey) return; 

                        const newRow = {
                            No_Orden: portalKey,
                            Fecha_Neg: portalRow["FECHA NEGACI√ìN"] || '',
                            No_Cedula: portalRow["IDENTIFICACI√ìN AFILIADO"] || '',
                            Nombre: capitalizeWords(portalRow["NOMBRE AFILIADO"]),
                            EPS: portalRow.EPS || '',
                            Programa: portalRow.PROGRAMA || '', 
                            Motivo_Negacion: portalRow["MOTIVO NEGACI√ìN"] || '',

                            // Datos del PDF inicializados como vac√≠os (para ser complementados luego)
                            Descripcion_PDF: '', 
                            Justificacion_PDF: '', 
                            Fundamento_Legal_PDF: '',
                            Codigo: '',

                            // Otros campos
                            Fecha_Asignacion: portalRow.Fecha_Asignacion || '',
                            EJECUTIVO: portalRow.EJECUTIVO || '',
                            TIPO_DOCUMENTO: portalRow["TIPO DOCUMENTO"] || '',
                            EDAD: portalRow.EDAD || '',
                            PROCEDIMIENTO: portalRow.PROCEDIMIENTO || '',
                            PLAN: portalRow.PLAN || '',
                            Fecha_Ingreso: portalRow.Fecha_Ingreso || '',
                            EMAIL: portalRow.EMAIL || '',
                            CELULAR: portalRow.CELULAR || '',
                            REGIONAL: portalRow.REGIONAL || '',

                            ESTADO: 'Pendiente', 
                            Tipo_Carta: '', 
                            Radicado_Comp: '', 
                        };

                        newFinalData.push(newRow);
                    });

                    // Agrega nuevos datos
                    setFinalData(prev => {
                        const existingDataMap = new Map(prev.map(r => [r.No_Orden, r]));
                        newFinalData.forEach(newR => existingDataMap.set(newR.No_Orden, newR));
                        return Array.from(existingDataMap.values());
                    });
                    
                    setPortalData(Array(5).fill({})); 
                    
                    showNotification({ message: `¬°Procesamiento exitoso! Se han cargado ${newFinalData.length} caso(s) al √Årea de Revisi√≥n.`, type: 'success' });

                } catch (error) {
                    console.error("Error al procesar los datos del Portal:", error);
                    showNotification({ message: `Error al procesar los datos del Portal: ${error.message}`, type: 'error' });
                }
            }, [portalData, showNotification]);


            // --- L√≥gica de Procesamiento del PDF (√Årea 2 -> √Årea 3) ---
            const processPdfData = useCallback(() => {
                const validPdfData = pdfData.filter(row => Object.values(row).some(val => val));
                
                if (finalData.length === 0) {
                    showNotification({ message: 'El √Årea de Revisi√≥n (3) est√° vac√≠a. Primero procese los datos del Portal (√Årea 1).', type: 'warning' });
                    return;
                }
                
                if (validPdfData.length === 0) {
                    showNotification({ message: 'Primero, pegue los datos del PDF (√Årea 2).', type: 'warning' });
                    return;
                }
                
                try {
                    const pdfMap = new Map();
                    let updatedCount = 0;

                    validPdfData.forEach(row => {
                        const key = (row["Archivo (No. Orden)"] || "").trim();
                        if (key) {
                            pdfMap.set(key, row);
                        }
                    });

                    const updatedFinalData = finalData.map(finalRow => {
                        const finalKey = (finalRow.No_Orden || "").trim();
                        const pdfRow = pdfMap.get(finalKey);

                        if (pdfRow) {
                            updatedCount++;
                            return {
                                ...finalRow,
                                Descripcion_PDF: pdfRow["Descripci√≥n"] || finalRow.Descripcion_PDF,
                                Justificacion_PDF: pdfRow["Justificaci√≥n"] || finalRow.Justificacion_PDF,
                                Fundamento_Legal_PDF: pdfRow["Fundamento Legal"] || finalRow.Fundamento_Legal_PDF,
                                Codigo: pdfRow.C√≥digo || finalRow.Codigo,
                            };
                        }
                        return finalRow;
                    });

                    setFinalData(updatedFinalData);
                    
                    setPdfData(Array(5).fill({})); 
                    incrementEdits();
                    
                    showNotification({ message: `¬°Complementaci√≥n exitosa! Se actualizaron ${updatedCount} caso(s) en el √Årea de Revisi√≥n.`, type: 'success' });

                } catch (error) {
                    console.error("Error al procesar los datos del PDF:", error);
                    showNotification({ message: `Error al procesar los datos del PDF: ${error.message}`, type: 'error' });
                }
            }, [pdfData, finalData, incrementEdits, showNotification]);

            // --- Handlers de Actualizaci√≥n ---
            const updateReviewRow = useCallback((noOrden, newValues) => {
                setFinalData(prev => prev.map(row => 
                    row.No_Orden === noOrden ? { ...row, ...newValues } : row
                ));
            }, []);
            
            const updateTrackingRow = useCallback((noOrden, newValues) => {
                setTrackingData(prev => prev.map(row => 
                    row.No_Orden === noOrden ? { ...row, ...newValues } : row
                ));
            }, []);

            const updateArchivedRow = useCallback((noOrden, newValues) => {
                setArchivedData(prev => prev.map(row => 
                    row.No_Orden === noOrden ? { ...row, ...newValues } : row
                ));
            }, []);
            
            // --- Guardar en la Nube ---
            const handleSaveToCloud = async () => {
                if (!sheetUrl) {
                    showNotification({ message: 'Por favor, configure la URL de Google Apps Script.', type: 'error' });
                    return;
                }
                setIsSaving(true);
                try {
                    const dataToSave = {
                        finalData: finalData,
                        trackingData: trackingData,
                        archivedData: archivedData,
                    };
                    const result = await saveData(sheetUrl, dataToSave);
                    showNotification({ message: '¬°Datos guardados en la Nube exitosamente!', type: 'success' });
                    setEditsCount(0);
                } catch (error) {
                    console.error('Fallo al guardar datos:', error);
                    showNotification({ message: 'Error al guardar los datos. Revise su conexi√≥n y URL.', type: 'error' });
                } finally {
                    setIsSaving(false);
                }
            };
            
            // --- Mover a Seguimiento (√Årea 3 -> √Årea 4) ---
            const sendToTracking = useCallback((selectedOrders) => {
                if (selectedOrders.length === 0) {
                    showNotification({ message: 'Seleccione al menos una fila para enviar a seguimiento.', type: 'warning' });
                    return;
                }

                const rowsToMove = finalData.filter(row => selectedOrders.includes(row.No_Orden));
                const remainingRows = finalData.filter(row => !selectedOrders.includes(row.No_Orden));

                setTrackingData(prev => {
                    const existingOrders = new Set(prev.map(r => r.No_Orden));
                    const newRows = rowsToMove.filter(r => !existingOrders.has(r.No_Orden)).map(r => ({ ...r, ESTADO: 'Pendiente', Fecha_Envio_Seguimiento: new Date().toISOString().slice(0, 10) }));
                    return [...prev, ...newRows];
                });
                
                setFinalData(remainingRows);
                showNotification({ message: `${rowsToMove.length} caso(s) movido(s) a Seguimiento Activo.`, type: 'info' });
                incrementEdits();
            }, [finalData, incrementEdits, showNotification]);

            // --- Archivar Casos (√Årea 4 -> √Årea 5) ---
            const archiveTrackingCases = useCallback((ordersToArchive = []) => {
                let rowsToArchive = [];
                let remainingTracking = [];

                if (ordersToArchive.length > 0) {
                    rowsToArchive = trackingData.filter(row => ordersToArchive.includes(row.No_Orden) && row.ESTADO === 'Finalizado');
                    remainingTracking = trackingData.filter(row => !ordersToArchive.includes(row.No_Orden) || row.ESTADO !== 'Finalizado');
                } else {
                    rowsToArchive = trackingData.filter(row => row.ESTADO === 'Finalizado');
                    remainingTracking = trackingData.filter(row => row.ESTADO !== 'Finalizado');
                }
                
                if (rowsToArchive.length === 0) {
                    showNotification({ message: 'No hay casos "Finalizado" para archivar.', type: 'warning' });
                    return;
                }

                setArchivedData(prev => [...prev, ...rowsToArchive.map(r => ({ ...r, Fecha_Archivo: new Date().toISOString().slice(0, 10) }))]);
                setTrackingData(remainingTracking);
                showNotification({ message: `${rowsToArchive.length} caso(s) archivado(s).`, type: 'info' });
                incrementEdits();
            }, [trackingData, incrementEdits, showNotification]);

            // --- Exportar para Mail Merge (CR√çTICO: FORMATO) ---
            const exportForMailMerge = useCallback((dataToExport) => {
                if (dataToExport.length === 0) {
                    showNotification({ message: 'No hay datos para exportar.', type: 'warning' });
                    return;
                }

                const mailMergeHeaders = MAIL_MERGE_HEADERS;
                
                const exportableData = dataToExport.map(row => {
                    const template = templates.find(t => t.id === row.Tipo_Carta);
                    const templateName = template ? template.name : 'Sin Plantilla';

                    return mailMergeHeaders.reduce((acc, header) => {
                        const rowValue = row[header] || '';
                        
                        if (header === 'Tipo_Carta') {
                            acc[header] = templateName;
                        } else if (header === 'Fecha_Neg') {
                            acc[header] = rowValue.split(' ')[0]; 
                        }
                         else {
                            acc[header] = rowValue;
                        }
                        return acc;
                    }, {});
                });

                try {
                    const ws = XLSX.utils.json_to_sheet(exportableData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "MailMerge_Revision");
                    XLSX.writeFile(wb, `MailMerge_Revision_${new Date().toISOString().slice(0, 10)}.xlsx`);
                    showNotification({ message: 'Archivo de Mail Merge generado con √©xito.', type: 'success' });
                } catch (error) {
                    console.error("Fallo la exportaci√≥n para Mail Merge:", error);
                    showNotification({ message: 'Error al generar el archivo de Mail Merge.', type: 'error' });
                }
            }, [showNotification, templates]);


            // ---------------------------------------------------------------------------------
            // EFECTOS DE MONTAJE Y SINCRONIZACI√ìN
            // ---------------------------------------------------------------------------------
            
            useEffect(() => {
                const loadData = async () => {
                    if (!sheetUrl) {
                        setIsLoading(false);
                        showNotification({ message: 'Configure la URL de Google Apps Script para cargar datos.', type: 'info' });
                        return;
                    }
                    try {
                        setIsLoading(true);
                        const data = await fetchData(sheetUrl);
                        setFinalData(data.finalData || []);
                        setTrackingData(data.trackingData || []);
                        setArchivedData(data.archivedData || []);
                        setEditsCount(0);
                        showNotification({ message: 'Datos cargados exitosamente desde la nube.', type: 'success' });
                    } catch (error) {
                        console.error('Fallo al cargar datos:', error);
                        showNotification({ message: 'Error al cargar datos. Verifique la URL de conexi√≥n.', type: 'error' });
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadData();
            }, [sheetUrl, showNotification]);

            useEffect(() => {
                saveTemplates(templates);
            }, [templates]);
            
            useEffect(() => {
                if (sheetUrl) {
                    localStorage.setItem('googleSheetUrl', sheetUrl);
                } else {
                    localStorage.removeItem('googleSheetUrl');
                }
            }, [sheetUrl]);


            // ---------------------------------------------------------------------------------
            // RENDERIZADO
            // ---------------------------------------------------------------------------------

            if (isLoading) {
                return (
                    <div className="flex justify-center items-center h-screen flex-col gap-4">
                        <Spinner />
                        <p className="text-xl text-text-primary">Cargando datos iniciales...</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* Modales */}
                    <TemplateModal 
                        isOpen={isTemplateModalOpen} 
                        onClose={() => setIsTemplateModalOpen(false)} 
                        templates={templates}
                        setTemplates={setTemplates}
                        showNotification={showNotification}
                    />
                    <PreviewModal 
                        isOpen={isPreviewModalOpen} 
                        onClose={() => setIsPreviewModalOpen(false)} 
                        data={previewData}
                        templates={templates}
                    />
                    <ConfigModal
                        isOpen={isConfigModalOpen}
                        onClose={() => setIsConfigModalOpen(false)}
                        sheetUrl={sheetUrl}
                        setSheetUrl={setSheetUrl}
                        showNotification={showNotification}
                    />

                    {/* Notificaci√≥n */}
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {/* Encabezado */}
                    <Header 
                        onSave={handleSaveToCloud} 
                        onManageTemplates={() => setIsTemplateModalOpen(true)} 
                        onReconfigure={() => setIsConfigModalOpen(true)}
                        isSaving={isSaving}
                    />

                    {/* Dashboard */}
                    <Dashboard 
                        reviewCount={finalData.length} 
                        trackingCount={trackingData.length} 
                        archivedCount={archivedData.length} 
                        editsCount={editsCount} 
                    />

                    <hr className="border-border-color" />
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* √Årea 1: Datos del Portal */}
                        <DataInputArea
                            id="area1"
                            title="√Årea 1: Pegar Datos del Portal"
                            headers={PORTAL_HEADERS}
                            data={portalData}
                            onDataChange={setPortalData}
                            onProcess={processPortalData}
                            processButtonText="1. Enviar a Revisi√≥n (√Årea 3)"
                        />

                        {/* √Årea 2: Datos del PDF */}
                        <DataInputArea
                            id="area2"
                            title="√Årea 2: Pegar Datos del PDF (Complemento)"
                            headers={PDF_HEADERS}
                            data={pdfData}
                            onDataChange={setPdfData}
                            onProcess={processPdfData}
                            processButtonText="2. Complementar Revisi√≥n (√Årea 3)"
                        />
                    </div>

                    <hr className="border-border-color" />

                    {/* √Årea 3: Revisi√≥n Final y Exportaci√≥n */}
                    <ReviewArea 
                        data={finalData}
                        templates={templates}
                        updateRow={updateReviewRow}
                        incrementEdits={incrementEdits}
                        onSendToTracking={sendToTracking}
                        onPreview={setPreviewData}
                        onExportForMailMerge={exportForMailMerge}
                        onClearReviewData={() => {setFinalData([]); incrementEdits();}}
                        sortConfig={sortConfigReview}
                        setSortConfig={setSortConfigReview}
                    />

                    <hr className="border-border-color" />

                    {/* √Årea 4: Seguimiento Activo */}
                    <TrackingArea
                        title="√Årea 4: Seguimiento Activo"
                        data={trackingData}
                        updateRow={updateTrackingRow}
                        incrementEdits={incrementEdits}
                        onArchive={archiveTrackingCases}
                        onExportToExcel={(data, title) => exportDetailedReport([], data, [])}
                        sortConfig={sortConfigTracking}
                        setSortConfig={setSortConfigTracking}
                    />

                    <hr className="border-border-color" />

                    {/* √Årea 5: Archivo */}
                    <TrackingArea
                        title="√Årea 5: Archivo"
                        data={archivedData}
                        updateRow={updateArchivedRow}
                        incrementEdits={incrementEdits}
                        onArchive={() => showNotification({ message: 'Los casos archivados no se pueden archivar m√°s.', type: 'info' })}
                        onExportToExcel={(data, title) => exportDetailedReport([], [], data)}
                        canArchive={false}
                        sortConfig={sortConfigArchived}
                        setSortConfig={setSortConfigArchived}
                    />
                </div>
            );
        }

        // Renderiza la aplicaci√≥n
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
