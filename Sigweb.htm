<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GESTION NEGACIONES EJE CAFETERO (MODO LOCAL)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <script>
      // Configuraci√≥n de colores y estilos (Tailwind)
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4e9fef',
              'background': '#1e1e1e',
              'surface': '#2d2d2d',
              'text-primary': '#d4d4d4',
              'text-secondary': '#a0a0a0',
              'border-color': '#444',
              'header': '#3a3a3a',
              'highlight': '#252526',
              'warning': '#6e550c',
              'archive': '#3a3a3a',
              'success': '#28a745',
              'danger': '#a02d2d',
              'danger-hover': '#c0392b',
              'btn-primary': '#0e639c',
              'btn-primary-hover': '#1a73e8',
            },
            animation: {
              'flash-success': 'flash-success 1s ease-out',
            },
            keyframes: {
              'flash-success': {
                'from': { backgroundColor: '#28a745' },
                'to': { backgroundColor: 'transparent' },
              }
            }
          }
        }
      }
    </script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-background text-text-primary">
    <div id="root"></div>

    <script type="text/babel" data-presets="react" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom/client'; 

        // =================================================================================
        // CONSTANTES Y DATOS
        // =================================================================================
        
        const PORTAL_HEADERS = [
          "Fecha_Asignacion", "EJECUTIVO", "FECHA NEGACI√ìN", "REGIONAL", "N√öMERO ORDEN", 
          "TIPO DOCUMENTO", "IDENTIFICACI√ìN AFILIADO", "NOMBRE AFILIADO", "EDAD", 
          "PROCEDIMIENTO", "MOTIVO NEGACI√ìN", "PLAN", "PROGRAMA", "EPS", 
          "Fecha_Ingreso", "EMAIL", "CELULAR", "ESTADO"
        ];

        const PDF_HEADERS = [
          "Archivo (No. Orden)", "Descripci√≥n", "Justificaci√≥n", "Fundamento Legal", "C√≥digo"
        ];

        const TRACKING_STATUSES = ['Pendiente', 'En Gesti√≥n', 'Finalizado'];
        
        const COMMON_EMAIL_BODY = `<br><br><b>Si tiene alguna duda puede contactarse por medio de los canales que tenemos disponibles para usted:</b><br>¬∑ Nuestra l√≠nea nacional 018000931666. O con nuestras l√≠neas locales: Cali (602) 489 0073, Bogot√° (601) 743 5485, Medell√≠n (604) 604 4507, Barranquilla (605) 385 3165, Bucaramanga (607) 697 3350, Cartagena (605) 693 9853, Tulu√° (602) 235 9483, Valledupar (605)588 5699, Pereira (606) 340 2635.<br>¬∑ WhatsApp: 317-224-07-94<br><br>Gracias por su Atenci√≥n.`;
        const SIGNATURE = `<br><br>Cordialmente,<br><br><b>Juan Ricardo Morales Agudelo</b><br>Ejecutivo De Atenci√≥n Integral<br>Coomeva Medicina Prepagada<br>Cra. 13 No.11-12 Centro M√©dico Circunvalar<br>Coomeva Medicina Prepagada Pereira, Risaralda<br><br><i>Este correo es generado autom√°ticamente, por favor no responda este mensaje.</i>`;

        const defaultTemplates = [
            { id: 'tpl_neg_gen', name: 'PLANTILLA NEGACION GENERAL', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad no est√° aprobado debido a que corresponde a EXCLUSI√ìN ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El servicio negado anteriormente; debe tramitarlo a trav√©s su EPS asignada. Adjuntamos soporte de la carta de negaci√≥n.` },
            { id: 'tpl_neg_pert', name: 'PLANTILLA NO PERTINENCIA Y TEMAS ESTETICOS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio {{Motivo_Negacion}} que en esta oportunidad No est√° aprobado debido a que corresponde a NO PERTINENCIA ({{Descripcion_PDF}}), ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>` },
            { id: 'tpl_comp_coinc', name: 'COMPLEMENTARIEDAD RED COINCIDENTE', body: `Apreciado Usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y el de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no fue aprobado, debido a que ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, est√° en gesti√≥n a trav√©s de su EPS ({{EPS}}) con el n√∫mero de radicado ({{Radicado_Comp}}), puede realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).<br><br>Adicional estaremos haciendo seguimiento al radicado y una vez se encuentre gestionado por la EPS, le notificaremos por medio de correo electr√≥nico.` },
            { id: 'tpl_comp_no_coinc', name: 'COMPLEMENTARIEDAD RED NO COINCIDENTE', body: `Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado, debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>El prestador actual solicitado, no tiene convenio con la EPS, por lo que los costos adicionales del servicio o insumo estar√°n a cargo del paciente. Sin embargo; se radica la solicitud ante su EPS con el n√∫mero ({{Radicado_Comp}}) por favor realizar seguimiento mediante la oficina virtual de la EPS ({{Oficina_Virtual_EPS}}).` },
            { id: 'tpl_comp_ayudas', name: 'COMPLEMENTARIEDAD AYUDAS DIAGNOSTICAS', body: `Apreciado usuario;<br><br>Agradecemos la confianza que ha depositado en nosotros al confiar el cuidado de su salud y la de su familia. Por medio de este correo queremos brindar informaci√≥n acerca del servicio ({{Descripcion_PDF}}) que en esta oportunidad no est√° aprobado debido a que corresponde a ({{Justificacion_PDF}}), ({{Fundamento_Legal_PDF}}).<br><br>Sin embargo, se encuentra en gesti√≥n a trav√©s de su EPS con el n√∫mero de radicado ({{Radicado_Comp}}), por favor realizar seguimiento mediante la oficina virtual. ({{Oficina_Virtual_EPS}}).` },
        ];

        // =================================================================================
        // UTILIDADES Y FUNCIONES L√ìGICAS
        // =================================================================================
        const capitalizeWords = (str) => {
          if (!str) return '';
          return String(str).toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        };

        const processPastedData = (pastedText, headers) => {
          return pastedText
            .trim()
            .split(/\r?\n/)
            .map(rowText => {
              const cells = rowText.split('\t');
              const rowObject = {};
              headers.forEach((header, index) => {
                if (cells[index]) {
                  rowObject[header] = cells[index].trim();
                }
              });
              return rowObject;
            });
        };

        const replacePlaceholders = (templateBody, data) => {
          const getOficinaVirtual = (eps) => {
            const e = (eps || "").toUpperCase();
            if (e.includes("NUEVA EPS")) return `<a href='https://portal.nuevaeps.com.co/Portal/home.jspx' target='_blank' rel='noopener noreferrer'>NUEVA EPS</a>`;
            if (e.includes("SALUD TOTAL")) return `<a href='https://saludtotal.com.co/' target='_blank' rel='noopener noreferrer'>SALUD TOTAL</a>`;
            return eps;
          };
          const fullData = { ...data, Oficina_Virtual_EPS: getOficinaVirtual(data.EPS) };
          return templateBody.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return fullData[key] || match;
          });
        };

        const exportDetailedReport = (finalData, trackingData, archivedData) => {
          try {
            const masterDataMap = new Map();
            [...finalData, ...trackingData, ...archivedData].forEach(row => {
              if (row.No_Orden) {
                const key = String(row.No_Orden).trim();
                const existing = masterDataMap.get(key) || {};
                masterDataMap.set(key, { ...existing, ...row });
              }
            });
            const masterData = Array.from(masterDataMap.values());
            if (masterData.length === 0) { alert("No hay datos consolidados para exportar."); return; }

            const wb = XLSX.utils.book_new();
            if (finalData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(finalData), "Casos en Revisi√≥n");
            if (trackingData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(trackingData), "Seguimiento Activo");
            if (archivedData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(archivedData), "Seguimiento Archivado");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(masterData), "Maestro Consolidado");
            XLSX.writeFile(wb, `Sigweb_Reporte_Detallado_${new Date().toISOString().slice(0, 10)}.xlsx`);
          } catch (error) {
            console.error("Fall√≥ la exportaci√≥n del reporte Excel:", error);
            alert("Ocurri√≥ un error al generar el reporte.");
          }
        };

        // =================================================================================
        // SISTEMA DE ALMACENAMIENTO LOCAL (SIN GOOGLE)
        // =================================================================================
        const TEMPLATE_STORAGE_KEY = 'sigweb_emailTemplates';
        const DATA_STORAGE_KEY = 'sigweb_local_db'; // Nueva clave para guardar los datos

        const loadTemplates = () => {
          try {
            const storedTemplates = localStorage.getItem(TEMPLATE_STORAGE_KEY);
            if (storedTemplates) {
              const parsed = JSON.parse(storedTemplates);
              if (Array.isArray(parsed) && parsed.length > 0) return parsed;
            }
          } catch (error) { localStorage.removeItem(TEMPLATE_STORAGE_KEY); }
          return defaultTemplates;
        };

        const saveTemplates = (templates) => {
          try { localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates)); } catch (error) {}
        };

        // --- FUNCIONES MODIFICADAS PARA USAR LOCALSTORAGE ---
        const loadLocalData = () => {
            try {
                const savedData = localStorage.getItem(DATA_STORAGE_KEY);
                if (savedData) {
                    return JSON.parse(savedData);
                }
            } catch (e) { console.error("Error leyendo datos locales", e); }
            // Si no hay datos, retornar estructura vac√≠a
            return { finalData: [], trackingData: [], archivedData: [] };
        };

        const saveLocalData = (data) => {
            try {
                localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(data));
                return { status: 'success' };
            } catch (e) {
                console.error("Error guardando datos locales", e);
                throw e;
            }
        };

        // =================================================================================
        // COMPONENTES (UI)
        // =================================================================================
        
        const Spinner = () => (
          <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent align-[-0.125em]" role="status">
            <span className="sr-only">Cargando...</span>
          </div>
        );

        const Notification = ({ message, type, onClose }) => {
          const typeClasses = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500', info: 'bg-blue-600' };
          return (
            <div className={`fixed top-5 right-5 z-50 p-4 rounded-lg shadow-lg text-white ${typeClasses[type]} flex items-center gap-4`}>
              <span>{message}</span>
              <button onClick={onClose} className="text-xl font-bold">&times;</button>
            </div>
          );
        };

        // Header modificado para quitar el bot√≥n "Reconfigurar" que ya no sirve
        const Header = ({ onSave, onManageTemplates }) => {
          return (
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-border-color">
              <div>
                <h1 className="text-3xl font-bold text-white">GESTION NEGACIONES EJE CAFETERO</h1>
                <p className="text-text-secondary">Sistema Local - Datos guardados en navegador</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onManageTemplates} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">
                  Gestionar Plantillas
                </button>
                <button onClick={onSave} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M5.5 16.5a2.5 2.5 0 01-5 0V4.414a1.5 1.5 0 01.44-1.06L4.354.439A1.5 1.5 0 015.414 0H12.5a2.5 2.5 0 012.5 2.5v2" />
                      <path d="M5.5 16.5h8a2.5 2.5 0 002.5-2.5V8.5h-13v5.5a2.5 2.5 0 002.5 2.5z" />
                      <path d="M10.5 10a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" />
                  </svg>
                  Guardar Cambios
                </button>
              </div>
            </header>
          );
        };

        const DashboardCard = ({ title, value, icon }) => (
          <div className="bg-surface p-4 rounded-lg border border-border-color flex items-center">
            <div className="text-3xl text-primary mr-4">{icon}</div>
            <div>
              <h4 className="text-sm font-semibold text-text-secondary uppercase tracking-wider">{title}</h4>
              <p className="text-2xl font-bold text-text-primary">{value}</p>
            </div>
          </div>
        );

        const Dashboard = ({ reviewCount, trackingCount, archivedCount, editsCount }) => (
          <section id="dashboard" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <DashboardCard title="Casos en Revisi√≥n" value={reviewCount} icon={'üìã'} />
            <DashboardCard title="Seguimiento Activo" value={trackingCount} icon={'‚è≥'} />
            <DashboardCard title="Casos Archivados" value={archivedCount} icon={'üóÑÔ∏è'} />
            <DashboardCard title="Ediciones No Guardadas" value={editsCount} icon={'‚úèÔ∏è'} />
          </section>
        );

        function DataInputArea({ id, title, headers, data, onDataChange, onProcess, processButtonText = "Procesar Datos" }) {
          const handlePaste = useCallback((e) => {
            e.preventDefault();
            const pastedText = e.clipboardData.getData('text/plain');
            const newRows = processPastedData(pastedText, headers);
            const updatedData = [...data.filter(row => Object.values(row).some(val => val)), ...newRows];
            const emptyRowCount = updatedData.filter(row => !Object.values(row).some(val => val)).length;
            if (emptyRowCount < 5) { for (let i = 0; i < (5 - emptyRowCount); i++) updatedData.push({}); }
            onDataChange(updatedData);
          }, [data, headers, onDataChange]);

          const handleCellChange = (rowIndex, header, value) => {
            const newData = [...data];
            newData[rowIndex] = { ...newData[rowIndex], [header]: value };
            const emptyRowCount = newData.filter(row => !Object.values(row).some(val => val)).length;
            if (emptyRowCount < 5) newData.push({});
            onDataChange(newData);
          };
          
          const clearTable = () => onDataChange(Array(5).fill({}));

          return (
            <section id={id} className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">{title}</h2>
              <div className="table-container max-h-72 overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>{headers.map(header => (<th key={header} scope="col" className="px-4 py-3 whitespace-nowrap">{header}</th>))}</tr>
                  </thead>
                  <tbody onPaste={handlePaste}>
                    {data.map((row, rowIndex) => (
                      <tr key={rowIndex} className="border-b border-border-color hover:bg-highlight">
                        {headers.map(header => (
                          <td key={`${rowIndex}-${header}`} className="px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none" contentEditable onBlur={(e) => handleCellChange(rowIndex, header, e.currentTarget.innerText)} suppressContentEditableWarning={true}>
                            {row[header] || ''}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="flex gap-4">
                <button onClick={onProcess} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">{processButtonText}</button>
                <button onClick={clearTable} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Limpiar Tabla</button>
              </div>
            </section>
          );
        }

        const ReviewArea = ({ data, templates, updateRow, incrementEdits, onSendToTracking, onPreview, onExportForMailMerge, onClearReviewData, sortConfig, setSortConfig }) => {
          const [selectedRows, setSelectedRows] = useState(new Set());
          const [filter, setFilter] = useState('');
          
          const REVIEW_HEADERS = [
              { key: 'Fecha_Neg', label: 'Fecha de Negaci√≥n' },
              { key: 'No_Orden', label: 'N√∫mero de Orden' },
              { key: 'No_Cedula', label: 'N√∫mero de C√©dula' },
              { key: 'Nombre', label: 'Nombre Afiliado' },
              { key: 'EPS', label: 'EPS' },
              { key: 'Programa', label: 'Programa', compact: true },
              { key: 'Motivo_Negacion', label: 'Motivo Neg', compact: true },
              { key: 'Descripcion_PDF', label: 'Descripci√≥n', compact: true },
              { key: 'Justificacion_PDF', label: 'Justificaci√≥n', compact: true },
              { key: 'Fundamento_Legal_PDF', label: 'Fund. Legal', compact: true },
          ];

          const filteredData = useMemo(() => {
            if (!filter) return data;
            const lowercasedFilter = filter.toLowerCase();
            return data.filter(row => Object.values(row).some(value => String(value).toLowerCase().includes(lowercasedFilter)));
          }, [data, filter]);

          const handleSelectRow = (noOrden) => {
            const newSelection = new Set(selectedRows);
            if (newSelection.has(noOrden)) newSelection.delete(noOrden); else newSelection.add(noOrden);
            setSelectedRows(newSelection);
          };

          const handleSelectAll = (e) => {
            if (e.target.checked) setSelectedRows(new Set(filteredData.map(row => row.No_Orden))); else setSelectedRows(new Set());
          };

          const handleCellBlur = (noOrden, key, value) => {
            const originalRow = data.find(r => r.No_Orden === noOrden);
            if (originalRow && originalRow[key] !== value) {
              updateRow(noOrden, { [key]: value });
              incrementEdits();
            }
          };
          
          const handleSelectChange = (noOrden, value) => {
            const changes = { Tipo_Carta: value };
            const template = templates.find(t => t.id === value);
            if (!template || !template.name.toUpperCase().includes('COMPLEMENTARIEDAD')) changes.Radicado_Comp = '';
            updateRow(noOrden, changes);
            incrementEdits();
          };

          const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') direction = 'descending';
            setSortConfig({ key, direction });
          };
          
          const getSortIndicator = (key) => {
            if (sortConfig.key !== key) return null;
            return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
          };

          return (
            <section id="area3" className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 3: Revisi√≥n Final y Exportaci√≥n</h2>
              <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input type="text" placeholder="Buscar en tabla de revisi√≥n..." className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto" value={filter} onChange={(e) => setFilter(e.target.value)} />
                <span className="text-text-primary">{selectedRows.size} fila(s) seleccionada(s)</span>
              </div>

              <div className="table-container max-h-[700px] overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary table-auto">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      <th className="px-4 py-3"><input type="checkbox" onChange={handleSelectAll} checked={selectedRows.size === filteredData.length && filteredData.length > 0} /></th>
                      <th className="px-4 py-3">üëÅÔ∏è</th>
                        {REVIEW_HEADERS.map(({ key, label, compact }) => (
                          <th key={key} onClick={() => requestSort(key)} className={`px-4 py-3 cursor-pointer ${compact ? 'max-w-[150px]' : ''}`}>{label}{getSortIndicator(key)}</th>
                        ))}
                      <th className="px-4 py-3">Tipo de Carta</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((row, rowIndex) => {
                      const template = templates.find(t => t.id === row.Tipo_Carta);
                      const isComplementariedad = template && template.name.toUpperCase().includes('COMPLEMENTARIEDAD');
                      const rowKey = `${row.No_Orden || 'new'}-${rowIndex}`;
                      return (
                        <tr key={rowKey} className={`border-b border-border-color hover:bg-highlight ${isComplementariedad ? 'bg-indigo-900/50' : ''}`}>
                          <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(row.No_Orden)} onChange={() => handleSelectRow(row.No_Orden)} /></td>
                          <td className="px-4 py-2 text-lg cursor-pointer" onClick={() => onPreview(row)}>üëÅÔ∏è</td>
                          {REVIEW_HEADERS.map(({ key, compact }) => (
                            <td key={`${rowKey}-${key}`} className={`px-4 py-2 border-r border-border-color focus:bg-primary focus:text-black outline-none ${compact ? 'max-w-[150px] overflow-hidden text-ellipsis whitespace-nowrap' : ''}`} contentEditable onBlur={(e) => handleCellBlur(row.No_Orden, key, e.currentTarget.innerText)} suppressContentEditableWarning={true}>{row[key]}</td>
                          ))}
                          <td className="px-4 py-2">
                            <div className="flex flex-col gap-1">
                              <select value={row.Tipo_Carta || ''} onChange={(e) => handleSelectChange(row.No_Orden, e.target.value)} className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full">
                                <option value="">-- Seleccionar --</option>
                                {templates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                              </select>
                              {isComplementariedad && (
                                <input type="text" placeholder="Radicado..." value={row.Radicado_Comp || ''} onChange={(e) => { updateRow(row.No_Orden, { Radicado_Comp: e.target.value }); incrementEdits(); }} className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary w-full mt-1" />
                              )}
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              <div className="flex flex-wrap gap-4">
                <button onClick={() => onSendToTracking(Array.from(selectedRows))} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">Enviar a Seguimiento</button>
                 <button onClick={() => onExportForMailMerge(data)} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Exportar para Env√≠o Masivo</button>
                <button onClick={onClearReviewData} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Limpiar Tabla de Revisi√≥n</button>
              </div>
            </section>
          );
        };

        const TrackingTable = ({ data, isArchived, onUpdate, onArchive, filter }) => {
          const [selectedRows, setSelectedRows] = useState(new Set());
          const statusClasses = { 'Pendiente': 'bg-yellow-600/20', 'En Gesti√≥n': 'bg-blue-600/20', 'Finalizado': 'bg-green-600/20' };

          const filteredData = useMemo(() => {
            if (!filter) return data;
            const lowercasedFilter = filter.toLowerCase();
            return data.filter(row => Object.values(row).some(value => String(value).toLowerCase().includes(lowercasedFilter)));
          }, [data, filter]);

          const handleSelectRow = (index) => {
            const newSelection = new Set(selectedRows);
            if (newSelection.has(index)) newSelection.delete(index); else newSelection.add(index);
            setSelectedRows(newSelection);
          };
          
          const handleSelectAll = (e) => {
            if (e.target.checked) setSelectedRows(new Set(filteredData.map((_, index) => index))); else setSelectedRows(new Set());
          };
          
          const handleBulkArchive = () => {
            if (selectedRows.size > 0) { onArchive(Array.from(selectedRows)); setSelectedRows(new Set()); }
          };

          return (
            <div className="space-y-4">
              <div className="flex justify-end">
                   {selectedRows.size > 0 && (<button onClick={handleBulkArchive} className="bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg transition-colors">{isArchived ? `Restaurar ${selectedRows.size} Seleccionados` : `Archivar ${selectedRows.size} Seleccionados`}</button>)}
              </div>
              <div className="table-container max-h-[400px] overflow-auto border border-border-color rounded-lg">
                <table className="w-full text-sm text-left text-text-secondary">
                  <thead className="text-xs text-text-primary uppercase bg-header sticky top-0">
                    <tr>
                      <th className="px-4 py-3"><input type="checkbox" onChange={handleSelectAll} checked={selectedRows.size === filteredData.length && filteredData.length > 0}/></th>
                      <th className="px-4 py-3">Fecha_Neg</th><th className="px-4 py-3">No_Orden</th><th className="px-4 py-3">No_Cedula</th><th className="px-4 py-3">Nombre</th><th className="px-4 py-3">EPS</th><th className="px-4 py-3">Radicado</th><th className="px-4 py-3">Estado</th><th className="px-4 py-3">Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((row, index) => {
                      const originalIndex = data.indexOf(row);
                      return (
                        <tr key={originalIndex} className={`border-b border-border-color hover:bg-highlight transition-colors ${isArchived ? 'bg-archive/50 text-text-secondary' : statusClasses[row.Estado] || ''}`}>
                          <td className="px-4 py-2"><input type="checkbox" checked={selectedRows.has(originalIndex)} onChange={() => handleSelectRow(originalIndex)} /></td>
                          <td className="px-4 py-2">{row.Fecha_Ing}</td><td className="px-4 py-2">{row.No_Orden}</td><td className="px-4 py-2">{row.No_Cedula}</td><td className="px-4 py-2">{row.Nombre}</td><td className="px-4 py-2">{row.EPS}</td><td className="px-4 py-2">{row.Radicado}</td>
                          <td className="px-4 py-2">
                            <select value={row.Estado} onChange={e => onUpdate(originalIndex, { ...row, Estado: e.target.value })} className="bg-surface border border-border-color rounded-md px-2 py-1 text-text-primary">
                              {TRACKING_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                          </td>
                          <td className="px-4 py-2 text-lg cursor-pointer" onClick={() => onArchive([originalIndex])}>{isArchived ? '‚ôªÔ∏è' : 'üóÑÔ∏è'}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        const TrackingArea = ({ trackingData, archivedData, updateTrackingData, archiveItems, onExportComplementariedades }) => {
          const [showArchived, setShowArchived] = useState(false);
          const [filter, setFilter] = useState('');

          return (
            <section id="area4" className="space-y-4">
              <h2 className="text-2xl font-bold text-primary border-b border-border-color pb-2">√Årea 4: Seguimiento</h2>
              <div className="action-bar bg-highlight p-4 rounded-lg flex flex-wrap items-center gap-4">
                <input type="text" placeholder="Buscar en seguimiento..." className="bg-surface border border-border-color rounded-md px-3 py-2 text-text-primary placeholder-text-secondary w-full sm:w-auto" value={filter} onChange={e => setFilter(e.target.value)} />
                <button onClick={() => setShowArchived(!showArchived)} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">{showArchived ? 'Ocultar' : 'Mostrar'} Archivados ({archivedData.length})</button>
                <button onClick={onExportComplementariedades} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Exportar Complementariedades</button>
              </div>
              <h3 className="text-xl font-semibold text-white">Casos Activos ({trackingData.length})</h3>
              <TrackingTable data={trackingData} isArchived={false} onUpdate={(index, row) => updateTrackingData(index, row, false)} onArchive={(indices) => archiveItems(indices, false)} filter={filter} />
              {showArchived && (
                <div className="mt-8">
                  <h3 className="text-xl font-semibold text-white">Casos Archivados ({archivedData.length})</h3>
                  <TrackingTable data={archivedData} isArchived={true} onUpdate={(index, row) => updateTrackingData(index, row, true)} onArchive={(indices) => archiveItems(indices, true)} filter={filter} />
                </div>
              )}
            </section>
          );
        };

        const TemplateManagerModal = ({ templates, onClose, onSave, onReset }) => {
          const [currentTemplates, setCurrentTemplates] = useState(templates);
          const [editingTemplate, setEditingTemplate] = useState(null);

          const handleSave = () => { onSave(currentTemplates); onClose(); };
          const handleAddNew = () => { setEditingTemplate({ id: `tpl_${Date.now()}`, name: '', body: '' }); };
          const handleEdit = (template) => { setEditingTemplate({ ...template }); };
          const handleDelete = (id) => { if (window.confirm('¬øEliminar esta plantilla?')) setCurrentTemplates(currentTemplates.filter(t => t.id !== id)); };
          const handleSaveTemplateEdit = () => {
            if (!editingTemplate || !editingTemplate.name || !editingTemplate.body) { alert('Nombre y cuerpo obligatorios.'); return; }
            const existing = currentTemplates.find(t => t.id === editingTemplate.id);
            if (existing) setCurrentTemplates(currentTemplates.map(t => t.id === editingTemplate.id ? editingTemplate : t));
            else setCurrentTemplates([...currentTemplates, editingTemplate]);
            setEditingTemplate(null);
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-40 p-4">
              <div className="bg-surface rounded-lg shadow-xl w-full max-w-4xl border border-border-color flex flex-col max-h-[90vh]">
                <div className="p-6 border-b border-border-color flex justify-between items-center"><h3 className="text-xl font-bold text-primary">Gestionar Plantillas</h3><button onClick={onClose} className="text-text-secondary text-2xl">&times;</button></div>
                <div className="p-6 overflow-y-auto space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <h4 className="text-lg font-semibold mb-2">Plantillas Actuales</h4>
                      <ul className="space-y-2 border border-border-color rounded-lg p-2 max-h-96 overflow-y-auto">
                        {currentTemplates.map(template => (
                          <li key={template.id} className="flex justify-between items-center p-2 bg-highlight rounded">
                            <span className="text-text-primary">{template.name}</span>
                            <div className="space-x-2"><button onClick={() => handleEdit(template)} className="text-sm bg-blue-600 px-2 py-1 rounded">Editar</button><button onClick={() => handleDelete(template.id)} className="text-sm bg-danger px-2 py-1 rounded">Borrar</button></div>
                          </li>
                        ))}
                      </ul>
                    </div>
                    <div>
                      <h4 className="text-lg font-semibold mb-2">{editingTemplate ? 'Editar Plantilla' : 'Crear Nueva Plantilla'}</h4>
                      {editingTemplate ? (
                        <div className="space-y-4 p-4 border border-border-color rounded-lg bg-highlight">
                            <input type="text" placeholder="Nombre" value={editingTemplate.name || ''} onChange={(e) => setEditingTemplate({ ...editingTemplate, name: e.target.value })} className="w-full bg-background border border-border-color rounded-md px-3 py-2" />
                          <textarea placeholder="Cuerpo..." value={editingTemplate.body || ''} onChange={(e) => setEditingTemplate({ ...editingTemplate, body: e.target.value })} className="w-full bg-background border border-border-color rounded-md px-3 py-2 h-40 resize-y" />
                          <div className="flex gap-2"><button onClick={handleSaveTemplateEdit} className="bg-green-600 px-3 py-1 rounded text-sm">Guardar</button><button onClick={() => setEditingTemplate(null)} className="bg-gray-600 px-3 py-1 rounded text-sm">Cancelar</button></div>
                        </div>
                      ) : ( <button onClick={handleAddNew} className="w-full bg-btn-primary hover:bg-btn-primary-hover text-white font-bold py-2 px-4 rounded-lg">A√±adir Nueva Plantilla</button> )}
                    </div>
                  </div>
                </div>
                <div className="p-4 bg-header flex justify-between items-center rounded-b-lg"><button onClick={onReset} className="bg-danger text-white font-bold py-2 px-4 rounded-lg">Restaurar Predeterminadas</button><div className="flex gap-4"><button onClick={onClose} className="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button><button onClick={handleSave} className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar y Cerrar</button></div></div>
              </div>
            </div>
          );
        };

        const PreviewModal = ({ data, template, onClose }) => {
          const bodyContent = template ? replacePlaceholders(template.body, data) : '<b>Error:</b> Plantilla no seleccionada.';
          const fullBody = bodyContent + COMMON_EMAIL_BODY + SIGNATURE;
          const copyToClipboard = () => {
            const tempEl = document.createElement('div'); tempEl.innerHTML = fullBody;
            navigator.clipboard.writeText(tempEl.innerText || "").then(() => alert('¬°Contenido copiado!')).catch(err => alert('Fall√≥ al copiar.'));
          };
          return (
            <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-40 p-4">
              <div className="bg-surface rounded-lg shadow-xl w-full max-w-3xl border border-border-color flex flex-col">
                <div className="p-6 border-b border-border-color"><h3 className="text-xl font-bold text-primary">Vista Previa</h3></div>
                <div className="p-6 overflow-y-auto max-h-[60vh] bg-white text-black font-serif" dangerouslySetInnerHTML={{ __html: fullBody }} />
                <div className="p-4 bg-header flex justify-end gap-4 rounded-b-lg"><button onClick={copyToClipboard} className="bg-btn-primary text-white font-bold py-2 px-4 rounded-lg">Copiar Contenido</button><button onClick={onClose} className="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button></div>
              </div>
            </div>
          );
        };
        
        // =================================================================================
        // MAIN APP COMPONENT
        // =================================================================================
        const App = () => {
          const [state, setState] = useState({
            finalData: [], trackingData: [], archivedData: [],
            portalData: Array(5).fill({}), pdfData: Array(5).fill({}),
            templates: [], isLoading: true, isSaving: false,
            isTemplateManagerOpen: false, previewData: null, notification: null, editsCount: 0,
          });

          const [sortConfig, setSortConfig] = useState({ key: 'No_Orden', direction: 'ascending' });

          const hideNotification = () => setState((prev) => ({ ...prev, notification: null }));
          const showNotification = (message, type, duration = 3000) => {
            setState((prev) => ({ ...prev, notification: { message, type } }));
            setTimeout(hideNotification, duration);
          };

          // --- CARGA INICIAL DESDE LOCALSTORAGE ---
          useEffect(() => {
            const loadedTemplates = loadTemplates();
            const localData = loadLocalData();
            
            setState((prev) => ({ 
                ...prev, 
                templates: loadedTemplates,
                finalData: localData.finalData,
                trackingData: localData.trackingData,
                archivedData: localData.archivedData,
                isLoading: false 
            }));
          }, []);

          const incrementEdits = () => setState((prev) => ({ ...prev, editsCount: prev.editsCount + 1 }));

          // --- GUARDADO EN LOCALSTORAGE ---
          const handleSave = () => {
            setState((prev) => ({ ...prev, isSaving: true }));
            try {
              saveLocalData({
                finalData: state.finalData,
                trackingData: state.trackingData,
                archivedData: state.archivedData,
              });
              showNotification('¬°Datos guardados localmente con √©xito!', 'success');
              setState((prev) => ({ ...prev, editsCount: 0 }));
            } catch (error) {
              console.error(error);
              showNotification('Fall√≥ el guardado local.', 'error');
            } finally {
              setState((prev) => ({ ...prev, isSaving: false }));
            }
          };

          const processPortalData = useCallback(() => {
            const processedData = state.portalData
              .filter((row) => {
                const numOrden = String(row['N√öMERO ORDEN'] || '').trim();
                return numOrden !== '' && numOrden.toUpperCase() !== 'N√öMERO ORDEN';
              })
              .map((row) => ({
                  Fecha_Neg: row['FECHA NEGACI√ìN'] || '',
                  No_Orden: row['N√öMERO ORDEN'] || '',
                  No_Cedula: row['IDENTIFICACI√ìN AFILIADO'] || '',
                  Nombre: capitalizeWords(row['NOMBRE AFILIADO'] || ''),
                  Tipo_Identificacion: row['TIPO DOCUMENTO'] || '',
                  Motivo_Negacion: row['MOTIVO NEGACI√ìN'] || '',
                  Programa: row.PROGRAMA || '',
                  Plan: row.PLAN || '',
                  EPS: (row.EPS || '').toUpperCase(),
                  Email: row.EMAIL || '',
                  Celular: row.CELULAR || '',
                  Edad: row.EDAD || '',
                  Regional: row.REGIONAL || '',
                  Fecha_Asignacion: row.Fecha_Asignacion || '',
                  EJECUTIVO: row.EJECUTIVO || '',
                  PROCEDIMIE: row.PROCEDIMIENTO || '',
                  Fecha_Ingres: row.Fecha_Ingreso || '',
                  ESTADO_PORTAL: row.ESTADO || '',
                  Descripcion_PDF: '(pendiente)',
                  Justificacion_PDF: '(pendiente)',
                  Fundamento_Legal_PDF: '(pendiente)',
                  Tipo_Carta: '',
                  Radicado_Comp: '',
              }));

            setState((prev) => ({ ...prev, finalData: processedData }));
            showNotification(`${processedData.length} filas procesadas.`, 'success');
          }, [state.portalData]);

          const mergePdfData = useCallback(() => {
            const pdfMap = new Map();
            state.pdfData.filter((row) => row['Archivo (No. Orden)']?.trim()).forEach((row) => {
                pdfMap.set(row['Archivo (No. Orden)'].trim(), {
                  Descripcion_PDF: row.Descripci√≥n || '',
                  Justificacion_PDF: row.Justificaci√≥n || '',
                  Fundamento_Legal_PDF: row['Fundamento Legal'] || '',
                });
            });
            const mergedData = state.finalData.map((finalRow) => {
              const pdfMatch = pdfMap.get(finalRow.No_Orden.trim());
              return pdfMatch ? { ...finalRow, ...pdfMatch } : finalRow;
            });
            setState((prev) => ({ ...prev, finalData: mergedData }));
            showNotification(`Datos PDF combinados.`, 'success');
          }, [state.pdfData, state.finalData]);

          const updateFinalDataRow = (noOrden, partialUpdate) => {
            setState(prev => ({ ...prev, finalData: prev.finalData.map(row => row.No_Orden === noOrden ? { ...row, ...partialUpdate } : row) }));
          };
          
          const handleClearReviewData = () => {
            if (window.confirm("¬øLimpiar tabla de revisi√≥n?")) {
                setState(prev => ({ ...prev, finalData: [] }));
                showNotification("Tabla limpiada.", "info");
            }
          };

          const handleSendToTracking = (selectedOrderNumbers) => {
            const itemsToSend = state.finalData.filter(row => selectedOrderNumbers.includes(row.No_Orden))
              .filter((row) => {
                const template = state.templates.find((t) => t.id === row.Tipo_Carta);
                const isComplementariedad = template && template.name.toUpperCase().includes('COMPLEMENTARIEDAD');
                return isComplementariedad && row.Radicado_Comp && row.Radicado_Comp.trim() !== '';
              });

            if (itemsToSend.length === 0) { showNotification("Selecciona √≠tems Complementarios con Radicado.", 'warning'); return; }

            let newTrackingData = [...state.trackingData];
            let addedCount = 0;

            itemsToSend.forEach((item) => {
              const existingIndex = newTrackingData.findIndex((t) => t.No_Orden === item.No_Orden);
              if (existingIndex === -1) {
                  newTrackingData.push({
                      Fecha_Ing: item.Fecha_Neg, No_Orden: item.No_Orden, No_Cedula: item.No_Cedula,
                      Nombre: item.Nombre, EPS: item.EPS, Radicado: item.Radicado_Comp, Estado: 'Pendiente', Notas: '', 
                  });
                  addedCount++;
              }
            });
            
            const itemsSentOrderNumbers = itemsToSend.map(i => i.No_Orden);
            setState((prev) => ({
              ...prev,
              trackingData: newTrackingData,
              finalData: prev.finalData.filter(f => !itemsSentOrderNumbers.includes(f.No_Orden)),
              editsCount: prev.editsCount + addedCount
            }));
            showNotification(`${addedCount} enviados a seguimiento.`, 'success');
          };

          const exportForMailMerge = (data) => {
               if (!data || data.length === 0) { showNotification("Sin datos para exportar.", "warning"); return; }
               const dataToExport = data.map(row => ({
                   "Fecha": row.Fecha_Neg, "Orden": row.No_Orden, "Cedula": row.No_Cedula, "Nombre": row.Nombre,
                   "EPS": row.EPS, "Programa": row.Programa, "Email": row.Email, "Motivo": row.Motivo_Negacion,
                   "Desc": row.Descripcion_PDF, "Just": row.Justificacion_PDF, "Fund": row.Fundamento_Legal_PDF,
                   "Carta": state.templates.find(t => t.id === row.Tipo_Carta)?.name || "NO_SELECCIONADA", "Radicado": row.Radicado_Comp
               }));
               const wb = XLSX.utils.book_new();
               XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataToExport), "DatosParaEnvio");
               XLSX.writeFile(wb, "Sigweb_Procesado.xlsx");
           };

          const exportComplementaridadReport = () => {
            const dataToExport = [...state.trackingData, ...state.archivedData];
            if (dataToExport.length === 0) { showNotification("Sin datos para reporte.", "warning"); return; }
            const formatted = dataToExport.map(r => ({ "Fecha": r.Fecha_Ing, "Orden": r.No_Orden, "Cedula": r.No_Cedula, "Nombre": r.Nombre, "EPS": r.EPS, "Radicado": r.Radicado, "Estado": r.Estado }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(formatted), "Complementariedades");
            XLSX.writeFile(wb, `Sigweb_Reporte_Comp_${new Date().toISOString().slice(0, 10)}.xlsx`);
          };

          const updateTrackingData = (idx, row, isArch) => {
            const key = isArch ? 'archivedData' : 'trackingData';
            const list = [...state[key]]; list[idx] = row;
            setState((prev) => ({ ...prev, [key]: list, editsCount: prev.editsCount + 1 }));
          };

          const archiveItems = (indices, fromArchived) => {
            const sourceKey = fromArchived ? 'archivedData' : 'trackingData';
            const destKey = fromArchived ? 'trackingData' : 'archivedData';
            const itemsToMove = indices.map(i => state[sourceKey][i]).filter(Boolean);
            
            setState(prev => ({
                ...prev,
                [sourceKey]: prev[sourceKey].filter((_, i) => !indices.includes(i)),
                [destKey]: [...prev[destKey], ...itemsToMove],
                editsCount: prev.editsCount + itemsToMove.length
            }));
          };

          const handleSaveTemplates = (newTemplates) => {
            setState((prev) => ({ ...prev, templates: newTemplates }));
            saveTemplates(newTemplates);
            showNotification('Plantillas guardadas.', 'success');
          };

          const sortedFinalData = React.useMemo(() => {
            let items = [...state.finalData];
            if (sortConfig.key) {
                items.sort((a, b) => {
                    const valA = a[sortConfig.key] || ''; const valB = b[sortConfig.key] || '';
                    return (valA < valB ? -1 : 1) * (sortConfig.direction === 'ascending' ? 1 : -1);
                });
            }
            return items;
          }, [state.finalData, sortConfig]);

          if (state.isLoading) return <div className="fixed inset-0 bg-background flex items-center justify-center"><Spinner /> <span className="ml-4 text-white">Cargando Sistema Local...</span></div>;

          return (
            <div className="p-4 sm:p-8 bg-background min-h-screen">
              {state.notification && <Notification message={state.notification.message} type={state.notification.type} onClose={hideNotification} />}
              <main className="mx-auto bg-surface p-4 sm:p-6 rounded-xl border border-border-color space-y-8">
                <Header onSave={handleSave} onManageTemplates={() => setState(prev => ({ ...prev, isTemplateManagerOpen: true }))} />
                <Dashboard reviewCount={state.finalData.length} trackingCount={state.trackingData.length} archivedCount={state.archivedData.length} editsCount={state.editsCount} />
                
                <div className="text-right">
                   <button onClick={() => exportDetailedReport(state.finalData, state.trackingData, state.archivedData)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Descargar Reporte Detallado</button>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <DataInputArea id="portal-area" title="√Årea 1: Datos del Portal" headers={PORTAL_HEADERS} data={state.portalData} onDataChange={(d) => setState(prev => ({ ...prev, portalData: d }))} onProcess={processPortalData} />
                  <DataInputArea id="pdf-area" title="√Årea 2: Datos del Extractor PDF" headers={PDF_HEADERS} data={state.pdfData} onDataChange={(d) => setState(prev => ({ ...prev, pdfData: d }))} onProcess={mergePdfData} processButtonText="Combinar con Datos del PDF" />
                </div>

                <ReviewArea data={sortedFinalData} templates={state.templates} updateRow={updateFinalDataRow} incrementEdits={incrementEdits} onSendToTracking={handleSendToTracking} onPreview={(row) => setState(prev => ({ ...prev, previewData: row }))} onExportForMailMerge={exportForMailMerge} onClearReviewData={handleClearReviewData} sortConfig={sortConfig} setSortConfig={setSortConfig} />
                <TrackingArea trackingData={state.trackingData} archivedData={state.archivedData} updateTrackingData={updateTrackingData} archiveItems={archiveItems} onExportComplementariedades={exportComplementaridadReport} />
                
                {state.isSaving && <div className="fixed inset-0 bg-background/80 flex items-center justify-center z-50"><Spinner /> <span className="ml-4 text-xl text-white">Guardando...</span></div>}
              </main>

              {state.isTemplateManagerOpen && <TemplateManagerModal templates={state.templates} onClose={() => setState(prev => ({...prev, isTemplateManagerOpen: false}))} onSave={handleSaveTemplates} onReset={() => { if(confirm('¬øRestaurar?')) handleSaveTemplates(defaultTemplates); }} />}
              {state.previewData && <PreviewModal data={state.previewData} template={state.templates.find(t => t.id === state.previewData?.Tipo_Carta)} onClose={() => setState(prev => ({...prev, previewData: null}))} />}
            </div>
          );
        };

        const rootElement = document.getElementById('root');
        const root = createRoot(rootElement);
        root.render(<App />);

    </script>
</body>
</html>
